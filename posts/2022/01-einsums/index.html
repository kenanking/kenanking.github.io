<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>机器学习中的爱因斯坦求和（Einsums） | Yan Tang</title><meta name=keywords content="机器学习,爱因斯坦求和,Einsum"><meta name=description content="机器学习中的爱因斯坦求和（Einsums）"><meta name=author content="Yan Tang"><link rel=canonical href=https://ehehe.cn/posts/2022/01-einsums/><link crossorigin=anonymous href=/assets/css/stylesheet.c9955fba7e0a0fb84b7bcd8f0e496bfbb1c69a88719a87a588a4a271f28c1df4.css integrity="sha256-yZVfun4KD7hLe82PDklr+7HGmohxmoeliKSicfKMHfQ=" rel="preload stylesheet" as=style><link rel=icon href=https://ehehe.cn/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=16x16 href=https://ehehe.cn/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=32x32 href=https://ehehe.cn/assets/images/favicon-32x32.ico><link rel=apple-touch-icon href=https://ehehe.cn/assets/images/apple-touch-icon.png><link rel=mask-icon href=https://ehehe.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ehehe.cn/posts/2022/01-einsums/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css integrity=sha384-WcoG4HRXMzYzfCgiyfrySxx90XSl2rxY5mnVY5TwtWE6KLrArNKn0T/mOgNL0Mmi crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.js integrity=sha384-J+9dG2KMoiR9hqcFao0IBLwxt6zpcyN68IgwzsCSkbreXUjmNVRhPFTssqdSGjwQ crossorigin=anonymous></script><meta property="og:url" content="https://ehehe.cn/posts/2022/01-einsums/"><meta property="og:site_name" content="Yan Tang"><meta property="og:title" content="机器学习中的爱因斯坦求和（Einsums）"><meta property="og:description" content="机器学习中的爱因斯坦求和（Einsums）"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-20T12:32:44+00:00"><meta property="article:modified_time" content="2022-03-20T12:32:44+00:00"><meta property="article:tag" content="机器学习"><meta property="article:tag" content="爱因斯坦求和"><meta property="article:tag" content="Einsum"><meta name=twitter:card content="summary"><meta name=twitter:title content="机器学习中的爱因斯坦求和（Einsums）"><meta name=twitter:description content="机器学习中的爱因斯坦求和（Einsums）"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ehehe.cn/posts/"},{"@type":"ListItem","position":2,"name":"机器学习中的爱因斯坦求和（Einsums）","item":"https://ehehe.cn/posts/2022/01-einsums/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"机器学习中的爱因斯坦求和（Einsums）","name":"机器学习中的爱因斯坦求和（Einsums）","description":"机器学习中的爱因斯坦求和（Einsums）","keywords":["机器学习","爱因斯坦求和","Einsum"],"articleBody":"原文链接：Einsums in the wild\n引言 机器学习和统计学中存在大量的线性组合，许多统计学和机器学习中的算法和模型都可以写成矩阵与向量之间的运算。Einsums 是一种表示向量、矩阵和高维数组之间的线性运算的方法。\n这篇文章中列出了使用 Einsums 的示例。我们假设读者熟悉 爱因斯坦求和（Einstein summation） 的基础知识。但是，我们将在下一节中简单介绍 einsum。\n在下一节中，我们将简要介绍 einsum 表达式及其在 numpy / jax.numpy 中的用法。\nEinsums 简介 令 a∈RM\\mathbf{a} \\in \\mathbb{R}^{M}a∈RM 表示为一个一维向量，ama_{m}am​ 表示向量 a\\mathbf{a}a 中的第 mmm 个元素。假设我们想要表示 a\\mathbf{a}a 中所有元素的和，可以写成如下形式：\n∑m=1Mam \\sum_{m=1}^{M} a_{m} m=1∑M​am​为了引入 einsum 标记，我们注意到这个等式中的和符号（Σ\\SigmaΣ）只是表明我们应该考虑 a\\mathbf{a}a 中的所有元素并将它们相加。如果我们假设：1）向量 a\\mathbf{a}a 中的维数没有歧义；2）我们对它的所有元素求和，我们可以将一维向量 a\\mathbf{a}a 中所有元素之和的 einsum 标记定义为：\n∑m=1Nam≡einsumam \\sum_{m=1}^N a_m\\stackrel{\\text{einsum}}{\\equiv} \\mathbf{a}_m m=1∑N​am​≡einsumam​为了保持我们的符号一致，我们将带括号的索引表示为静态维度（static dimensions），静态维度允许我们扩展 einsum 的表达能力。也就是说，我们将 a\\mathbf{a}a 中的所有元素在 einsum 标记下表示为 a(m)\\mathbf{a}_{(m)}a(m)​。\n由于数组的名称对于定义这些表达式不一定有意义，因此我们在 numpy 中通过仅关注索引来定义 einsum 表达式。为了表示哪些维度是静态的，哪些应该相加，我们引入了 -\u003e 符号。-\u003e 左侧的元素定义数组的索引集，-\u003e 右侧的元素表示我们不求和的索引。\n例如，对向量 a\\mathbf{a}a 中的所有元素求和可以写成：\nam≡m-\u003e \\mathbf{a}_m \\equiv \\texttt{m-\u003e} am​≡m-\u003e另外，选择向量 a\\mathbf{a}a 中的所有元素可以写成：\na(m)≡m-\u003em \\mathbf{a}_{(m)} \\equiv \\texttt{m-\u003em} a(m)​≡m-\u003em在下面的代码片段中，我们展示了这个符号的作用：\n1 2 3 4 5 \u003e\u003e\u003e a = np.array([1, 2, 3, 4]) \u003e\u003e\u003e np.einsum(\"m-\u003e\", a) 10 \u003e\u003e\u003e np.einsum(\"m-\u003em\", a) array([1, 2, 3, 4]) 高维数组 令 a∈RM\\mathbf{a} \\in \\mathbb{R}^{M}a∈RM 和 b∈RM\\mathbf{b} \\in \\mathbb{R}^{M}b∈RM 表示两个一维向量，则 a\\mathbf{a}a 和 b\\mathbf{b}b 之间的点乘可以写为：\naTb=a1b1+…+aMbM=∑m=1Mambm \\begin{aligned} \\mathbf{a}^{\\mathrm{T}} \\mathbf{b} \u0026= a_1 b_1 + \\ldots + a_M b_M \\\\ \u0026= \\sum_{m=1}^M a_m b_m \\end{aligned} aTb​=a1​b1​+…+aM​bM​=m=1∑M​am​bm​​按照我们之前的标记，我们看到这个 einsum 表达式在数学和 numpy 形式中的表示是：\nambm≡m,m-\u003e \\mathbf{a}_m \\mathbf{b}_m \\equiv \\texttt{m,m-\u003e} am​bm​≡m,m-\u003e此外，a\\mathbf{a}a 和 b\\mathbf{b}b 之间的逐元素乘积的 einsum 标记由下式给出：\na(m)b(m)≡m,m-\u003em \\mathbf{a}_{(m)} \\mathbf{b}_{(m)} \\equiv \\texttt{m,m-\u003em} a(m)​b(m)​≡m,m-\u003em例如，考虑以下一维数组 a 和 b：\n1 2 3 4 5 6 7 8 9 10 11 12 \u003e\u003e\u003e a = np.array([1, 3, 1]) \u003e\u003e\u003e b = np.array([-1, 2, -2]) \u003e\u003e\u003e # dot product \u003e\u003e\u003e a @ b 3 \u003e\u003e\u003e np.einsum(\"m,m-\u003e\", a, b) 3 \u003e\u003e\u003e # Element-wise product \u003e\u003e\u003e a * b array([-1, 6, -2]) \u003e\u003e\u003e np.einsum(\"m,m-\u003em\", a, b) array([-1, 6, -2]) 我们可以进一步对上面的想法进行推广。考虑矩阵 A∈RN×M\\mathbf{A} \\in \\mathbb{R}^{N\\times M}A∈RN×M 和向量 x∈RM\\mathbf{x} \\in \\mathbb{R}^Mx∈RM 之间的乘积。通过线性代数，我们可以写成：\nAx=[a1T⋮aNT]x=[a1Tx⋮aNTx] \\mathbf{A} \\mathbf{x} = \\begin{bmatrix} \\mathbf{a}_1^{\\mathrm{T}} \\\\ \\vdots \\\\ \\mathbf{a}_N^{\\mathrm{T}} \\end{bmatrix} \\mathbf{x} = \\begin{bmatrix} \\mathbf{a}_1^{\\mathrm{T}} \\mathbf{x} \\\\ \\vdots \\\\ \\mathbf{a}_N^{\\mathrm{T}} \\mathbf{x} \\end{bmatrix} Ax=​a1T​⋮aNT​​​x=​a1T​x⋮aNT​x​​其中，anT\\mathbf{a}_n^{\\mathrm{T}}anT​ 表示矩阵 A\\mathbf{A}A 中的第 nnn 行元素。\n根据上面的式子，我们注意到 Ax∈RN\\mathbf{A} \\mathbf{x} \\in \\mathbb{R}^{N}Ax∈RN 可以表示为：\n(Ax)n=∑m=1Man,mxm (\\mathbf{A} \\mathbf{x})_{n} = \\sum_{m=1}^M a_{n, m} x_m (Ax)n​=m=1∑M​an,m​xm​我们还可以观察到这个表达式中，A\\mathbf{A}A 的第一个维度是静态的。于是，einsum 标记可以写为：\nA(n),mxm≡nm,m-\u003en \\mathbf{A}_{(n),m}\\mathbf{x}_m \\equiv \\texttt{nm,m-\u003en} A(n),m​xm​≡nm,m-\u003en通过最后一个例子的结果，我们可以很容易地表达出两个矩阵相乘后的第 (i,j)(i, j)(i,j) 项。\n令 A∈RN×M\\mathbf{A} \\in \\mathbb{R}^{N \\times M}A∈RN×M，B∈RM×K\\mathbf{B} \\in \\mathbb{R}^{M \\times K}B∈RM×K，则 A\\mathbf{A}A 和 B\\mathbf{B}B 的乘积为：\nAB=[a1T⋮aNT][b1,…,bM]=[a1Tb1a1Tb2…a1TbMa2Tb1a2Tb2…a2TbM⋮⋮⋱⋮aNTb1aNTb2…aNTbM] \\begin{aligned} \\mathbf{A}\\mathbf{B} \u0026= \\begin{bmatrix} \\mathbf{a}_1^{\\mathrm{T}} \\\\ \\vdots \\\\ \\mathbf{a}_N^{\\mathrm{T}} \\end{bmatrix} \\begin{bmatrix} \\mathbf{b}_1, \\ldots, \\mathbf{b}_M \\\\ \\end{bmatrix} \\\\ \u0026= \\begin{bmatrix} \\mathbf{a}_1^{\\mathrm{T}} \\mathbf{b}_1 \u0026 \\mathbf{a}_1^{\\mathrm{T}} \\mathbf{b}_2 \u0026 \\ldots \u0026 \\mathbf{a}_1^{\\mathrm{T}} \\mathbf{b}_M \\\\ \\mathbf{a}_2^{\\mathrm{T}} \\mathbf{b}_1 \u0026 \\mathbf{a}_2^{\\mathrm{T}} \\mathbf{b}_2 \u0026 \\ldots \u0026 \\mathbf{a}_2^{\\mathrm{T}} \\mathbf{b}_M\\\\ \\vdots \u0026 \\vdots \u0026 \\ddots \u0026 \\vdots \\\\ \\mathbf{a}_N^{\\mathrm{T}} \\mathbf{b}_1 \u0026 \\mathbf{a}_N^{\\mathrm{T}} \\mathbf{b}_2 \u0026 \\ldots \u0026 \\mathbf{a}_N^{\\mathrm{T}} \\mathbf{b}_M \\end{bmatrix} \\end{aligned} AB​=​a1T​⋮aNT​​​[b1​,…,bM​​]=​a1T​b1​a2T​b1​⋮aNT​b1​​a1T​b2​a2T​b2​⋮aNT​b2​​……⋱…​a1T​bM​a2T​bM​⋮aNT​bM​​​​于是，矩阵乘积 AB\\mathbf{A}\\mathbf{B}AB 中的第 (i,j)(i, j)(i,j) 项为：\nAB=aiTbj=∑m=1Mai,mbm,j \\begin{aligned} \\mathbf{A}\\mathbf{B} \u0026= \\mathbf{a}_i^{\\mathbf{T}} \\mathbf{b}_j \\\\ \u0026= \\sum_{m=1}^M a_{i,m} b_{m, j} \\end{aligned} AB​=aiT​bj​=m=1∑M​ai,m​bm,j​​从上面的等式中，我们看到 A\\mathbf{A}A 的第一个维度和 B\\mathbf{B}B 的第二个维度是静态的。其 einsum 标记为：\nA(i),mBm,(j)≡im,mj-\u003eij \\mathbf{A}_{(i),m} \\mathbf{B}_{m, (j)}\\equiv \\texttt{im,mj-\u003eij} A(i),m​Bm,(j)​≡im,mj-\u003eij 1 2 3 4 5 6 7 8 \u003e\u003e\u003e A = np.array([[1, 2], [-2, 1]]) \u003e\u003e\u003e B = np.array([[0, 1], [1, 0]]) \u003e\u003e\u003e A @ B array([[ 2, 1], [ 1, -2]]) \u003e\u003e\u003e np.einsum(\"im,mj-\u003eij\", A, B) array([[ 2, 1], [ 1, -2]]) 更高维的数组 在机器学习中使用 einsum 的优势在于它们在处理高维数组时的具有强大的表达能力。正如我们将看到的，知道矩阵向量乘法运算的 einsum 表示很容易让我们将其推广到多个维度。这是因为当输出中存在静态维度时，可以将枚举视为线性变换的表达式。\n为了促进使用 einsums 标记在机器学习中表示线性组合，我们考虑以下示例。\n机器学习中的 Einsums 令 x∈RM\\mathbf{x} \\in \\mathbb{R}^Mx∈RM 和 A∈RM×M\\mathbf{A} \\in \\mathbb{R}^{M \\times M}A∈RM×M 分别表示一个一维数组和一个二维数组，则以零为中心，精度矩阵 A\\mathbf{A}A 的平方马氏距离定义为：\nDA(x)=xTAx D_{\\mathbf{A}}(\\mathbf{x}) = \\mathbf{x}^{\\mathrm{T}} \\mathbf{A} \\mathbf{x} DA​(x)=xTAx根据矩阵乘法法则，对于任意给定的 x\\mathbf{x}x 和一个有效的精度矩阵 A\\mathbf{A}A 我们都可以计算 DA(x)D_{\\mathbf{A}}(\\mathbf{x})DA​(x)。我们可以得到 DA(x)D_{\\mathbf{A}}(\\mathbf{x})DA​(x) 的 einsum 标注为 i,ij,j-\u003e，这是因为：\nxTAx=∑i,jxiAi,jxj≡einsumxiAi,jxj \\begin{aligned} \\mathbf{x}^{\\mathbf{T}} \\mathbf{A} \\mathbf{x} \u0026= \\sum_{i,j} x_i A_{i,j} x_j \\\\ \u0026\\stackrel{\\text{einsum}}{\\equiv} \\mathbf{x}_i \\mathbf{A}_{i,j} \\mathbf{x}_j \\end{aligned} xTAx​=i,j∑​xi​Ai,j​xj​≡einsumxi​Ai,j​xj​​一个更有趣的场景是：考虑这样一种情况，我们有 NNN 个观测值存储在一个二维数组 X∈RN×M\\mathbf{X} \\in \\mathbb{R}^{N \\times M}X∈RN×M 中。如果我们记 xn∈RM\\mathbf{x}_{n} \\in \\mathbb{R}^Mxn​∈RM 为 X\\mathbf{X}X 中的第 nnn 个观测，我们需要计算每个观测值的平方马氏距离，以获得：\nxnTAxn∀n∈{1,…,N} \\mathbf{x}_n^{\\mathbf{T}} \\mathbf{A} \\mathbf{x}_n \\quad \\forall n \\in \\{1, \\ldots, N\\} xnT​Axn​∀n∈{1,…,N}获得上面结果的一种方法是通过矩阵计算得到：\nDiag(XTAX) \\text{Diag}(\\mathbf{X}^{\\mathbf{T}}{\\bf A}\\mathbf{X}) Diag(XTAX)其中：Diag(M)i=Mi,j\\text{Diag}(\\mathbf{M})_{i} = \\mathbf{M}_{i,j}Diag(M)i​=Mi,j​。\n根据矩阵乘法，我们可以证明上面的结果：\n(XAXT)=[x1T⋮xNT]A[x1…xN]=[x1TA⋮xNTA][x1…xN]=[x1TAx1x1TAx2…x1TAxNx2TAx1x2TAx2…x2TAxN⋮⋮⋱⋮xNTAx1xNTAx2…xNTAxN] \\begin{aligned} (\\mathbf{X} {\\bf A}\\mathbf{X}^{\\mathbf{T}}) \u0026= \\begin{bmatrix}\\mathbf{x}_1^{\\mathbf{T}} \\\\ \\vdots \\\\\\mathbf{x}_N^{\\mathbf{T}}\\end{bmatrix} {\\bf A} \\begin{bmatrix}{\\bf x_1} \u0026 \\ldots \u0026 \\mathbf{x}_N\\end{bmatrix}\\\\ \u0026= \\begin{bmatrix}\\mathbf{x}_1^{\\mathbf{T}} {\\bf A}\\\\ \\vdots \\\\\\mathbf{x}_N^{\\mathbf{T}} {\\bf A}\\end{bmatrix} \\begin{bmatrix}{\\bf x_1} \u0026 \\ldots \u0026 \\mathbf{x}_N\\end{bmatrix}\\\\ \u0026= \\begin{bmatrix} \\mathbf{x}_1^{\\mathbf{T}} {\\bf A} \\mathbf{x}_1 \u0026 \\mathbf{x}_1^{\\mathbf{T}} {\\bf A} \\mathbf{x}_2 \u0026 \\ldots \u0026 \\mathbf{x}_1^{\\mathbf{T}} {\\bf A} \\mathbf{x}_N \\\\ \\mathbf{x}_2^{\\mathbf{T}} {\\bf A} \\mathbf{x}_1 \u0026 \\mathbf{x}_2^{\\mathbf{T}} {\\bf A} \\mathbf{x}_2 \u0026 \\ldots \u0026 \\mathbf{x}_2^{\\mathbf{T}} {\\bf A} \\mathbf{x}_N \\\\ \\vdots \u0026 \\vdots \u0026 \\ddots \u0026 \\vdots \\\\ \\mathbf{x}_N^{\\mathbf{T}} {\\bf A} \\mathbf{x}_1 \u0026 \\mathbf{x}_N^{\\mathbf{T}} {\\bf A} \\mathbf{x}_2 \u0026 \\ldots \u0026 \\mathbf{x}_N^{\\mathbf{T}} {\\bf A} \\mathbf{x}_N \\end{bmatrix} \\end{aligned} (XAXT)​=​x1T​⋮xNT​​​A[x1​​…​xN​​]=​x1T​A⋮xNT​A​​[x1​​…​xN​​]=​x1T​Ax1​x2T​Ax1​⋮xNT​Ax1​​x1T​Ax2​x2T​Ax2​⋮xNT​Ax2​​……⋱…​x1T​AxN​x2T​AxN​⋮xNT​AxN​​​​但是，上述表达式的计算效率很低，因为我们需要计算 N2N^2N2 项来获得我们想要的大小为 NNN 的一维数组。更高效的方式是利用 einsum 标记来计算和表达上述的平方马氏距离问题。正如我们已经看到的，DA(x)D_{\\mathbf{A}}(\\mathbf{x})DA​(x) 的 einsum 标记形式为：\nxiAi,jxj \\mathbf{x}_{i}\\mathbf{A}_{i,j}\\mathbf{x}_j xi​Ai,j​xj​我们可以很简单地将上面的表达式扩展到 NNN 个元素，我们只需要注意 X\\mathbf{X}X 的第一个维度是静态的。我们可以得到：\nX(n),iAi,jX(n),j≡ni,ij,nj-\u003en \\mathbf{X}_{(n), i}\\mathbf{A}_{i,j}\\mathbf{X}_{(n),j} \\equiv \\texttt{ni,ij,nj-\u003en} X(n),i​Ai,j​X(n),j​≡ni,ij,nj-\u003en这个特定的例子中，使用 einsum 标注可以帮助我们避免计算不在对角线上的元素，与直接利用矩阵相乘方法相比，提高了我们的速度。\n1 2 3 4 5 6 7 In [1]: %%timeit -n 10 -r 10 ...: np.diag(X @ A @ X.T) 10 loops, best of 10: 5.8 s per loop In [2]: %%timeit -n 10 -r 10 ...: np.einsum(\"ni,ij,nj-\u003en\", X, A, X, optimize=\"optimal\") 10 loops, best of 10: 598 ms per loop 为了推广这一结果，我们考虑三维数组 X∈RN1×N2×M\\mathbf{X} \\in \\mathbb{R}^{N_{1} \\times N_{2} \\times M}X∈RN1​×N2​×M。使用线性代数的基本工具，我们已经没法用代数形式表示在 X\\mathbf{X}X 的最后一维上进行平方马氏距离的计算。从我们之前的结果中，我们看到为了扩展 X\\mathbf{X}X 的计算，我们只需要引入一个额外的静态维度：\nX(n),(m),iAi,jX(n),(m),j≡nmi,ij,nmj-\u003enm \\mathbf{X}_{(n), (m), i}\\mathbf{A}_{i,j}\\mathbf{X}_{(n),(m), j} \\equiv \\texttt{nmi,ij,nmj-\u003enm} X(n),(m),i​Ai,j​X(n),(m),j​≡nmi,ij,nmj-\u003enm最后这些表达式表明，当我们必须计算未使用索引的已知线性变换时，einsums 可以提供很大帮助。\n如果我们继续增加 X\\mathbf{X}X 的维度，我们会得到以下结果：\ni,ij,j-\u003e 得到标量输出， ni,ij,nj-\u003en 得到一维数组输出， nmi,ij,nmj-\u003enm 得到二维数组输出， nmli,ij,nmlj-\u003enml 得到三维数组是输出， …i,ij,…j-\u003e… 得到 ddd 维数组输出。 此外，einsums 表达式在索引块上是可交换的。这意味着 einsum 表达式的结果与数组的定位顺序无关。对于我们之前的示例，以下三个表达式是等价的：\nni,ij,nj-\u003en ni,nj,ij-\u003en ni,nj,ij-\u003en 高斯分布的对数密度函数 令 x∼N(μ,Σ)\\mathbf{x} \\sim \\mathcal{N}(\\boldsymbol{\\mu}, \\boldsymbol{\\Sigma})x∼N(μ,Σ)，则 x\\mathbf{x}x 的对数密度函数为：\nlog⁡p(x∣μ,Σ)=−12(x−μ)TΣ−1(x−μ)+const \\log p(\\mathbf{x} \\vert \\boldsymbol{\\mu}, \\boldsymbol{\\Sigma}) = -\\frac{1}{2}(\\mathbf{x} - \\boldsymbol{\\mu})^{\\mathrm{T}}\\boldsymbol{\\Sigma}^{-1}(\\mathbf{x} - \\boldsymbol{\\mu}) + \\text{const} logp(x∣μ,Σ)=−21​(x−μ)TΣ−1(x−μ)+const假设我们想要绘制二元高斯分布的对数密度函数在区域 X⊆R2\\mathcal{X} \\subseteq \\mathbb{R}^2X⊆R2 中的图像。正如我们之前看到的，表达式 xTAx\\mathbf{x}^{\\mathrm{T}} \\mathbf{A} \\mathbf{x}xTAx 的 einsum 标注为 i,ij,j-\u003e。通过引入静态维度 n 和 m，我们可以计算在 X\\mathcal{X}X 上的对数密度函数，只需要将 n 和 m 索引加入 einsum 表达式中，并且将它们指定为输出的大小。于是，我们可以得到：inm,ij,jnm-\u003enm。\n下面，我们展示了一个例子：\n1 2 3 4 5 6 7 8 9 10 11 12 mean_vec = jnp.array([1, 0]) cov_matrix = jnp.array([[4, -2], [-2, 4]]) prec_matrix = jnp.linalg.inv(cov_matrix) step = 0.1 xmin, xmax = -8, 8 ymin, ymax = -10, 10 X_grid = jnp.mgrid[xmin:xmax:step, ymin:ymax:step] + mean_vec[:, None, None] diff_grid = (X_grid - mean_vec[:, None, None]) log_prob_grid = -jnp.einsum(\"inm,ij,jnm-\u003enm\", diff_grid, prec_matrix, diff_grid) / 2 plt.contour(*X_grid, log_prob_grid, 30) 高斯分布对数密度\n我们将上面的想法扩展到 一组具有恒定均值和多个协方差矩阵的多元高斯 的情况。\n回想一下，计算区域 X⊆R2\\mathcal{X} \\subseteq \\mathbb{R}^2X⊆R2 上二元高斯分布的对数密度的 einsum 表达式由 inm,ij,jnm-\u003enm 给出。假设我们有一组 KKK 个高斯分布，对于每个 kkk，我们有一个精度矩阵 Sk\\mathbf{S}_{k}Sk​ 和一个同样的均值 μ∈RM\\boldsymbol{\\mu} \\in \\mathbb{R}^{M}μ∈RM。为了计算每个区域的密度函数，我们只需修改之前的表达式以考虑新的静态维度 kkk。我们得到：inm,kij,jnm-\u003eknm。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 C1 = jnp.array([ [4, -2], [-2, 4] ]) C2 = jnp.array([ [4, 0], [0, 4] ]) C3 = jnp.array([ [4, 2], [2, 4] ]) C4 = jnp.array([ [1, -2], [2, 4] ]) C = jnp.stack([C1, C2, C3, C4], axis=0) S = jnp.linalg.inv(C) # inversion over the fist dimension log_prob_grid_multiple = -jnp.einsum(\"inm,kij,jnm-\u003eknm\", diff_grid, S, diff_grid) / 2 fig, ax = plt.subplots(2, 2) ax = ax.ravel() for axi, log_prob_grid in zip(ax, log_prob_grid_multiple): axi.contour(*X_grid, log_prob_grid, 30) K 组均值相同精度不同的高斯分布\n回顾一下，计算的马氏距离的 einsum 表达式由下式给出：\ni,ij,ij-\u003e x\\mathbf{x}x 为一维数组（向量）； ni,ij,nj-\u003en 对于 NNN 组 x\\mathbf{x}x 构成的观测矩阵； nmi,ij,nmj-\u003enm 对于 N×MN \\times MN×M 组 x\\mathbf{x}x 构成的观测值网格； nmi,kij,nmj-\u003eknm 对于 N×MN \\times MN×M 组 x\\mathbf{x}x 构成的观测值网格，并且具有不同的精度矩阵。 贝叶斯逻辑回归模型的预测面 只要我们的运算中最里面的操作存在元素的线性组合，我们就可以使用 einsum 表达式。\n下一个示例，我们计算高斯先验下的贝叶斯逻辑回归的预测曲面。也就是说，我们要计算：\np(y^=1∣x)=∫R2σ(wTx)p(w∣D)dx=Ew∣D[σ(wTx)]≈1S∑s=1Sσ(w(s)Tx) \\begin{aligned} p(\\hat{y} = 1 \\vert \\mathbf{x}) \u0026= \\int_{\\mathbb{R}^2} \\sigma(\\mathbf{w}^{\\mathrm{T}} \\mathbf{x}) p(\\mathbf{w} \\vert \\mathcal{D}) d\\mathbf{x}\\\\ \u0026= \\mathbb{E}_{\\mathbf{w} \\vert \\mathcal{D}}\\left[\\sigma(\\mathbf{w}^{\\mathrm{T}} \\mathbf{x})\\right]\\\\ \u0026\\approx \\frac{1}{S} \\sum_{s=1}^S \\sigma\\left({\\bf w^{(s)}}^{\\mathrm{T}} \\mathbf{x}\\right) \\end{aligned} p(y^​=1∣x)​=∫R2​σ(wTx)p(w∣D)dx=Ew∣D​[σ(wTx)]≈S1​s=1∑S​σ(w(s)Tx)​假设我们已经估计了后验分布的参数 w^\\hat{\\mathbf{w}}w^，Σ^\\hat{\\boldsymbol{\\Sigma}}Σ^。因此预测分布的后验在计算上是难以处理的，我用使用后验预测分布表面的蒙特卡罗近似。和之前的例子相同，我们想要计算在区域上计算 p(y^=1∣x)p(\\hat{y} = 1 \\vert \\mathbf{x})p(y^​=1∣x)。\n在这种情况下，我们从后验分布 p(w∣D)p(\\mathbf{w} \\vert \\mathcal{D})p(w∣D) 中采样了 SSS 个权重。对于每个权重 sss，我们要计算网格点 X\\mathcal{X}X 处的值。\n回想一下，两个向量之间的点乘可以用 einsum 表示为 m,m-\u003e。为了得到由一组 SSS 在格网 X\\mathcal{X}X 上每个点计算的值（结果是一个三维数组），我们可以简单地在点乘中引入一个静态维度 s，表示每一个模拟的权重。令 i，j 表示网格上的位置，我们可以得到 einsum 表达式为：sm,mij-\u003esij。\n在计算了 sij 后，我们对结果使用 logistic 函数，并在 s 维度上对每个元素取平均，得到近似的预测分布。\n下面是代码片段：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # Estimated posterior mean and precision matrix w_hat = jnp.array([4.29669692, 1.6520908]) S_hat = jnp.array([[2.74809243, 0.76832627], [0.76832627, 0.88442754]]) C_hat = jnp.linalg.inv(S_hat) n_samples = 1_000 boundary, step = 8, 0.1 key = jax.random.PRNGKey(314) X_grid = jnp.mgrid[-boundary:boundary:step, -boundary:boundary:step] w_samples = jax.random.multivariate_normal(key, w_hat, S_hat, shape=(n_samples,)) logit_grid = jnp.einsum(\"sm,mij-\u003esij\", w_samples, X_grid) P_grid = jax.nn.sigmoid(logit_grid).mean(axis=0) plt.contour(*X_grid, P_grid, 30) plt.title(r\"$p(\\hat{y} = 1 \\vert \\mathbf{x})$\", fontsize=15) 贝叶斯逻辑回归模型的预测面\n图像压缩：奇异值分解（SVD） 在学习奇异值分解时，一个典型的应用是 使用奇异值分解来压缩图像。作为一个启发式示例，假设我们想要在多个阈值上比较图像的奇异值分解结果。\n我们将图像 P\\mathbf{P}P 分解为：\nP≡einsumckL(n),(m),k∈RN×M≡c,ijc-\u003eij \\mathbf{P} \\stackrel{\\text{einsum}}{\\equiv} \\mathbf{c}_{k}\\mathbf{L}_{(n),(m),k} \\in\\mathbb{R}^{N\\times M} \\equiv \\texttt{c,ijc-\u003eij} P≡einsumck​L(n),(m),k​∈RN×M≡c,ijc-\u003eij这是线性代数的经典结果，我们可以将矩阵 P\\mathbf{P}P 可以分解为：\nP=UΣVT \\mathbf{P} = \\mathbf{U} \\boldsymbol{\\Sigma} \\mathbf{V}^{\\mathrm{T}} P=UΣVT其中：U∈RM×M\\mathbf{U} \\in \\mathbb{R}^{M \\times M}U∈RM×M，V∈RN×N\\mathbf{V} \\in \\mathbb{R}^{N \\times N}V∈RN×N，以及 Σ∈RM×N\\boldsymbol{\\Sigma} \\in \\mathbb{R}^{M \\times N}Σ∈RM×N。Σ\\boldsymbol{\\Sigma}Σ 中的对角线元素为 {σ1,σ2,…,σmin⁡(n,m)}\\{\\sigma_1, \\sigma_2, \\ldots, \\sigma_{\\min(n,m)}\\}{σ1​,σ2​,…,σmin(n,m)​}，其他元素为 000。\n在 scipy 中，P\\mathbf{P}P 的 SVD 分解被方便地分解（以 einsum 形式）为：\nP≡einsumU^(n),kσ^kV^k,(m) \\mathbf{P} \\stackrel{\\text{einsum}}{\\equiv}\\hat{\\mathbf{U}}_{(n),k}\\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, (m)} P≡einsumU^(n),k​σ^k​V^k,(m)​其中：U^∈RM×R\\hat{\\mathbf{U}} \\in \\mathbb{R}^{M \\times R}U^∈RM×R，V^∈RN×R\\hat{\\mathbf{V}} \\in \\mathbb{R}^{N \\times R}V^∈RN×R，σ={σ1…,σR}\\boldsymbol{\\sigma} = \\{\\sigma_1 \\ldots, \\sigma_R\\}σ={σ1​…,σR​}，并且 R=min⁡(M,N)R = \\min(M,N)R=min(M,N)。\n作为一个示例，假设我们想要用前 KKK 个奇异值分量来近似矩阵 P\\mathbf{P}P。首先我们观察到矩阵 P\\mathbf{P}P 的第 (n,m)(n,m)(n,m) 个元素可由下式计算：\nPn,m=∑k=1RU^n,kσ^kV^k,m \\mathbf{P}_{n,m} = \\sum_{k=1}^R \\hat{\\mathbf{U}}_{n,k} \\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, m} Pn,m​=k=1∑R​U^n,k​σ^k​V^k,m​如果我们想考虑 Pn,m\\mathbf{P}_{n,m}Pn,m​ 的前 KKK 个分量，我们只需要修改求和中的项数即可得到：\n∑k=1KU^n,kσ^kV^k,m \\sum_{k=1}^K \\hat{\\mathbf{U}}_{n,k} \\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, m} k=1∑K​U^n,k​σ^k​V^k,m​但是，上面的表达式 不能用 einsum 标注表示。正如我在开头提到的，每个 einsum 表达式都假设在索引的每个元素上求和。\n为了绕过这个约束，我们简单的引入大小为 RRR 的一维向量 1⋅≤K\\mathbf{1}_{\\cdot \\leq K}1⋅≤K​，其中前 KKK 个元素的值为 111，剩下 R−KR-KR−K 个元素的值为 000。\n因此，使用前 KKK 个奇异值分量近似矩阵 P\\mathbf{P}P 的表达式可以写为：\n∑k=1RU^n,kσ^kV^k,m(1⋅≤K)k \\sum_{k=1}^R \\hat{\\mathbf{U}}_{n,k} \\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, m} (\\mathbf{1}_{\\cdot \\leq K})_{k} k=1∑R​U^n,k​σ^k​V^k,m​(1⋅≤K​)k​上式可以简单的用 einsum 表达式写为：\nU^(n),kσ^kV^k,m(1⋅≤K)k≡nk,k,km,k-\u003enm \\hat{\\mathbf{U}}_{(n),k} \\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, {m}} (\\mathbf{1}_{\\cdot \\leq K})_{k} \\equiv \\texttt{nk,k,km,k-\u003enm} U^(n),k​σ^k​V^k,m​(1⋅≤K​)k​≡nk,k,km,k-\u003enm我们同样可以考虑 KKK 取不同值的情况。我们定义二维数组：\nI=[1⋅≤K1⋅≤K2⋮1⋅≤KC] \\mathbf{I} = \\begin{bmatrix} \\mathbf{1}_{\\cdot \\leq K}\\\\ \\mathbf{1}_{\\cdot \\leq K_2}\\\\ \\vdots\\\\ \\mathbf{1}_{\\cdot \\leq K_C}\\\\ \\end{bmatrix} I=​1⋅≤K​1⋅≤K2​​⋮1⋅≤KC​​​​接下来，我们简单地修改我们之前的表达式，以考虑到矩阵 I\\mathbf{I}I 的附加静态维度。我们可以得到：\nU^(n),kσ^kV^k,(m)I(c),k≡nk,k,km,ck-\u003enmc≡nk,k,km,ck-\u003ecnm \\begin{aligned} \\hat{\\mathbf{U}}_{(n),k}\\hat{\\boldsymbol{\\sigma}}_{k} \\hat{\\mathbf{V}}_{k, (m)}{\\mathbf{I}}_{(c), k} \u0026\\equiv \\texttt{nk,k,km,ck-\u003enmc}\\\\ \u0026\\equiv \\texttt{nk,k,km,ck-\u003ecnm} \\end{aligned} U^(n),k​σ^k​V^k,(m)​I(c),k​​≡nk,k,km,ck-\u003enmc≡nk,k,km,ck-\u003ecnm​我们在下一个代码中提供了一个例子：首先，我们加载一张图像存到三维数组 img 中。接下来，我们对 img 进行变换，得到一个二维数组 img_gray。我们在 img_gray 上执行奇异值分解并定义了一个矩阵 indexer 包含不同的阈值。最后，我们利用我们之前定义的表达式来计算在 indexer 中定义的不同阈值的图像的 SVD 近似值。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 FILEPATH = \"https://i.imgur.com/p91lldL.png\" img = plt.imread(FILEPATH) c_weights = jnp.array([0.2989, 0.5870, 0.1140]) img_gray = jnp.einsum(\"c,ijc-\u003eij\", c_weights, img) U, s, Vh = jax.scipy.linalg.svd(img_gray, full_matrices=False) indexer = s[:, None] \u003e jnp.array([10, 100, 1_000, 5_000]) img_svd_collection = jnp.einsum(\"nk,k,km,ck-\u003ecnm\", U, s, Vh, indexer) fig, ax = plt.subplots(2, 2, figsize=(5, 6)) ax = ax.ravel() for axi, img_svd in zip(ax, img_svd_collection): axi.imshow(img_svd, cmap=\"bone\") axi.axis(\"off\") plt.tight_layout(w_pad=-1) SVD 近似图像\n","wordCount":"1417","inLanguage":"en","datePublished":"2022-03-20T12:32:44Z","dateModified":"2022-03-20T12:32:44Z","author":{"@type":"Person","name":"Yan Tang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ehehe.cn/posts/2022/01-einsums/"},"publisher":{"@type":"Organization","name":"Yan Tang","logo":{"@type":"ImageObject","url":"https://ehehe.cn/assets/images/favicon-16x16.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://ehehe.cn/ accesskey=h title="Yan Tang (Alt + H)">Yan Tang</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ehehe.cn/ title=Posts><span>Posts</span></a></li><li><a href=https://ehehe.cn/about/ title=About><span>About</span></a></li><li><a href=https://ehehe.cn/publications/ title=Publications><span>Publications</span></a></li><li><a href=https://ehehe.cn/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ehehe.cn/zotwatch/ title=ZotWatch><span>ZotWatch</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">机器学习中的爱因斯坦求和（Einsums）</h1><div class=post-description>机器学习中的爱因斯坦求和（Einsums）</div><div class=post-meta><span title='2022-03-20 12:32:44 +0000 UTC'>March 20, 2022</span>&nbsp;·&nbsp;<span>7 min</span>&nbsp;·&nbsp;<span>Yan Tang</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=引言>引言</a><ul><li><a href=#einsums-%e7%ae%80%e4%bb%8b aria-label="Einsums 简介">Einsums 简介</a></li><li><a href=#%e9%ab%98%e7%bb%b4%e6%95%b0%e7%bb%84 aria-label=高维数组>高维数组</a></li><li><a href=#%e6%9b%b4%e9%ab%98%e7%bb%b4%e7%9a%84%e6%95%b0%e7%bb%84 aria-label=更高维的数组>更高维的数组</a></li></ul></li><li><a href=#%e6%9c%ba%e5%99%a8%e5%ad%a6%e4%b9%a0%e4%b8%ad%e7%9a%84-einsums aria-label="机器学习中的 Einsums">机器学习中的 Einsums</a><ul><li><a href=#%e9%ab%98%e6%96%af%e5%88%86%e5%b8%83%e7%9a%84%e5%af%b9%e6%95%b0%e5%af%86%e5%ba%a6%e5%87%bd%e6%95%b0 aria-label=高斯分布的对数密度函数>高斯分布的对数密度函数</a></li><li><a href=#%e8%b4%9d%e5%8f%b6%e6%96%af%e9%80%bb%e8%be%91%e5%9b%9e%e5%bd%92%e6%a8%a1%e5%9e%8b%e7%9a%84%e9%a2%84%e6%b5%8b%e9%9d%a2 aria-label=贝叶斯逻辑回归模型的预测面>贝叶斯逻辑回归模型的预测面</a></li><li><a href=#%e5%9b%be%e5%83%8f%e5%8e%8b%e7%bc%a9%e5%a5%87%e5%bc%82%e5%80%bc%e5%88%86%e8%a7%a3svd aria-label=图像压缩：奇异值分解（SVD）>图像压缩：奇异值分解（SVD）</a></li></ul></li></ul></div></details></div><div class=post-content><p>原文链接：<a href=https://grrddm.notion.site/Einsums-in-the-wild-bd773f01ba4c463ca9e4c1b5a6d90f5f#ec984527ec994d8ab8dc3b3c20167200>Einsums in the wild</a></p><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>机器学习和统计学中存在大量的线性组合，许多统计学和机器学习中的算法和模型都可以写成矩阵与向量之间的运算。<strong>Einsums</strong> 是一种表示向量、矩阵和高维数组之间的线性运算的方法。</p><p>这篇文章中列出了使用 Einsums 的示例。我们假设读者熟悉 <strong>爱因斯坦求和（Einstein summation）</strong> 的基础知识。但是，我们将在下一节中简单介绍 einsum。</p><p>在下一节中，我们将简要介绍 einsum 表达式及其在 <code>numpy</code> / <code>jax.numpy</code> 中的用法。</p><h3 id=einsums-简介>Einsums 简介<a hidden class=anchor aria-hidden=true href=#einsums-简介>#</a></h3><p>令 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{a} \in \mathbb{R}^{M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class="mord mathbf">a</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 表示为一个一维向量，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">a_{m}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5806em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> 表示向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">m</span></span></span></span> 个元素。假设我们想要表示 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中所有元素的和，可以写成如下形式：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">
\sum_{m=1}^{M} a_{m}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.0954em;vertical-align:-1.2671em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span><p>为了引入 einsum 标记，我们注意到这个等式中的和符号（<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class=mord>Σ</span></span></span></span>）只是表明我们应该考虑 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的所有元素并将它们相加。如果我们假设：1）向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的维数没有歧义；2）我们对它的所有元素求和，我们可以将一维向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中所有元素之和的 einsum 标记定义为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>a</mi><mi>m</mi></msub><mo><mover><mo><mo>≡</mo></mo><mtext>einsum</mtext></mover></mo><msub><mi mathvariant="bold">a</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">
\sum_{m=1}^N a_m\stackrel{\text{einsum}}{\equiv} \mathbf{a}_m
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.0954em;vertical-align:-1.2671em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel><span class="mop op-limits"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.2313em><span style=top:-3em><span class=pstrut style=height:3em></span><span><span class=mop>≡</span></span></span><span style=top:-3.6638em;margin-left:0><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">einsum</span></span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.5944em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span><p>为了保持我们的符号一致，我们将带括号的索引表示为<strong>静态维度（static dimensions）</strong>，静态维度允许我们扩展 einsum 的表达能力。也就是说，我们将 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的所有元素在 einsum 标记下表示为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">a</mi><mrow><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{a}_{(m)}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7996em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span></span></span></span>。</p><p>由于数组的名称对于定义这些表达式不一定有意义，因此我们在 numpy 中通过仅关注索引来定义 einsum 表达式。为了表示<strong>哪些维度是静态的</strong>，<strong>哪些应该相加</strong>，我们引入了 <code>-></code> 符号。<code>-></code> 左侧的元素定义数组的索引集，<code>-></code> 右侧的元素表示我们不求和的索引。</p><p>例如，对向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的所有元素求和可以写成：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">a</mi><mi>m</mi></msub><mo>≡</mo><mtext mathvariant="monospace">m-&gt;</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{a}_m \equiv \texttt{m-&gt;}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6138em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.5556em></span><span class="mord text"><span class="mord texttt">m-></span></span></span></span></span></span><p>另外，选择向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 中的所有元素可以写成：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">a</mi><mrow><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><mo>≡</mo><mtext mathvariant="monospace">m-&gt;m</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{a}_{(m)} \equiv \texttt{m-&gt;m}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8189em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.5556em></span><span class="mord text"><span class="mord texttt">m->m</span></span></span></span></span></span><p>在下面的代码片段中，我们展示了这个符号的作用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;m-&gt;&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;m-&gt;m&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=高维数组>高维数组<a hidden class=anchor aria-hidden=true href=#高维数组>#</a></h3><p>令 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{a} \in \mathbb{R}^{M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class="mord mathbf">a</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{b} \in \mathbb{R}^{M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7335em;vertical-align:-.0391em></span><span class="mord mathbf">b</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 表示两个一维向量，则 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi></mrow><annotation encoding="application/x-tex">\mathbf{b}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathbf">b</span></span></span></span> 之间的点乘可以写为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi mathvariant="bold">a</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">b</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>a</mi><mn>1</mn></msub><msub><mi>b</mi><mn>1</mn></msub><mo>+</mo><mo>…</mo><mo>+</mo><msub><mi>a</mi><mi>M</mi></msub><msub><mi>b</mi><mi>M</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>a</mi><mi>m</mi></msub><msub><mi>b</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathbf{a}^{\mathrm{T}} \mathbf{b}
&amp;= a_1 b_1 + \ldots + a_M b_M \\
&amp;= \sum_{m=1}^M a_m b_m
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:4.9468em;vertical-align:-2.2234em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.7234em><span style=top:-5.6604em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">b</span></span></span><span style=top:-3.1721em><span class=pstrut style=height:3.8283em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.2234em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.7234em><span style=top:-5.6604em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=minner>…</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-3.1721em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.2234em><span></span></span></span></span></span></span></span></span></span></span></span><p>按照我们之前的标记，我们看到这个 einsum 表达式在数学和 numpy 形式中的表示是：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">a</mi><mi>m</mi></msub><msub><mi mathvariant="bold">b</mi><mi>m</mi></msub><mo>≡</mo><mtext mathvariant="monospace">m,m-&gt;</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{a}_m \mathbf{b}_m \equiv \texttt{m,m-&gt;}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8444em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6945em;vertical-align:-.1389em></span><span class="mord text"><span class="mord texttt">m,m-></span></span></span></span></span></span><p>此外，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">a</span></span></span></span> 和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi></mrow><annotation encoding="application/x-tex">\mathbf{b}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathbf">b</span></span></span></span> 之间的逐元素乘积的 einsum 标记由下式给出：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">a</mi><mrow><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><msub><mi mathvariant="bold">b</mi><mrow><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><mo>≡</mo><mtext mathvariant="monospace">m,m-&gt;m</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{a}_{(m)} \mathbf{b}_{(m)} \equiv \texttt{m,m-&gt;m}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0496em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6945em;vertical-align:-.1389em></span><span class="mord text"><span class="mord texttt">m,m->m</span></span></span></span></span></span><p>例如，考虑以下一维数组 <code>a</code> 和 <code>b</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=c1># dot product</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>@</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;m,m-&gt;&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=c1># Element-wise product</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>6</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;m,m-&gt;m&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span>  <span class=mi>6</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以进一步对上面的想法进行推广。考虑矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{A} \in \mathbb{R}^{N\times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">A</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 和向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{x} \in \mathbb{R}^M</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span> 之间的乘积。通过线性代数，我们可以写成：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi mathvariant="bold">x</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup><mi mathvariant="bold">x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup><mi mathvariant="bold">x</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathbf{A} \mathbf{x} = \begin{bmatrix} \mathbf{a}_1^{\mathrm{T}} \\ \vdots \\ \mathbf{a}_N^{\mathrm{T}}  \end{bmatrix} \mathbf{x} = \begin{bmatrix} \mathbf{a}_1^{\mathrm{T}} \mathbf{x} \\ \vdots \\ \mathbf{a}_N^{\mathrm{T}} \mathbf{x} \end{bmatrix}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">Ax</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.2627em;vertical-align:-1.8813em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M403 1759V84H666V0H319V1759v6e2 1759h347v-84H403zm0 0V0H319V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.3813em><span style=top:-5.2275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span></span></span><span style=top:-3.3675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-2.1662em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.8813em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M347 1759V0H0V84H263V1759v6e2 1759H0v84H347zm0 0V0H263V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.2627em;vertical-align:-1.8813em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M403 1759V84H666V0H319V1759v6e2 1759h347v-84H403zm0 0V0H319V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.3813em><span style=top:-5.2275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class="mord mathbf">x</span></span></span><span style=top:-3.3675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-2.1662em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class="mord mathbf">x</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.8813em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M347 1759V0H0V84H263V1759v6e2 1759H0v84H347zm0 0V0H263V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">a</mi><mi>n</mi><mi mathvariant="normal">T</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{a}_n^{\mathrm{T}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0883em;vertical-align:-.247em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.247em><span></span></span></span></span></span></span></span></span></span> 表示矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 中的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">n</span></span></span></span> 行元素。</p><p>根据上面的式子，我们注意到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{A} \mathbf{x} \in \mathbb{R}^{N}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">Ax</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span></span></span></span></span></span></span></span></span> 可以表示为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi><msub><mo stretchy="false">)</mo><mi>n</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>a</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><msub><mi>x</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">
(\mathbf{A} \mathbf{x})_{n} = \sum_{m=1}^M a_{n, m} x_m
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathbf">Ax</span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:3.0954em;vertical-align:-1.2671em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span><p>我们还可以观察到这个表达式中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 的第一个维度是静态的。于是，einsum 标记可以写为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">A</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi>m</mi></msub><mo>≡</mo><mtext mathvariant="monospace">nm,m-&gt;n</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{A}_{(n),m}\mathbf{x}_m \equiv \texttt{nm,m-&gt;n}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0413em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6945em;vertical-align:-.1389em></span><span class="mord text"><span class="mord texttt">nm,m->n</span></span></span></span></span></span><p>通过最后一个例子的结果，我们可以很容易地表达出两个矩阵相乘后的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i, j)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal">i</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.05724em>j</span><span class=mclose>)</span></span></span></span> 项。</p><p>令 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{A} \in \mathbb{R}^{N \times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">A</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">B</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{B} \in \mathbb{R}^{M \times K}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">B</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span></span></span></span></span></span></span></span></span>，则 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">B</mi></mrow><annotation encoding="application/x-tex">\mathbf{B}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">B</span></span></span></span> 的乘积为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="bold">A</mi><mi mathvariant="bold">B</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">b</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold">b</mi><mi>M</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>1</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mi>M</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>2</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>2</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mn>2</mn><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mi>M</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">a</mi><mi>N</mi><mi mathvariant="normal">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mi>M</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathbf{A}\mathbf{B}
&amp;= \begin{bmatrix} \mathbf{a}_1^{\mathrm{T}} \\ \vdots \\ \mathbf{a}_N^{\mathrm{T}} \end{bmatrix} \begin{bmatrix} \mathbf{b}_1, \ldots, \mathbf{b}_M \\ \end{bmatrix} \\
&amp;= \begin{bmatrix} \mathbf{a}_1^{\mathrm{T}} \mathbf{b}_1 &amp; \mathbf{a}_1^{\mathrm{T}} \mathbf{b}_2 &amp; \ldots &amp; \mathbf{a}_1^{\mathrm{T}} \mathbf{b}_M \\ \mathbf{a}_2^{\mathrm{T}} \mathbf{b}_1 &amp; \mathbf{a}_2^{\mathrm{T}} \mathbf{b}_2 &amp; \ldots &amp; \mathbf{a}_2^{\mathrm{T}} \mathbf{b}_M\\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ \mathbf{a}_N^{\mathrm{T}} \mathbf{b}_1 &amp; \mathbf{a}_N^{\mathrm{T}} \mathbf{b}_2 &amp; \ldots &amp; \mathbf{a}_N^{\mathrm{T}} \mathbf{b}_M \end{bmatrix}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:10.3267em;vertical-align:-4.9133em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:5.4133em><span style=top:-8.014em><span class=pstrut style=height:4.982em></span><span class=mord><span class="mord mathbf">AB</span></span></span><span style=top:-2.8507em><span class=pstrut style=height:4.982em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:4.9133em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:5.4133em><span style=top:-8.014em><span class=pstrut style=height:4.982em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M403 1759V84H666V0H319V1759v6e2 1759h347v-84H403zm0 0V0H319V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.3813em><span style=top:-5.2275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span></span></span><span style=top:-3.3675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-2.1662em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.8813em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M347 1759V0H0V84H263V1759v6e2 1759H0v84H347zm0 0V0H263V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size1">[</span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=minner>…</span><span class=mspace style=margin-right:.1667em></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style=top:0><span class="delimsizing size1">]</span></span></span></span></span><span style=top:-2.8507em><span class=pstrut style=height:4.982em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M403 1759V84H666V0H319V1759v18e2 1759h347v-84H403zm0 0V0H319V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.982em><span style=top:-5.8282em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6268em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7668em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5655em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.482em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.982em><span style=top:-5.8282em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6268em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7668em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5655em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.482em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.982em><span style=top:-5.6407em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span><span style=top:-4.4393em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span><span style=top:-2.5793em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>⋱</span></span></span><span style=top:-1.378em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.482em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.982em><span style=top:-5.8282em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6268em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7668em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5655em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.482em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M347 1759V0H0V84H263V1759v18e2 1759H0v84H347zm0 0V0H263V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:4.9133em><span></span></span></span></span></span></span></span></span></span></span></span><p>于是，矩阵乘积 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi><mi mathvariant="bold">B</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}\mathbf{B}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">AB</span></span></span></span> 中的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(i, j)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal">i</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.05724em>j</span><span class=mclose>)</span></span></span></span> 项为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="bold">A</mi><mi mathvariant="bold">B</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">a</mi><mi>i</mi><mi mathvariant="bold">T</mi></msubsup><msub><mi mathvariant="bold">b</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>a</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><msub><mi>b</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathbf{A}\mathbf{B} &amp;= \mathbf{a}_i^{\mathbf{T}} \mathbf{b}_j \\ &amp;= \sum_{m=1}^M a_{i,m} b_{m, j}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:4.9487em;vertical-align:-2.2244em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.7244em><span style=top:-5.6594em><span class=pstrut style=height:3.8283em></span><span class=mord><span class="mord mathbf">AB</span></span></span><span style=top:-3.1711em><span class=pstrut style=height:3.8283em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.2244em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.7244em><span style=top:-5.6594em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8933em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.247em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span><span style=top:-3.1711em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">a</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">b</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.2244em><span></span></span></span></span></span></span></span></span></span></span></span><p>从上面的等式中，我们看到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 的第一个维度和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">B</mi></mrow><annotation encoding="application/x-tex">\mathbf{B}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">B</span></span></span></span> 的第二个维度是静态的。其 einsum 标记为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">A</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">B</mi><mrow><mi>m</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub><mo>≡</mo><mtext mathvariant="monospace">im,mj-&gt;ij</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{A}_{(i),m} \mathbf{B}_{m, (j)}\equiv \texttt{im,mj-&gt;ij}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0413em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">B</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8333em;vertical-align:-.2222em></span><span class="mord text"><span class="mord texttt">im,mj->ij</span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>A</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>B</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>A</span> <span class=o>@</span> <span class=n>B</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([[</span> <span class=mi>2</span><span class=p>,</span>  <span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>       <span class=p>[</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;im,mj-&gt;ij&#34;</span><span class=p>,</span> <span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([[</span> <span class=mi>2</span><span class=p>,</span>  <span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>       <span class=p>[</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>]])</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=更高维的数组>更高维的数组<a hidden class=anchor aria-hidden=true href=#更高维的数组>#</a></h3><p>在机器学习中使用 einsum 的优势在于它们在处理高维数组时的具有强大的表达能力。正如我们将看到的，<strong>知道矩阵向量乘法运算的 einsum 表示很容易让我们将其推广到多个维度</strong>。这是因为当输出中存在静态维度时，可以将枚举视为线性变换的表达式。</p><p>为了促进使用 einsums 标记在机器学习中表示线性组合，我们考虑以下示例。</p><h2 id=机器学习中的-einsums>机器学习中的 Einsums<a hidden class=anchor aria-hidden=true href=#机器学习中的-einsums>#</a></h2><p>令 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{x} \in \mathbb{R}^M</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5782em;vertical-align:-.0391em></span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span> 和 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{A} \in \mathbb{R}^{M \times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">A</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 分别表示一个一维数组和一个二维数组，则以零为中心，精度矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 的平方马氏距离定义为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mi mathvariant="bold">A</mi></msub><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi mathvariant="bold">x</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">
D_{\mathbf{A}}(\mathbf{x}) = \mathbf{x}^{\mathrm{T}} \mathbf{A} \mathbf{x}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3303em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">Ax</span></span></span></span></span><p>根据矩阵乘法法则，对于任意给定的 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 和一个有效的精度矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">A</span></span></span></span> 我们都可以计算 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant="bold">A</mi></msub><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{\mathbf{A}}(\mathbf{x})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3303em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mclose>)</span></span></span></span>。我们可以得到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant="bold">A</mi></msub><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{\mathbf{A}}(\mathbf{x})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3303em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mclose>)</span></span></span></span> 的 einsum 标注为 <code>i,ij,j-></code>，这是因为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi mathvariant="bold">x</mi><mi mathvariant="bold">T</mi></msup><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msub><mi>x</mi><mi>i</mi></msub><msub><mi>A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi>x</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo><mover><mo><mo>≡</mo></mo><mtext>einsum</mtext></mover></mo><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi>j</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathbf{x}^{\mathbf{T}} \mathbf{A} \mathbf{x}
&amp;= \sum_{i,j} x_i A_{i,j} x_j \\
&amp;\stackrel{\text{einsum}}{\equiv} \mathbf{x}_i \mathbf{A}_{i,j} \mathbf{x}_j
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:4.655em;vertical-align:-2.0775em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5775em><span style=top:-4.7588em><span class=pstrut style=height:3.2313em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8933em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">Ax</span></span></span><span style=top:-1.8137em><span class=pstrut style=height:3.2313em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.0775em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.5775em><span style=top:-4.7588em><span class=pstrut style=height:3.2313em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.05em><span style=top:-1.8723em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.4138em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathnormal">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span><span style=top:-1.8137em><span class=pstrut style=height:3.2313em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel><span class="mop op-limits"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.2313em><span style=top:-3em><span class=pstrut style=height:3em></span><span><span class=mop>≡</span></span></span><span style=top:-3.6638em;margin-left:0><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">einsum</span></span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.0775em><span></span></span></span></span></span></span></span></span></span></span></span><p>一个更有趣的场景是：考虑这样一种情况，我们有 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span></span></span></span> 个观测值存储在一个二维数组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{X} \in \mathbb{R}^{N \times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">X</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span> 中。如果我们记 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi>n</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{x}_{n} \in \mathbb{R}^M</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6891em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span> 为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">X</span></span></span></span> 中的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">n</span></span></span></span> 个观测，我们需要计算每个观测值的平方马氏距离，以获得：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">x</mi><mi>n</mi><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mi>n</mi></msub><mspace width="1em"/><mi mathvariant="normal">∀</mi><mi>n</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>N</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">
\mathbf{x}_n^{\mathbf{T}} \mathbf{A} \mathbf{x}_n \quad \forall n \in \{1, \ldots, N\}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.1403em;vertical-align:-.247em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8933em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.247em><span></span></span></span></span></span></span><span class="mord mathbf">A</span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:1em></span><span class=mord>∀</span><span class="mord mathnormal">n</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>{</span><span class=mord>1</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=minner>…</span><span class=mspace style=margin-right:.1667em></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mclose>}</span></span></span></span></span><p>获得上面结果的一种方法是通过矩阵计算得到：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Diag</mtext><mo stretchy="false">(</mo><msup><mi mathvariant="bold">X</mi><mi mathvariant="bold">T</mi></msup><mi mathvariant="bold">A</mi><mi mathvariant="bold">X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\text{Diag}(\mathbf{X}^{\mathbf{T}}{\bf A}\mathbf{X})
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.1433em;vertical-align:-.25em></span><span class="mord text"><span class=mord>Diag</span></span><span class=mopen>(</span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8933em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class="mord mathbf">X</span><span class=mclose>)</span></span></span></span></span><p>其中：<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Diag</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">M</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><msub><mi mathvariant="bold">M</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\text{Diag}(\mathbf{M})_{i} = \mathbf{M}_{i,j}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord text"><span class=mord>Diag</span></span><span class=mopen>(</span><span class="mord mathbf">M</span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span>。</p><p>根据矩阵乘法，我们可以证明上面的结果：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi mathvariant="bold">X</mi><mi mathvariant="bold">A</mi><msup><mi mathvariant="bold">X</mi><mi mathvariant="bold">T</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">x</mi><mn>1</mn><mi mathvariant="bold">T</mi></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">x</mi><mi>N</mi><mi mathvariant="bold">T</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi mathvariant="bold">A</mi><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mi>N</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>1</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mi>N</mi><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mi>N</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>1</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>1</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>1</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mi>N</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>2</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>2</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mn>2</mn><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mi>N</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mi>N</mi><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mi>N</mi><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">x</mi><mi>N</mi><mi mathvariant="bold">T</mi></msubsup><mi mathvariant="bold">A</mi><msub><mi mathvariant="bold">x</mi><mi>N</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
(\mathbf{X} {\bf A}\mathbf{X}^{\mathbf{T}})
&amp;= \begin{bmatrix}\mathbf{x}_1^{\mathbf{T}} \\ \vdots \\\mathbf{x}_N^{\mathbf{T}}\end{bmatrix} {\bf A} \begin{bmatrix}{\bf x_1} &amp; \ldots &amp; \mathbf{x}_N\end{bmatrix}\\
&amp;= \begin{bmatrix}\mathbf{x}_1^{\mathbf{T}} {\bf A}\\ \vdots \\\mathbf{x}_N^{\mathbf{T}} {\bf A}\end{bmatrix} \begin{bmatrix}{\bf x_1} &amp; \ldots &amp; \mathbf{x}_N\end{bmatrix}\\
&amp;= \begin{bmatrix} \mathbf{x}_1^{\mathbf{T}} {\bf A} \mathbf{x}_1 &amp; \mathbf{x}_1^{\mathbf{T}} {\bf A} \mathbf{x}_2 &amp; \ldots &amp; \mathbf{x}_1^{\mathbf{T}} {\bf A} \mathbf{x}_N \\ \mathbf{x}_2^{\mathbf{T}} {\bf A} \mathbf{x}_1 &amp; \mathbf{x}_2^{\mathbf{T}} {\bf A} \mathbf{x}_2 &amp; \ldots &amp; \mathbf{x}_2^{\mathbf{T}} {\bf A} \mathbf{x}_N \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ \mathbf{x}_N^{\mathbf{T}} {\bf A} \mathbf{x}_1 &amp; \mathbf{x}_N^{\mathbf{T}} {\bf A} \mathbf{x}_2 &amp; \ldots &amp; \mathbf{x}_N^{\mathbf{T}} {\bf A} \mathbf{x}_N \end{bmatrix}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:14.9029em;vertical-align:-7.2015em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:7.7015em><span style=top:-10.3031em><span class=pstrut style=height:4.9849em></span><span class=mord><span class=mopen>(</span><span class="mord mathbf">X</span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8933em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span></span></span></span></span><span class=mclose>)</span></span></span><span style=top:-5.7366em><span class=pstrut style=height:4.9849em></span><span class=mord></span></span><span style=top:-.5684em><span class=pstrut style=height:4.9849em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:7.2015em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:7.7015em><span style=top:-10.3031em><span class=pstrut style=height:4.9849em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M403 1759V84H666V0H319V1759v6e2 1759h347v-84H403zm0 0V0H319V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.3833em><span style=top:-5.2275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span></span></span><span style=top:-3.3675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-2.1642em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.8833em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M347 1759V0H0V84H263V1759v6e2 1759H0v84H347zm0 0V0H263V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size1">[</span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=minner>…</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style=top:0><span class="delimsizing size1">]</span></span></span></span></span><span style=top:-5.7366em><span class=pstrut style=height:4.9849em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M403 1759V84H666V0H319V1759v6e2 1759h347v-84H403zm0 0V0H319V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.3833em><span style=top:-5.2275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span></span></span><span style=top:-3.3675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-2.1642em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.8833em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-4.35em><span class=pstrut style=height:6.2em></span><span style=width:.667em;height:4.2em><svg width=".667em" height="4.2em" viewBox="0 0 667 4200"><path d="M347 1759V0H0V84H263V1759v6e2 1759H0v84H347zm0 0V0H263V1759v6e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size1">[</span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=minner>…</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.85em><span style=top:-3.01em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.35em><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style=top:0><span class="delimsizing size1">]</span></span></span></span></span><span style=top:-.5684em><span class=pstrut style=height:4.9849em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M403 1759V84H666V0H319V1759v18e2 1759h347v-84H403zm0 0V0H319V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.9849em><span style=top:-5.8291em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6259em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7659em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5626em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.4849em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.9849em><span style=top:-5.8291em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6259em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7659em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5626em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.4849em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.9849em><span style=top:-5.6416em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span><span style=top:-4.4384em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span><span style=top:-2.5784em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>⋱</span></span></span><span style=top:-1.3751em><span class=pstrut style=height:3.5em></span><span class=mord><span class=minner>…</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.4849em><span></span></span></span></span></span><span class=arraycolsep style=width:.5em></span><span class=arraycolsep style=width:.5em></span><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.9849em><span style=top:-5.8291em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-4.6259em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4519em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2481em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span><span style=top:-2.7659em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5626em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.8433em><span style=top:-2.4247em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">T</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2753em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">A</span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.4849em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M347 1759V0H0V84H263V1759v18e2 1759H0v84H347zm0 0V0H263V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:7.2015em><span></span></span></span></span></span></span></span></span></span></span></span><p>但是，上述表达式的计算效率很低，因为我们需要计算 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>N</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">N^2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8141em></span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 项来获得我们想要的大小为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span></span></span></span> 的一维数组。更高效的方式是利用 einsum 标记来计算和表达上述的平方马氏距离问题。正如我们已经看到的，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi mathvariant="bold">A</mi></msub><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{\mathbf{A}}(\mathbf{x})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3303em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mclose>)</span></span></span></span> 的 einsum 标记形式为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
\mathbf{x}_{i}\mathbf{A}_{i,j}\mathbf{x}_j
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span></span><p>我们可以很简单地将上面的表达式扩展到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span></span></span></span> 个元素，我们只需要注意 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">X</span></span></span></span> 的第一个维度是静态的。我们可以得到：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">X</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>i</mi></mrow></msub><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">X</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>≡</mo><mtext mathvariant="monospace">ni,ij,nj-&gt;n</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{X}_{(n), i}\mathbf{A}_{i,j}\mathbf{X}_{(n),j} \equiv \texttt{ni,ij,nj-&gt;n}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0413em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8333em;vertical-align:-.2222em></span><span class="mord text"><span class="mord texttt">ni,ij,nj->n</span></span></span></span></span></span><p>这个特定的例子中，<strong>使用 einsum 标注可以帮助我们避免计算不在对角线上的元素</strong>，与直接利用矩阵相乘方法相比，提高了我们的速度。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=o>%%</span><span class=n>timeit</span> <span class=o>-</span><span class=n>n</span> <span class=mi>10</span> <span class=o>-</span><span class=n>r</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>diag</span><span class=p>(</span><span class=n>X</span> <span class=o>@</span> <span class=n>A</span> <span class=o>@</span> <span class=n>X</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=n>loops</span><span class=p>,</span> <span class=n>best</span> <span class=n>of</span> <span class=mi>10</span><span class=p>:</span> <span class=mf>5.8</span> <span class=n>s</span> <span class=n>per</span> <span class=n>loop</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>In</span> <span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=o>%%</span><span class=n>timeit</span> <span class=o>-</span><span class=n>n</span> <span class=mi>10</span> <span class=o>-</span><span class=n>r</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>   <span class=o>...</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;ni,ij,nj-&gt;n&#34;</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>A</span><span class=p>,</span> <span class=n>X</span><span class=p>,</span> <span class=n>optimize</span><span class=o>=</span><span class=s2>&#34;optimal&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=n>loops</span><span class=p>,</span> <span class=n>best</span> <span class=n>of</span> <span class=mi>10</span><span class=p>:</span> <span class=mi>598</span> <span class=n>ms</span> <span class=n>per</span> <span class=n>loop</span>
</span></span></code></pre></td></tr></table></div></div><p>为了推广这一结果，我们考虑三维数组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>N</mi><mn>1</mn></msub><mo>×</mo><msub><mi>N</mi><mn>2</mn></msub><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{X} \in \mathbb{R}^{N_{1} \times N_{2} \times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">X</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3173em><span style=top:-2.357em;margin-left:-.109em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.143em><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3173em><span style=top:-2.357em;margin-left:-.109em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.143em><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span>。使用线性代数的基本工具，我们已经没法用代数形式表示在 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">X</span></span></span></span> 的最后一维上进行平方马氏距离的计算。从我们之前的结果中，我们看到为了扩展 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">X</span></span></span></span> 的计算，我们只需要引入一个额外的静态维度：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">X</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>i</mi></mrow></msub><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">X</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>≡</mo><mtext mathvariant="monospace">nmi,ij,nmj-&gt;nm</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{X}_{(n), (m), i}\mathbf{A}_{i,j}\mathbf{X}_{(n),(m), j} \equiv \texttt{nmi,ij,nmj-&gt;nm}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0413em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">A</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">X</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.05724em>j</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8333em;vertical-align:-.2222em></span><span class="mord text"><span class="mord texttt">nmi,ij,nmj->nm</span></span></span></span></span></span><p>最后这些表达式表明，<strong>当我们必须计算未使用索引的已知线性变换时，einsums 可以提供很大帮助</strong>。</p><p>如果我们继续增加 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">X</span></span></span></span> 的维度，我们会得到以下结果：</p><ol><li><code>i,ij,j-></code> 得到标量输出，</li><li><code>ni,ij,nj->n</code> 得到一维数组输出，</li><li><code>nmi,ij,nmj->nm</code> 得到二维数组输出，</li><li><code>nmli,ij,nmlj->nml</code> 得到三维数组是输出，</li><li><code>…i,ij,…j->…</code> 得到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal">d</span></span></span></span> 维数组输出。</li></ol><p>此外，einsums 表达式在索引块上是可交换的。这意味着 einsum 表达式的结果与数组的定位顺序无关。对于我们之前的示例，以下三个表达式是等价的：</p><ol><li><code>ni,ij,nj->n</code></li><li><code>ni,nj,ij->n</code></li><li><code>ni,nj,ij->n</code></li></ol><h3 id=高斯分布的对数密度函数>高斯分布的对数密度函数<a hidden class=anchor aria-hidden=true href=#高斯分布的对数密度函数>#</a></h3><p>令 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>∼</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold-italic">μ</mi><mo separator="true">,</mo><mi mathvariant="bold">Σ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} \sim \mathcal{N}(\boldsymbol{\mu}, \boldsymbol{\Sigma})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∼</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathcal" style=margin-right:.14736em>N</span><span class=mopen>(</span><span class=mord><span class=mord><span class="mord boldsymbol">μ</span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span><span class=mclose>)</span></span></span></span>，则 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 的对数密度函数为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>log</mi><mo>⁡</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">μ</mi><mo separator="true">,</mo><mi mathvariant="bold">Σ</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>−</mo><mi mathvariant="bold-italic">μ</mi><msup><mo stretchy="false">)</mo><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>−</mo><mi mathvariant="bold-italic">μ</mi><mo stretchy="false">)</mo><mo>+</mo><mtext>const</mtext></mrow><annotation encoding="application/x-tex">
\log p(\mathbf{x} \vert \boldsymbol{\mu}, \boldsymbol{\Sigma}) = -\frac{1}{2}(\mathbf{x} - \boldsymbol{\mu})^{\mathrm{T}}\boldsymbol{\Sigma}^{-1}(\mathbf{x} - \boldsymbol{\mu}) + \text{const}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mop>lo<span style=margin-right:.01389em>g</span></span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal">p</span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mord>∣</span><span class=mord><span class=mord><span class="mord boldsymbol">μ</span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.0074em;vertical-align:-.686em></span><span class=mord>−</span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>2</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.686em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1.1413em;vertical-align:-.25em></span><span class=mord><span class=mord><span class="mord boldsymbol">μ</span></span></span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class=mord><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8901em><span style=top:-3.139em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mopen>(</span><span class="mord mathbf">x</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord><span class=mord><span class="mord boldsymbol">μ</span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6151em></span><span class="mord text"><span class=mord>const</span></span></span></span></span></span><p>假设我们想要绘制二元高斯分布的对数密度函数在区域 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi><mo>⊆</mo><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathcal{X} \subseteq \mathbb{R}^2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8193em;vertical-align:-.136em></span><span class="mord mathcal" style=margin-right:.14643em>X</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>⊆</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8141em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 中的图像。正如我们之前看到的，表达式 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">x</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">A</mi><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}^{\mathrm{T}} \mathbf{A} \mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbf">x</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">Ax</span></span></span></span> 的 einsum 标注为 <code>i,ij,j-></code>。通过引入静态维度 <code>n</code> 和 <code>m</code>，我们可以计算在 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\mathcal{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathcal" style=margin-right:.14643em>X</span></span></span></span> 上的对数密度函数，只需要将 <code>n</code> 和 <code>m</code> 索引加入 einsum 表达式中，并且将它们指定为输出的大小。于是，我们可以得到：<code>inm,ij,jnm->nm</code>。</p><p>下面，我们展示了一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>mean_vec</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span> 
</span></span><span class=line><span class=cl><span class=n>cov_matrix</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mi>4</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span> <span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=n>prec_matrix</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>cov_matrix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>step</span> <span class=o>=</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl><span class=n>xmin</span><span class=p>,</span> <span class=n>xmax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>8</span><span class=p>,</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>ymin</span><span class=p>,</span> <span class=n>ymax</span> <span class=o>=</span> <span class=o>-</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>X_grid</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>mgrid</span><span class=p>[</span><span class=n>xmin</span><span class=p>:</span><span class=n>xmax</span><span class=p>:</span><span class=n>step</span><span class=p>,</span> <span class=n>ymin</span><span class=p>:</span><span class=n>ymax</span><span class=p>:</span><span class=n>step</span><span class=p>]</span> <span class=o>+</span> <span class=n>mean_vec</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>diff_grid</span> <span class=o>=</span> <span class=p>(</span><span class=n>X_grid</span> <span class=o>-</span> <span class=n>mean_vec</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>log_prob_grid</span> <span class=o>=</span> <span class=o>-</span><span class=n>jnp</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;inm,ij,jnm-&gt;nm&#34;</span><span class=p>,</span> <span class=n>diff_grid</span><span class=p>,</span> <span class=n>prec_matrix</span><span class=p>,</span> <span class=n>diff_grid</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>contour</span><span class=p>(</span><span class=o>*</span><span class=n>X_grid</span><span class=p>,</span> <span class=n>log_prob_grid</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><figure class=align-center><img loading=lazy src=images/log_density_gaussian.jpg#center alt=高斯分布对数密度 width=75%><figcaption><p>高斯分布对数密度</p></figcaption></figure><p>我们将上面的想法扩展到 <strong>一组具有恒定均值和多个协方差矩阵的多元高斯</strong> 的情况。</p><p>回想一下，计算区域 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi><mo>⊆</mo><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathcal{X} \subseteq \mathbb{R}^2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8193em;vertical-align:-.136em></span><span class="mord mathcal" style=margin-right:.14643em>X</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>⊆</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8141em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8141em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> 上二元高斯分布的对数密度的 einsum 表达式由 <code>inm,ij,jnm->nm</code> 给出。假设我们有一组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个高斯分布，对于每个 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.03148em>k</span></span></span></span>，我们有一个精度矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">S</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{S}_{k}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8361em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> 和一个同样的均值 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">μ</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>M</mi></msup></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu} \in \mathbb{R}^{M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7335em;vertical-align:-.1944em></span><span class=mord><span class=mord><span class="mord boldsymbol">μ</span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span>。为了计算每个区域的密度函数，我们只需修改之前的表达式以考虑新的静态维度 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.03148em>k</span></span></span></span>。我们得到：<code>inm,kij,jnm->knm</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>C1</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C2</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C3</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C4</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>C1</span><span class=p>,</span> <span class=n>C2</span><span class=p>,</span> <span class=n>C3</span><span class=p>,</span> <span class=n>C4</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>C</span><span class=p>)</span> <span class=c1># inversion over the fist dimension</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log_prob_grid_multiple</span> <span class=o>=</span> <span class=o>-</span><span class=n>jnp</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;inm,kij,jnm-&gt;knm&#34;</span><span class=p>,</span> <span class=n>diff_grid</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>diff_grid</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>axi</span><span class=p>,</span> <span class=n>log_prob_grid</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>log_prob_grid_multiple</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>axi</span><span class=o>.</span><span class=n>contour</span><span class=p>(</span><span class=o>*</span><span class=n>X_grid</span><span class=p>,</span> <span class=n>log_prob_grid</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><figure class=align-center><img loading=lazy src=images/K_gaussian_distributions.jpg#center alt="K 组均值相同精度不同的高斯分布" width=75%><figcaption><p>K 组均值相同精度不同的高斯分布</p></figcaption></figure><p>回顾一下，计算的马氏距离的 einsum 表达式由下式给出：</p><ul><li><code>i,ij,ij-></code> <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 为一维数组（向量）；</li><li><code>ni,ij,nj->n</code> 对于 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span></span></span></span> 组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 构成的观测矩阵；</li><li><code>nmi,ij,nmj->nm</code> 对于 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">N \times M</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7667em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>M</span></span></span></span> 组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 构成的观测值网格；</li><li><code>nmi,kij,nmj->knm</code> 对于 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">N \times M</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7667em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>M</span></span></span></span> 组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class="mord mathbf">x</span></span></span></span> 构成的观测值网格，并且具有不同的精度矩阵。</li></ul><h3 id=贝叶斯逻辑回归模型的预测面>贝叶斯逻辑回归模型的预测面<a hidden class=anchor aria-hidden=true href=#贝叶斯逻辑回归模型的预测面>#</a></h3><p><strong>只要我们的运算中最里面的操作存在元素的线性组合，我们就可以使用 einsum 表达式。</strong></p><p>下一个示例，我们计算高斯先验下的贝叶斯逻辑回归的预测曲面。也就是说，我们要计算：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>p</mi><mo stretchy="false">(</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mo>∫</mo><msup><mi mathvariant="double-struck">R</mi><mn>2</mn></msup></msub><mi>σ</mi><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">w</mi><mi mathvariant="normal">∣</mi><mi mathvariant="script">D</mi><mo stretchy="false">)</mo><mi>d</mi><mi mathvariant="bold">x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi mathvariant="bold">w</mi><mi mathvariant="normal">∣</mi><mi mathvariant="script">D</mi></mrow></msub><mrow><mo fence="true">[</mo><mi>σ</mi><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≈</mo><mfrac><mn>1</mn><mi>S</mi></mfrac><munderover><mo>∑</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mi>σ</mi><mrow><mo fence="true">(</mo><msup><msup><mi mathvariant="bold">w</mi><mrow><mo stretchy="false">(</mo><mi mathvariant="bold">s</mi><mo stretchy="false">)</mo></mrow></msup><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">x</mi><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
p(\hat{y} = 1 \vert \mathbf{x})
&amp;= \int_{\mathbb{R}^2} \sigma(\mathbf{w}^{\mathrm{T}} \mathbf{x}) p(\mathbf{w} \vert \mathcal{D}) d\mathbf{x}\\
&amp;= \mathbb{E}_{\mathbf{w} \vert \mathcal{D}}\left[\sigma(\mathbf{w}^{\mathrm{T}} \mathbf{x})\right]\\
&amp;\approx \frac{1}{S} \sum_{s=1}^S \sigma\left({\bf w^{(s)}}^{\mathrm{T}} \mathbf{x}\right)
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:7.5187em;vertical-align:-3.5094em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:4.0094em><span style=top:-6.4777em><span class=pstrut style=height:3.8283em></span><span class=mord><span class="mord mathnormal">p</span><span class=mopen>(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.6944em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.03588em>y</span></span><span style=top:-3em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1944em><span class=mord>^</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1944em><span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord>1∣</span><span class="mord mathbf">x</span><span class=mclose>)</span></span></span><span style=top:-4.3744em><span class=pstrut style=height:3.8283em></span><span class=mord></span></span><span style=top:-1.8861em><span class=pstrut style=height:3.8283em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:3.5094em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:4.0094em><span style=top:-6.4777em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mop><span class="mop op-symbol large-op" style=margin-right:.44445em;position:relative;top:-.0011em>∫</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:-.3895em><span style=top:-1.7881em;margin-left:-.4445em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbb mtight">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7463em><span style=top:-2.786em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.9119em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=mopen>(</span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>w</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">x</span><span class=mclose>)</span><span class="mord mathnormal">p</span><span class=mopen>(</span><span class="mord mathbf" style=margin-right:.01597em>w</span><span class=mord>∣</span><span class="mord mathcal" style=margin-right:.02778em>D</span><span class=mclose>)</span><span class="mord mathnormal">d</span><span class="mord mathbf">x</span></span></span><span style=top:-4.3744em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbb">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style=margin-right:.01597em>w</span><span class="mord mtight">∣</span><span class="mord mathcal mtight" style=margin-right:.02778em>D</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=mopen>(</span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>w</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">x</span><span class=mclose>)</span><span class="mclose delimcenter" style=top:0><span class="delimsizing size1">]</span></span></span></span></span><span style=top:-1.8861em><span class=pstrut style=height:3.8283em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3214em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.05764em>S</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.686em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace style=margin-right:.1667em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8829em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.05764em>S</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2671em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size2">(</span></span><span class=mord><span class=mord><span class=mord><span class=mord><span class="mord mathbf" style=margin-right:.01597em>w</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.938em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathbf mtight">s</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.1692em><span style=top:-3.3909em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathbf">x</span><span class="mclose delimcenter" style=top:0><span class="delimsizing size2">)</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:3.5094em><span></span></span></span></span></span></span></span></span></span></span></span><p>假设我们已经估计了后验分布的参数 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">w</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{\mathbf{w}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7079em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>w</span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1667em><span class=mord>^</span></span></span></span></span></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">Σ</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{\boldsymbol{\Sigma}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9495em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span></span></span></span>。因此预测分布的后验在计算上是难以处理的，我用使用后验预测分布表面的蒙特卡罗近似。和之前的例子相同，我们想要计算在区域上计算 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mn>1</mn><mi mathvariant="normal">∣</mi><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(\hat{y} = 1 \vert \mathbf{x})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">p</span><span class=mopen>(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.6944em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.03588em>y</span></span><span style=top:-3em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1944em><span class=mord>^</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1944em><span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1∣</span><span class="mord mathbf">x</span><span class=mclose>)</span></span></span></span>。</p><p>在这种情况下，我们从后验分布 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi mathvariant="bold">w</mi><mi mathvariant="normal">∣</mi><mi mathvariant="script">D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(\mathbf{w} \vert \mathcal{D})</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">p</span><span class=mopen>(</span><span class="mord mathbf" style=margin-right:.01597em>w</span><span class=mord>∣</span><span class="mord mathcal" style=margin-right:.02778em>D</span><span class=mclose>)</span></span></span></span> 中采样了 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.05764em>S</span></span></span></span> 个权重。对于每个权重 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4306em></span><span class="mord mathnormal">s</span></span></span></span>，我们要计算网格点 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\mathcal{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathcal" style=margin-right:.14643em>X</span></span></span></span> 处的值。</p><p>回想一下，两个向量之间的点乘可以用 einsum 表示为 <code>m,m-></code>。为了得到由一组 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.05764em>S</span></span></span></span> 在格网 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">X</mi></mrow><annotation encoding="application/x-tex">\mathcal{X}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathcal" style=margin-right:.14643em>X</span></span></span></span> 上每个点计算的值（结果是一个三维数组），我们可以简单地在点乘中引入一个静态维度 <code>s</code>，表示每一个模拟的权重。令 <code>i</code>，<code>j</code> 表示网格上的位置，我们可以得到 einsum 表达式为：<code>sm,mij->sij</code>。</p><p>在计算了 <code>sij</code> 后，我们对结果使用 logistic 函数，并在 <code>s</code> 维度上对每个元素取平均，得到近似的预测分布。</p><p>下面是代码片段：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Estimated posterior mean and precision matrix</span>
</span></span><span class=line><span class=cl><span class=n>w_hat</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>4.29669692</span><span class=p>,</span> <span class=mf>1.6520908</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>S_hat</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mf>2.74809243</span><span class=p>,</span> <span class=mf>0.76832627</span><span class=p>],</span>
</span></span><span class=line><span class=cl>					<span class=p>[</span><span class=mf>0.76832627</span><span class=p>,</span> <span class=mf>0.88442754</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=n>C_hat</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>S_hat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n_samples</span> <span class=o>=</span> <span class=mi>1_000</span>
</span></span><span class=line><span class=cl><span class=n>boundary</span><span class=p>,</span> <span class=n>step</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>jax</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>PRNGKey</span><span class=p>(</span><span class=mi>314</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_grid</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>mgrid</span><span class=p>[</span><span class=o>-</span><span class=n>boundary</span><span class=p>:</span><span class=n>boundary</span><span class=p>:</span><span class=n>step</span><span class=p>,</span> <span class=o>-</span><span class=n>boundary</span><span class=p>:</span><span class=n>boundary</span><span class=p>:</span><span class=n>step</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>w_samples</span> <span class=o>=</span> <span class=n>jax</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>multivariate_normal</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>w_hat</span><span class=p>,</span> <span class=n>S_hat</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=p>(</span><span class=n>n_samples</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logit_grid</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;sm,mij-&gt;sij&#34;</span><span class=p>,</span> <span class=n>w_samples</span><span class=p>,</span> <span class=n>X_grid</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>P_grid</span> <span class=o>=</span> <span class=n>jax</span><span class=o>.</span><span class=n>nn</span><span class=o>.</span><span class=n>sigmoid</span><span class=p>(</span><span class=n>logit_grid</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>contour</span><span class=p>(</span><span class=o>*</span><span class=n>X_grid</span><span class=p>,</span> <span class=n>P_grid</span><span class=p>,</span> <span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;$p(\hat</span><span class=si>{y}</span><span class=s2> = 1 \vert \mathbf</span><span class=si>{x}</span><span class=s2>)$&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>15</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><figure class=align-center><img loading=lazy src=images/bayesian_logistic_regression_surface.jpg#center alt=贝叶斯逻辑回归模型的预测面 width=75%><figcaption><p>贝叶斯逻辑回归模型的预测面</p></figcaption></figure><h3 id=图像压缩奇异值分解svd>图像压缩：奇异值分解（SVD）<a hidden class=anchor aria-hidden=true href=#图像压缩奇异值分解svd>#</a></h3><p>在学习奇异值分解时，一个典型的应用是 <strong>使用奇异值分解来压缩图像</strong>。作为一个启发式示例，假设我们想要在多个阈值上比较图像的奇异值分解结果。</p><p>我们将图像 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span> 分解为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">P</mi><mo><mover><mo><mo>≡</mo></mo><mtext>einsum</mtext></mover></mo><msub><mi mathvariant="bold">c</mi><mi>k</mi></msub><msub><mi mathvariant="bold">L</mi><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>M</mi></mrow></msup><mo>≡</mo><mtext mathvariant="monospace">c,ijc-&gt;ij</mtext></mrow><annotation encoding="application/x-tex">
\mathbf{P} \stackrel{\text{einsum}}{\equiv} \mathbf{c}_{k}\mathbf{L}_{(n),(m),k} \in\mathbb{R}^{N\times M} \equiv \texttt{c,ijc-&gt;ij}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.2313em></span><span class="mord mathbf">P</span><span class=mspace style=margin-right:.2778em></span><span class=mrel><span class="mop op-limits"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.2313em><span style=top:-3em><span class=pstrut style=height:3em></span><span><span class=mop>≡</span></span></span><span style=top:-3.6638em;margin-left:0><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">einsum</span></span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0413em;vertical-align:-.3552em></span><span class=mord><span class="mord mathbf">c</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord mathbf">L</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8333em;vertical-align:-.2222em></span><span class="mord text"><span class="mord texttt">c,ijc->ij</span></span></span></span></span></span><p>这是线性代数的经典结果，我们可以将矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span> 可以分解为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">P</mi><mo>=</mo><mi mathvariant="bold">U</mi><mi mathvariant="bold">Σ</mi><msup><mi mathvariant="bold">V</mi><mi mathvariant="normal">T</mi></msup></mrow><annotation encoding="application/x-tex">
\mathbf{P} = \mathbf{U} \boldsymbol{\Sigma} \mathbf{V}^{\mathrm{T}}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class="mord mathbf">U</span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span></span></span></span></span></span><p>其中：<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">U</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><mi>M</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{U} \in \mathbb{R}^{M \times M}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">U</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span></span></span></span></span></span></span></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{V} \in \mathbb{R}^{N \times N}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span></span></span></span></span></span></span></span></span>，以及 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Σ</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\boldsymbol{\Sigma} \in \mathbb{R}^{M \times N}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span></span></span></span></span></span></span></span></span></span></span></span>。<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Σ</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\Sigma}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class=mord><span class=mord><span class="mord mathbf">Σ</span></span></span></span></span></span> 中的对角线元素为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>σ</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>σ</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>σ</mi><mrow><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\sigma_1, \sigma_2, \ldots, \sigma_{\min(n,m)}\}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.1052em;vertical-align:-.3552em></span><span class=mopen>{</span><span class=mord><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=minner>…</span><span class=mspace style=margin-right:.1667em></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:-.0359em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class=mtight>m</span><span class=mtight>i</span><span class=mtight>n</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mclose>}</span></span></span></span>，其他元素为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6444em></span><span class=mord>0</span></span></span></span>。</p><p>在 <code>scipy</code> 中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span> 的 SVD 分解被方便地分解（以 einsum 形式）为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">P</mi><mo><mover><mo><mo>≡</mo></mo><mtext>einsum</mtext></mover></mo><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">
\mathbf{P} \stackrel{\text{einsum}}{\equiv}\hat{\mathbf{U}}_{(n),k}\hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, (m)}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.2313em></span><span class="mord mathbf">P</span><span class=mspace style=margin-right:.2778em></span><span class=mrel><span class="mop op-limits"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:1.2313em><span style=top:-3em><span class=pstrut style=height:3em></span><span><span class=mop>≡</span></span></span><span style=top:-3.6638em;margin-left:0><span class=pstrut style=height:3em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">einsum</span></span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.3047em;vertical-align:-.3552em></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span></span></span></span></span><p>其中：<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>M</mi><mo>×</mo><mi>R</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\hat{\mathbf{U}} \in \mathbb{R}^{M \times R}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9886em;vertical-align:-.0391em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>M</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.00773em>R</span></span></span></span></span></span></span></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>R</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\hat{\mathbf{V}} \in \mathbb{R}^{N \times R}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9886em;vertical-align:-.0391em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.00773em>R</span></span></span></span></span></span></span></span></span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">σ</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>σ</mi><mn>1</mn></msub><mo>…</mo><mo separator="true">,</mo><msub><mi>σ</mi><mi>R</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\boldsymbol{\sigma} = \{\sigma_1 \ldots, \sigma_R\}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.4444em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>{</span><span class=mord><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=minner>…</span><span class=mspace style=margin-right:.1667em></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.03588em>σ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.00773em>R</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mclose>}</span></span></span></span>，并且 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>M</mi><mo separator="true">,</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R = \min(M,N)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.00773em>R</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mop>min</span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mclose>)</span></span></span></span>。</p><p>作为一个示例，假设我们想要用前 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个奇异值分量来近似矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span>。首先我们观察到矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span> 的第 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n,m)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal">n</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal">m</span><span class=mclose>)</span></span></span></span> 个元素可由下式计算：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">P</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>R</mi></munderover><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mi>n</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
\mathbf{P}_{n,m} = \sum_{k=1}^R \hat{\mathbf{U}}_{n,k} \hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, m}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">P</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:3.1304em;vertical-align:-1.3021em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8479em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.00773em>R</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3021em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span></span><p>如果我们想考虑 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">P</mi><mrow><mi>n</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{P}_{n,m}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">P</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> 的前 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个分量，我们只需要修改求和中的项数即可得到：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mi>n</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
\sum_{k=1}^K \hat{\mathbf{U}}_{n,k} \hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, m}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.1304em;vertical-align:-1.3021em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8479em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3021em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span></span><p>但是，上面的表达式 <strong>不能用 einsum 标注表示</strong>。正如我在开头提到的，<strong>每个 einsum 表达式都假设在索引的每个元素上求和</strong>。</p><p>为了绕过这个约束，我们简单的引入大小为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.00773em>R</span></span></span></span> 的一维向量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><mi>K</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{1}_{\cdot \leq K}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8896em;vertical-align:-.2452em></span><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2452em><span></span></span></span></span></span></span></span></span></span>，其中前 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个元素的值为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6444em></span><span class=mord>1</span></span></span></span>，剩下 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>−</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">R-K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7667em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.00773em>R</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个元素的值为 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6444em></span><span class=mord>0</span></span></span></span>。</p><p>因此，使用前 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 个奇异值分量近似矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">P</span></span></span></span> 的表达式可以写为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>R</mi></munderover><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mi>n</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><mi>K</mi></mrow></msub><msub><mo stretchy="false">)</mo><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">
\sum_{k=1}^R \hat{\mathbf{U}}_{n,k} \hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, m} (\mathbf{1}_{\cdot \leq K})_{k}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.1304em;vertical-align:-1.3021em></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8283em><span style=top:-1.8479em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style=top:-3.05em><span class=pstrut style=height:3.05em></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style=top:-4.3em;margin-left:0><span class=pstrut style=height:3.05em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style=margin-right:.00773em>R</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3021em><span></span></span></span></span></span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mopen>(</span><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2452em><span></span></span></span></span></span></span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span></span><p>上式可以简单的用 einsum 表达式写为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mi>m</mi></mrow></msub><mo stretchy="false">(</mo><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><mi>K</mi></mrow></msub><msub><mo stretchy="false">)</mo><mi>k</mi></msub><mo>≡</mo><mtext mathvariant="monospace">nk,k,km,k-&gt;nm</mtext></mrow><annotation encoding="application/x-tex">
\hat{\mathbf{U}}_{(n),k} \hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, {m}} (\mathbf{1}_{\cdot \leq K})_{k} \equiv \texttt{nk,k,km,k-&gt;nm}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.3047em;vertical-align:-.3552em></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mopen>(</span><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2452em><span></span></span></span></span></span></span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.75em;vertical-align:-.1389em></span><span class="mord text"><span class="mord texttt">nk,k,km,k->nm</span></span></span></span></span></span><p>我们同样可以考虑 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>K</span></span></span></span> 取不同值的情况。我们定义二维数组：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">I</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><mi>K</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><msub><mi>K</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mn mathvariant="bold">1</mn><mrow><mo>⋅</mo><mo>≤</mo><msub><mi>K</mi><mi>C</mi></msub></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathbf{I} = \begin{bmatrix} \mathbf{1}_{\cdot \leq K}\\ \mathbf{1}_{\cdot \leq K_2}\\ \vdots\\ \mathbf{1}_{\cdot \leq K_C}\\ \end{bmatrix}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">I</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:5.46em;vertical-align:-2.48em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M403 1759V84H666V0H319V1759v18e2 1759h347v-84H403zm0 0V0H319V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-c><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.98em><span style=top:-5.8275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2452em><span></span></span></span></span></span></span></span></span><span style=top:-4.6275em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3173em><span style=top:-2.357em;margin-left:-.0715em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.143em><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2501em><span></span></span></span></span></span></span></span></span><span style=top:-2.7675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class=mord>⋮</span><span class="mord rule" style=border-right-width:0;border-top-width:1.5em;bottom:0></span></span></span></span><span style=top:-1.5675em><span class=pstrut style=height:3.6875em></span><span class=mord><span class=mord><span class="mord mathbf">1</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3283em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">⋅</span><span class="mrel mtight">≤</span><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>K</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.3567em;margin-left:-.0715em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.1433em><span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2503em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.48em><span></span></span></span></span></span></span></span><span class=mclose><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.95em><span style=top:-4.95em><span class=pstrut style=height:7.4em></span><span style=width:.667em;height:5.4em><svg width=".667em" height="5.4em" viewBox="0 0 667 5400"><path d="M347 1759V0H0V84H263V1759v18e2 1759H0v84H347zm0 0V0H263V1759v18e2 1759h84z"/></svg></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:2.45em><span></span></span></span></span></span></span></span></span></span></span></span><p>接下来，我们简单地修改我们之前的表达式，以考虑到矩阵 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">I</mi></mrow><annotation encoding="application/x-tex">\mathbf{I}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">I</span></span></span></span> 的附加静态维度。我们可以得到：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mover accent="true"><mi mathvariant="bold">U</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi></mrow></msub><msub><mover accent="true"><mi mathvariant="bold-italic">σ</mi><mo>^</mo></mover><mi>k</mi></msub><msub><mover accent="true"><mi mathvariant="bold">V</mi><mo>^</mo></mover><mrow><mi>k</mi><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msub><msub><mi mathvariant="bold">I</mi><mrow><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≡</mo><mtext mathvariant="monospace">nk,k,km,ck-&gt;nmc</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≡</mo><mtext mathvariant="monospace">nk,k,km,ck-&gt;cnm</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\hat{\mathbf{U}}_{(n),k}\hat{\boldsymbol{\sigma}}_{k} \hat{\mathbf{V}}_{k, (m)}{\mathbf{I}}_{(c), k} &amp;\equiv \texttt{nk,k,km,ck-&gt;nmc}\\
&amp;\equiv \texttt{nk,k,km,ck-&gt;cnm}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.1096em;vertical-align:-1.3048em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8048em><span style=top:-3.8552em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf">U</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.2222em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.7079em><span style=top:-3em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord boldsymbol" style=margin-right:.03704em>σ</span></span></span></span><span style=top:-3.0134em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mord><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.9495em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathbf" style=margin-right:.01597em>V</span></span><span style=top:-3.2551em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.25em><span class=mord>^</span></span></span></span></span></span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span><span class=mord><span class=mord><span class="mord mathbf">I</span></span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.5198em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style=margin-right:.03148em>k</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3552em><span></span></span></span></span></span></span></span></span><span style=top:-2.3552em><span class=pstrut style=height:3em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3048em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8048em><span style=top:-3.8552em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span><span class="mord text"><span class="mord texttt">nk,k,km,ck->nmc</span></span></span></span><span style=top:-2.3552em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≡</span><span class=mspace style=margin-right:.2778em></span><span class="mord text"><span class="mord texttt">nk,k,km,ck->cnm</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3048em><span></span></span></span></span></span></span></span></span></span></span></span><p>我们在下一个代码中提供了一个例子：首先，我们加载一张图像存到三维数组 <code>img</code> 中。接下来，我们对 <code>img</code> 进行变换，得到一个二维数组 <code>img_gray</code>。我们在 <code>img_gray</code> 上执行奇异值分解并定义了一个矩阵 <code>indexer</code> 包含不同的阈值。最后，我们利用我们之前定义的表达式来计算在 <code>indexer</code> 中定义的不同阈值的图像的 SVD 近似值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>FILEPATH</span> <span class=o>=</span> <span class=s2>&#34;https://i.imgur.com/p91lldL.png&#34;</span>
</span></span><span class=line><span class=cl><span class=n>img</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>FILEPATH</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>c_weights</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.2989</span><span class=p>,</span> <span class=mf>0.5870</span><span class=p>,</span> <span class=mf>0.1140</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>img_gray</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;c,ijc-&gt;ij&#34;</span><span class=p>,</span> <span class=n>c_weights</span><span class=p>,</span> <span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>U</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>Vh</span> <span class=o>=</span> <span class=n>jax</span><span class=o>.</span><span class=n>scipy</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>svd</span><span class=p>(</span><span class=n>img_gray</span><span class=p>,</span> <span class=n>full_matrices</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>indexer</span> <span class=o>=</span> <span class=n>s</span><span class=p>[:,</span> <span class=kc>None</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>jnp</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>10</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>1_000</span><span class=p>,</span> <span class=mi>5_000</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>img_svd_collection</span> <span class=o>=</span> <span class=n>jnp</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s2>&#34;nk,k,km,ck-&gt;cnm&#34;</span><span class=p>,</span> <span class=n>U</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>Vh</span><span class=p>,</span> <span class=n>indexer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>ravel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>axi</span><span class=p>,</span> <span class=n>img_svd</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>img_svd_collection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>axi</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>img_svd</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s2>&#34;bone&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>axi</span><span class=o>.</span><span class=n>axis</span><span class=p>(</span><span class=s2>&#34;off&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>(</span><span class=n>w_pad</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><figure class=align-center><img loading=lazy src=images/SVD_approximation_image.jpg#center alt="SVD 近似图像"><figcaption><p>SVD 近似图像</p></figcaption></figure></div><footer class=post-footer><ul class=post-tags><li><a href=https://ehehe.cn/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/>机器学习</a></li><li><a href=https://ehehe.cn/tags/%E7%88%B1%E5%9B%A0%E6%96%AF%E5%9D%A6%E6%B1%82%E5%92%8C/>爱因斯坦求和</a></li><li><a href=https://ehehe.cn/tags/einsum/>Einsum</a></li></ul><nav class=paginav><a class=prev href=https://ehehe.cn/posts/2023/07-deeplabv2/><span class=title>« Prev</span><br><span>DeepLabv2：基于空洞卷积与 ASPP 的语义图像分割</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ehehe.cn/>Yan Tang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){function e(){var e,t,n,s=document.getElementsByTagName("code");for(n=0;n<s.length;){if(t=s[n],t.parentNode.tagName!=="PRE"&&t.childElementCount===0&&(e=t.textContent,/^\$[^$]/.test(e)&&/[^$]\$$/.test(e)&&(e=e.replace(/^\$/,"\\(").replace(/\$$/,"\\)"),t.textContent=e),/^\\\((.|\s)+\\\)$/.test(e)||/^\\\[(.|\s)+\\\]$/.test(e)||/^\$(.|\s)+\$$/.test(e)||/^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(e))){t.outerHTML=t.innerHTML;continue}n++}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>(function(){var n=window.pageYOffset||document.documentElement.scrollTop||0,s=800,t=!1,e=null;function o(){if(t=!1,e||(e=document.getElementById("top-link")),!e)return;var o=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,i=o>n;n=o<0?0:o,o>s&&!i?(e.style.visibility="visible",e.style.opacity="1"):(e.style.visibility="hidden",e.style.opacity="0")}window.addEventListener("scroll",function(){t||(window.requestAnimationFrame(o),t=!0)},{passive:!0})})()</script><script>(function(){var t=10;function n(e){if(!e)return[0,20];var n,s,o=window.getComputedStyle(e),t=parseFloat(o.lineHeight);return(!t||isNaN(t))&&(t=20),n=e.getBoundingClientRect(),s=n.height||e.offsetHeight||0,[Math.round(s/t),t]}function e(){var e=document.querySelectorAll(".highlight");if(!e||!e.length)return;Array.prototype.forEach.call(e,function(e){if(e.classList.contains("expanded")||e.classList.contains("collapsible"))return;var s,o,a,r,c,l,i=e.querySelector("pre code");if(!i)return;if(r=i.className||"",r.indexOf("language-mermaid")>=0||e.classList.contains("mermaid"))return;if(a=n(i),c=a[0],l=a[1],c<=t)return;e.classList.add("collapsible"),e.style.setProperty("--code-line-height",l+"px"),e.id||(e.id="code-block-"+Math.random().toString(36).slice(2)),o=document.createElement("div"),o.className="code-expand-wrapper",s=document.createElement("button"),s.type="button",s.className="code-expand-link",s.textContent="Show more",s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",e.id),s.addEventListener("click",function(){var n,i,a,o=e.classList.contains("expanded"),r=getComputedStyle(e).getPropertyValue("--code-line-height"),t=parseFloat(r)*(parseFloat(getComputedStyle(e).getPropertyValue("--code-max-lines"))||10);(!isFinite(t)||t<=0)&&(t=10*20),i=e.getBoundingClientRect().height,a=o?t:e.scrollHeight,e.style.maxHeight=i+"px",e.offsetHeight,o?e.classList.remove("expanded"):e.classList.add("expanded"),e.style.maxHeight=a+"px",n=function(t){if(t.propertyName!=="max-height")return;if(e.removeEventListener("transitionend",n),e.style.maxHeight="",e.classList.contains("expanded"))s.textContent="Show less",s.setAttribute("aria-expanded","true");else{s.textContent="Show more",s.setAttribute("aria-expanded","false");try{e.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}}window.dispatchEvent(new Event("resize"))},e.addEventListener("transitionend",n)}),o.appendChild(s),e.nextSibling?e.parentNode.insertBefore(o,e.nextSibling):e.parentNode.appendChild(o)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>