<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>DINOv2 可视化 🦖 | Yan Tang</title><meta name=keywords content="representation learning,visualization,PCA,DINOv2,DINOv3"><meta name=description content="介绍如何通过 PCA 方式可视化 DINOv2 模型的图像嵌入表示。"><meta name=author content="Yan Tang"><link rel=canonical href=https://kenanking.github.io/posts/2025/02-dino-visualization/><link crossorigin=anonymous href=/assets/css/stylesheet.7d6c2be2ce8d304b9de78bb980a8328b9454f69f9c59241fe5c9b37e708b283c.css integrity="sha256-fWwr4s6NMEud54u5gKgyi5RU9p+cWSQf5cmzfnCLKDw=" rel="preload stylesheet" as=style><link rel=icon href=https://kenanking.github.io/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=16x16 href=https://kenanking.github.io/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=32x32 href=https://kenanking.github.io/assets/images/favicon-32x32.ico><link rel=apple-touch-icon href=https://kenanking.github.io/assets/images/apple-touch-icon.png><link rel=mask-icon href=https://kenanking.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kenanking.github.io/posts/2025/02-dino-visualization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css rel=stylesheet integrity=sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP crossorigin=anonymous><meta property="og:url" content="https://kenanking.github.io/posts/2025/02-dino-visualization/"><meta property="og:site_name" content="Yan Tang"><meta property="og:title" content="DINOv2 可视化 🦖"><meta property="og:description" content="介绍如何通过 PCA 方式可视化 DINOv2 模型的图像嵌入表示。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-09T00:00:00+00:00"><meta property="article:tag" content="Representation Learning"><meta property="article:tag" content="Visualization"><meta property="article:tag" content="PCA"><meta property="article:tag" content="DINOv2"><meta property="article:tag" content="DINOv3"><meta name=twitter:card content="summary"><meta name=twitter:title content="DINOv2 可视化 🦖"><meta name=twitter:description content="介绍如何通过 PCA 方式可视化 DINOv2 模型的图像嵌入表示。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kenanking.github.io/posts/"},{"@type":"ListItem","position":2,"name":"DINOv2 可视化 🦖","item":"https://kenanking.github.io/posts/2025/02-dino-visualization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"DINOv2 可视化 🦖","name":"DINOv2 可视化 🦖","description":"介绍如何通过 PCA 方式可视化 DINOv2 模型的图像嵌入表示。","keywords":["representation learning","visualization","PCA","DINOv2","DINOv3"],"articleBody":" DINOv2 Sparse Matching\nDINOv2 最令人印象深刻的特性之一是其能够匹配图像之间的 嵌入表示。对于机器学习模型来说，两个嵌入向量就足以比较两幅图像。但对我们人类而言，仅靠两个浮点数数组还不足以直观理解。这时，可视化技术就派上用场了。\n一切始于一张图片 看着上面的图像，我不禁想：这怎么可能实现呢？其实，这种匹配能力是由 对比学习 驱动的，即通过比较相似和不相似的示例，将它们匹配在一起或分开，从而学习世界。\n对比学习范式是一个强大的框架，但我们今天的重点只是如何 可视化 这种学习的结果。\n为什么要这样做？因为在论文和他们的代码中并不十分清晰（请查看 这个 GitHub 问题）。所以我想，一个简短的指南可能会对未来的研究者（或者未来的自己）有所帮助。\nDINOv2 可视化 DINOv2 PCA Components\n可视化过程包括四个阶段：\n收集输入图像：我们无法仅对单张图像使用 PCA 进行可视化，我们需要一些同一类别 / 标签 / 主题的图像示例（请查看上图的第一列）。 背景阈值处理：背景是所有图像的共同点，所以在一组随机图像中，它是 PCA 的最强分量，因此我们需要去除它。 PCA 计算：一旦我们去除了背景，就可以在没有背景的图像上计算 PCA 分量，并将其映射到颜色通道，便于人类理解。 绘制结果：将背景绘制为黑色（零值），将前景作为具有三个通道的像素绘制到图像中。 在本指南中，我假设您在工作目录的一个名为 images 的子文件夹中有六张图像：\n1 2 3 4 5 6 7 images ├── image_1.jpg ├── image_2.jpg ├── image_3.jpg ├── image_4.jpg ├── image_5.jpg └── image_6.jpg 六张输入图像\n收集输入图像 首先，我们收集输入图像，并将它们读取为具有相同高度 HHH 和宽度 WWW 的张量：\nI1∈RC×H×WI2∈RC×H×W \\begin{aligned} \u0026 I_1 \\in \\mathbb{R}^{C \\times H \\times W} \\\\ \u0026 I_2 \\in \\mathbb{R}^{C \\times H \\times W} \\end{aligned} ​I1​∈RC×H×WI2​∈RC×H×W​其中，C=3C=3C=3 为通道数（RGB）。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import torch from einops import rearrange from torchvision.transforms import Normalize from torchvision.transforms.functional import resize from torchvision.utils import save_image from torchvision.io.image import read_image, ImageReadMode # 读取图像并确保它们具有相同的形状 I1 = read_image(\"images/image_1.png\", ImageReadMode.RGB) I2 = read_image(\"images/image_2.png\", ImageReadMode.RGB) H, W = 672, 672 I1 = resize(I1, (H, W)) I2 = resize(I2, (H, W)) 然后，我们将它们沿着批次维度堆叠，得到批量图像张量 I∈RB×C×H×WI \\in \\mathbb{R}^{B \\times C \\times H \\times W}I∈RB×C×H×W，其中 B=2B = 2B=2：\nI=stack(I1,I2)∈RB×C×H×W I = \\text{stack}(I_1, I_2) \\in \\mathbb{R}^{B \\times C \\times H \\times W} I=stack(I1​,I2​)∈RB×C×H×W 1 I = torch.stack([I1, I2], dim=0) 接下来，我们需要根据 DINOv2 的预处理 对图像进行归一化。\nIˉ=Normalize(I255) \\bar{I} = \\text{Normalize}\\left(\\frac{I}{255}\\right) Iˉ=Normalize(255I​) 1 2 3 4 5 6 7 # 对 [0, 1] 范围内的张量使用的均值和标准差 IMAGENET_DEFAULT_MEAN = (0.485, 0.456, 0.406) IMAGENET_DEFAULT_STD = (0.229, 0.224, 0.225) norm = Normalize(mean=IMAGENET_DEFAULT_MEAN, std=IMAGENET_DEFAULT_STD) I_norm = norm(I / 255) 现在，我们将归一化后的批量图像张量输入 DINOv2，获取图像的 patch 嵌入表示（DINOv2 输出 CLS token 和 patch tokens，对于可视化，我们只关注 patch tokens）：\nEpatch=DINOv2(Iˉ)∈RB×L×D\\mathbf{E}_{\\text{patch}} = \\text{DINOv2}(\\bar{I}) \\in \\mathbb{R}^{B \\times L \\times D}Epatch​=DINOv2(Iˉ)∈RB×L×D其中，LLL 是每张图像的 patch 数量，DDD 是嵌入维度。\n1 2 3 dinov2 = torch.hub.load('facebookresearch/dinov2', 'dinov2_vitb14') features = dinov2.forward_features(I_norm) E_patch = features[\"x_norm_patchtokens\"] 背景阈值处理 一旦我们获得了输入图像的 patch tokens，第一步就是计算 PCA（主成分分析）以去除背景。为什么要这么做？因为背景是随机图像集合中唯一的共同特征。\n具体过程很简单：首先对图像进行 PCA，然后通过阈值化去除第一主成分。\n我们首先需要在 patch 维度上展平批量数据，以便在嵌入维度上计算 PCA。将 Epatch\\mathbf{E}_{\\text{patch}}Epatch​ 重塑为形状 E∈RN×D\\mathbf{E} \\in \\mathbb{R}^{N \\times D}E∈RN×D，其中 N=B×LN = B \\times LN=B×L：\nE=reshape(Epatch,(N,D)) \\mathbf{E} = \\text{reshape}\\left(\\mathbf{E}_{\\text{patch}}, (N, D)\\right) E=reshape(Epatch​,(N,D)) 1 E = rearrange(E_patch, \"B L D -\u003e (B L) D\") 然后，我们计算 E\\mathbf{E}E 的第一主成分，该成分主要代表背景信息：\nEpca1=E×v1∈RN×1 \\mathbf{E}_{\\text{pca1}} = \\mathbf{E} \\times \\mathbf{v}_1 \\in \\mathbb{R}^{N \\times 1} Epca1​=E×v1​∈RN×1其中，v1\\mathbf{v}_1v1​ 是第一主成分方向。\n1 2 3 4 # 计算 PCA _, _, V = torch.pca_lowrank(E) # 投影到第一主成分 E_pca1 = E @ V[:, :1] 接下来，对 Epca1\\mathbf{E}_{\\text{pca1}}Epca1​ 进行最小 - 最大归一化，将值映射到 [0,1][0, 1][0,1] 范围：\nEpca1norm=Epca1−min⁡(Epca1)max⁡(Epca1)−min⁡(Epca1) \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} = \\frac{\\mathbf{E}_{\\text{pca1}} - \\min(\\mathbf{E}_{\\text{pca1}})}{\\max(\\mathbf{E}_{\\text{pca1}}) - \\min(\\mathbf{E}_{\\text{pca1}})} Epca1norm​=max(Epca1​)−min(Epca1​)Epca1​−min(Epca1​)​ 1 2 3 4 def minmax_norm(x): return (x - x.min()) / (x.max() - x.min()) E_pca1_norm = minmax_norm(E_pca1) 通过阈值 0.50.50.5，将前景和背景分开，创建布尔掩码：\nMfg=Epca1norm\u003e0.5Mbg=Epca1norm≤0.5 \\begin{aligned} M_{\\text{fg}} \u0026= \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} \u003e 0.5 \\\\ M_{\\text{bg}} \u0026= \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} \\leq 0.5 \\end{aligned} Mfg​Mbg​​=Epca1norm​\u003e0.5=Epca1norm​≤0.5​ 1 2 M_fg = E_pca1_norm.squeeze() \u003c 0.4 M_bg = E_pca1_norm.squeeze() \u003e= 0.4 对前景嵌入计算三主成分 PCA 使用前景掩码 MfgM_{\\text{fg}}Mfg​，提取前景的嵌入：\nEfg=E[Mfg,:] \\mathbf{E}_{\\text{fg}} = \\mathbf{E}[M_{\\text{fg}}, :] Efg​=E[Mfg​,:]对前景嵌入计算包含三个主成分的 PCA：\nEpca3=Efg×V3∈RNfg×3 \\mathbf{E}_{\\text{pca3}} = \\mathbf{E}_{\\text{fg}} \\times \\mathbf{V}_3 \\in \\mathbb{R}^{N_{\\text{fg}} \\times 3} Epca3​=Efg​×V3​∈RNfg​×3其中，V3\\mathbf{V}_3V3​ 包含前三个主成分的方向，NfgN_{\\text{fg}}Nfg​ 是前景 patch 的数量。\n1 2 3 4 5 6 # 对前景嵌入计算 PCA _, _, V_fg = torch.pca_lowrank(E[M_fg]) # 投影到前三个主成分 E_pca3_fg = E[M_fg] @ V_fg[:, :3] # 归一化 E_pca3_fg_norm = minmax_norm(E_pca3_fg) 绘制图像 现在到了关键步骤。我们有一组表示背景的 patch tokens，以及一组表示前景的 patch tokens。为了绘制图像，我们需要：\n创建一个与原始 patch 张量形状相同、元素为零的新张量 对于每个 patch token，如果是背景，则将其值设为零（黑色）；如果是前景，则使用包含 3 个主成分（对应 3 个颜色通道）的值 创建一个与原始嵌入形状匹配的零张量 Idraw∈RN×3I_{\\text{draw}} \\in \\mathbb{R}^{N \\times 3}Idraw​∈RN×3：\nIdraw=0∈RN×3I_{\\text{draw}} = \\mathbf{0} \\in \\mathbb{R}^{N \\times 3}Idraw​=0∈RN×3将前景位置填入对应的 PCA 颜色值：\nIdraw[Mfg,:]=Epca3normI_{\\text{draw}}[M_{\\text{fg}}, :] = \\mathbf{E}_{\\text{pca3}}^{\\text{norm}}Idraw​[Mfg​,:]=Epca3norm​ 1 2 I_draw = torch.zeros(N, 3) I_draw[M_fg] = E_pca3_fg_norm 将 IdrawI_{\\text{draw}}Idraw​ 重塑回图像的 patch 维度：\nIdraw=reshape(Idraw,(B,Hp,Wp,3))I_{\\text{draw}} = \\text{reshape}\\left(I_{\\text{draw}}, (B, H_p, W_p, 3)\\right)Idraw​=reshape(Idraw​,(B,Hp​,Wp​,3))其中，Hp=H/PH_p = H / PHp​=H/P，Wp=W/PW_p = W / PWp​=W/P，PPP 是 patch 的大小。\n1 2 3 4 5 6 7 # 计算 patch 的高度和宽度 patch_size = 14 # 取决于模型配置 H_p = H // patch_size W_p = W // patch_size # 重塑为 (B, H_p, W_p, 3) I_draw = rearrange(I_draw, \"(B L) C -\u003e B H_p W_p C\", B=B, H_p=H_p, W_p=W_p) 将通道维度调整为第一维，并调整大小以适应原始图像尺寸：\n1 2 3 4 # 转换为通道优先格式 I_draw = rearrange(I_draw, \"B H_p W_p C -\u003e B C H_p W_p\") # 调整大小 I_draw = resize(I_draw, (H, W)) 保存生成的图像：\n1 2 3 4 # 保存图像 save_image(I_draw[0], \"images/image_1_pca.png\") save_image(I_draw[1], \"images/image_2_pca.png\") save_image(I_draw[2], \"images/image_3_pca.png\") 完整代码 为了方便参考，以下是整合后的完整代码：\n完整代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 import os from pathlib import Path import torch from einops import rearrange from torchvision.io.image import ImageReadMode, read_image from torchvision.transforms import Normalize from torchvision.transforms.functional import resize from torchvision.utils import save_image # 设置环境配置 torch.hub.set_dir(\"./torch_cache\") device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\") # 模型配置 MODEL_CONFIG = { \"vits14\": {\"name\": \"dinov2_vits14\", \"patch_size\": 14}, \"vitb14\": {\"name\": \"dinov2_vitb14\", \"patch_size\": 14}, \"vitl14\": {\"name\": \"dinov2_vitl14\", \"patch_size\": 14}, \"vitg14\": {\"name\": \"dinov2_vitg14\", \"patch_size\": 14}, \"vits14_reg\": {\"name\": \"dinov2_vits14_reg\", \"patch_size\": 14}, \"vitb14_reg\": {\"name\": \"dinov2_vitb14_reg\", \"patch_size\": 14}, \"vitl14_reg\": {\"name\": \"dinov2_vitl14_reg\", \"patch_size\": 14}, \"vitg14_reg\": {\"name\": \"dinov2_vitg14_reg\", \"patch_size\": 14}, }[\"vitl14\"] MODEL_NAME = MODEL_CONFIG[\"name\"] PATCH_SIZE = MODEL_CONFIG[\"patch_size\"] # 设置图像路径 image_folder = Path(\"images\") output_folder = Path(\"output\") Path(output_folder).mkdir(parents=True, exist_ok=True) image_paths = [str(p) for p in Path(image_folder).glob(\"*.jpg\")] H, W = 672, 672 images = [] for path in image_paths: img = read_image(path, ImageReadMode.RGB) img = resize(img, (H, W)) images.append(img) # 将图像堆叠为批量张量，形状为 (B, C, H, W) I = torch.stack(images, dim=0).to(device) # 对图像进行归一化处理 IMAGENET_DEFAULT_MEAN = (0.485, 0.456, 0.406) IMAGENET_DEFAULT_STD = (0.229, 0.224, 0.225) norm = Normalize(mean=IMAGENET_DEFAULT_MEAN, std=IMAGENET_DEFAULT_STD) I_norm = norm(I / 255) # 加载 DINOv2 模型并提取 patch 嵌入 dinov2 = torch.hub.load(\"facebookresearch/dinov2\", MODEL_NAME).to(device) dinov2.eval() with torch.no_grad(): features = dinov2.forward_features(I_norm) E_patch = features[\"x_norm_patchtokens\"] # 形状为 (B, L, D) E_patch = E_patch.cpu() # 展平批量和 patch 维度 B, L, D = E_patch.shape N = B * L E = rearrange(E_patch, \"B L D -\u003e (B L) D\") # 形状为 (N, D) # 计算第一主成分（背景） _, _, V = torch.pca_lowrank(E) E_pca1 = E @ V[:, :1] # 形状为 (N, 1) # 定义最小-最大归一化函数 def minmax_norm(x): return (x - x.min()) / (x.max() - x.min() + 1e-5) # 加上一个小值防止除以零 # 对第一主成分进行归一化 E_pca1_norm = minmax_norm(E_pca1) # 创建前景和背景的布尔掩码 M_fg = E_pca1_norm.squeeze() \u003c 0.6 # 前景掩码 # 对前景嵌入计算 PCA，并投影到前三个主成分上 _, _, V_fg = torch.pca_lowrank(E[M_fg]) E_pca3_fg = E[M_fg] @ V_fg[:, :3] E_pca3_fg_norm = minmax_norm(E_pca3_fg) # 形状为 (N_fg, 3) # 创建用于绘制的零张量，并填充前景位置 I_draw = torch.zeros(N, 3) I_draw[M_fg] = E_pca3_fg_norm # 计算 patch 的高度和宽度 H_p = H // PATCH_SIZE W_p = W // PATCH_SIZE # 重塑为 (B, H_p, W_p, 3) I_draw = rearrange(I_draw, \"(B H_p W_p) C -\u003e B H_p W_p C\", B=B, H_p=H_p, W_p=W_p) # 转换为通道优先格式并调整大小以匹配原始图像尺寸 I_draw = rearrange(I_draw, \"B H_p W_p C -\u003e B C H_p W_p\") I_draw_resized = torch.zeros(B, 3, H, W) for i in range(B): I_draw_resized[i] = resize(I_draw[i], (H, W)) # 保存生成的图像 for i, path in enumerate(image_paths): input_filename = Path(path).name output_path = ( Path(output_folder) / f\"{Path(input_filename).stem}_pca{Path(input_filename).suffix}\" ) save_image(I_draw_resized[i].cpu(), str(output_path)) 六张输入图像及其 PCA 可视化\n","wordCount":"1101","inLanguage":"en","datePublished":"2024-11-09T00:00:00Z","dateModified":"2024-11-09T00:00:00Z","author":{"@type":"Person","name":"Yan Tang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kenanking.github.io/posts/2025/02-dino-visualization/"},"publisher":{"@type":"Organization","name":"Yan Tang","logo":{"@type":"ImageObject","url":"https://kenanking.github.io/assets/images/favicon-16x16.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kenanking.github.io/ accesskey=h title="Yan Tang (Alt + H)">Yan Tang</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kenanking.github.io/ title=Posts><span>Posts</span></a></li><li><a href=https://kenanking.github.io/about/ title=About><span>About</span></a></li><li><a href=https://kenanking.github.io/publications/ title=Publications><span>Publications</span></a></li><li><a href=https://kenanking.github.io/archives/ title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">DINOv2 可视化 🦖</h1><div class=post-meta><span title='2024-11-09 00:00:00 +0000 UTC'>November 9, 2024</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>Yan Tang</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%b8%80%e5%88%87%e5%a7%8b%e4%ba%8e%e4%b8%80%e5%bc%a0%e5%9b%be%e7%89%87 aria-label=一切始于一张图片>一切始于一张图片</a></li><li><a href=#dinov2-%e5%8f%af%e8%a7%86%e5%8c%96 aria-label="DINOv2 可视化">DINOv2 可视化</a></li><li><a href=#%e6%94%b6%e9%9b%86%e8%be%93%e5%85%a5%e5%9b%be%e5%83%8f aria-label=收集输入图像>收集输入图像</a></li><li><a href=#%e8%83%8c%e6%99%af%e9%98%88%e5%80%bc%e5%a4%84%e7%90%86 aria-label=背景阈值处理>背景阈值处理</a></li><li><a href=#%e5%af%b9%e5%89%8d%e6%99%af%e5%b5%8c%e5%85%a5%e8%ae%a1%e7%ae%97%e4%b8%89%e4%b8%bb%e6%88%90%e5%88%86-pca aria-label="对前景嵌入计算三主成分 PCA">对前景嵌入计算三主成分 PCA</a></li><li><a href=#%e7%bb%98%e5%88%b6%e5%9b%be%e5%83%8f aria-label=绘制图像>绘制图像</a></li><li><a href=#%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81 aria-label=完整代码>完整代码</a></li></ul></div></details></div><div class=post-content><figure><img loading=lazy src=images/dinov2_sparse_matching.jpg alt="DINOv2 Sparse Matching"><figcaption><p>DINOv2 Sparse Matching</p></figcaption></figure><p>DINOv2 最令人印象深刻的特性之一是其能够匹配图像之间的 <strong>嵌入表示</strong>。对于机器学习模型来说，两个嵌入向量就足以比较两幅图像。但对我们人类而言，仅靠两个浮点数数组还不足以直观理解。这时，可视化技术就派上用场了。</p><h2 id=一切始于一张图片>一切始于一张图片<a hidden class=anchor aria-hidden=true href=#一切始于一张图片>#</a></h2><p>看着上面的图像，我不禁想：这怎么可能实现呢？其实，这种匹配能力是由 <strong>对比学习</strong> 驱动的，即通过比较相似和不相似的示例，将它们匹配在一起或分开，从而学习世界。</p><p>对比学习范式是一个强大的框架，但我们今天的重点只是如何 <strong>可视化</strong> 这种学习的结果。</p><p>为什么要这样做？因为在论文和他们的代码中并不十分清晰（请查看 <a href=https://github.com/facebookresearch/dinov2/issues/23>这个 GitHub 问题</a>）。所以我想，一个简短的指南可能会对未来的研究者（或者未来的自己）有所帮助。</p><h2 id=dinov2-可视化>DINOv2 可视化<a hidden class=anchor aria-hidden=true href=#dinov2-可视化>#</a></h2><figure><img loading=lazy src=images/dinov2_visualization_of_the_first_PCA_components.jpg alt="DINOv2 PCA Components"><figcaption><p>DINOv2 PCA Components</p></figcaption></figure><p>可视化过程包括四个阶段：</p><ul><li><strong>收集输入图像</strong>：我们无法仅对单张图像使用 PCA 进行可视化，我们需要一些同一类别 / 标签 / 主题的图像示例（请查看上图的第一列）。</li><li><strong>背景阈值处理</strong>：背景是所有图像的共同点，所以在一组随机图像中，它是 PCA 的最强分量，因此我们需要去除它。</li><li><strong>PCA 计算</strong>：一旦我们去除了背景，就可以在没有背景的图像上计算 PCA 分量，并将其映射到颜色通道，便于人类理解。</li><li><strong>绘制结果</strong>：将背景绘制为黑色（零值），将前景作为具有三个通道的像素绘制到图像中。</li></ul><p>在本指南中，我假设您在工作目录的一个名为 <code>images</code> 的子文件夹中有六张图像：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>images 
</span></span><span class=line><span class=cl>├── image_1.jpg
</span></span><span class=line><span class=cl>├── image_2.jpg
</span></span><span class=line><span class=cl>├── image_3.jpg
</span></span><span class=line><span class=cl>├── image_4.jpg
</span></span><span class=line><span class=cl>├── image_5.jpg
</span></span><span class=line><span class=cl>└── image_6.jpg
</span></span></code></pre></td></tr></table></div></div><figure class="multi-figure align-center"><div class=multi-figure-container><div class=multi-figure-row data-images=3><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1.jpg alt="Image 1"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2.jpg alt="Image 2"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3.jpg alt="Image 3"></figure></div><div class=multi-figure-row data-images=3><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4.jpg alt="Image 4"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5.jpg alt="Image 5"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6.jpg alt="Image 6"></figure></div></div><figcaption><p>六张输入图像</p></figcaption></figure><h2 id=收集输入图像>收集输入图像<a hidden class=anchor aria-hidden=true href=#收集输入图像>#</a></h2><p>首先，我们收集输入图像，并将它们读取为具有相同高度 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.08125em>H</span></span></span></span> 和宽度 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>W</span></span></span></span> 的张量：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>I</mi><mn>1</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>C</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>I</mi><mn>2</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>C</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; I_1 \in \mathbb{R}^{C \times H \times W} \\
&amp; I_2 \in \mathbb{R}^{C \times H \times W}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.1027em;vertical-align:-1.3013em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8013em><span style=top:-3.8013em><span class=pstrut style=height:2.8913em></span><span class=mord></span></span><span style=top:-2.25em><span class=pstrut style=height:2.8913em></span><span class=mord></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3013em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8013em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span><span style=top:-2.3587em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.3013em><span></span></span></span></span></span></span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">C=3</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>3</span></span></span></span> 为通道数（RGB）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>einops</span> <span class=kn>import</span> <span class=n>rearrange</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms</span> <span class=kn>import</span> <span class=n>Normalize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms.functional</span> <span class=kn>import</span> <span class=n>resize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.utils</span> <span class=kn>import</span> <span class=n>save_image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.io.image</span> <span class=kn>import</span> <span class=n>read_image</span><span class=p>,</span> <span class=n>ImageReadMode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 读取图像并确保它们具有相同的形状</span>
</span></span><span class=line><span class=cl><span class=n>I1</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=s2>&#34;images/image_1.png&#34;</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I2</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=s2>&#34;images/image_2.png&#34;</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>H</span><span class=p>,</span> <span class=n>W</span> <span class=o>=</span> <span class=mi>672</span><span class=p>,</span> <span class=mi>672</span>
</span></span><span class=line><span class=cl><span class=n>I1</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I1</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>I2</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I2</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，我们将它们沿着批次维度堆叠，得到批量图像张量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>×</mo><mi>C</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">I \in \mathbb{R}^{B \times C \times H \times W}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7224em;vertical-align:-.0391em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span>，其中 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">B = 2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>2</span></span></span></span>：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mo>=</mo><mtext>stack</mtext><mo stretchy="false">(</mo><msub><mi>I</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>I</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>×</mo><mi>C</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
I = \text{stack}(I_1, I_2) \in \mathbb{R}^{B \times C \times H \times W}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord text"><span class=mord>stack</span></span><span class=mopen>(</span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>I1</span><span class=p>,</span> <span class=n>I2</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来，我们需要根据 <a href=https://github.com/facebookresearch/dinov2/blob/main/dinov2/data/transforms.py#L42-L50>DINOv2 的预处理</a> 对图像进行归一化。</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>I</mi><mo>ˉ</mo></mover><mo>=</mo><mtext>Normalize</mtext><mrow><mo fence="true">(</mo><mfrac><mi>I</mi><mn>255</mn></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\bar{I} = \text{Normalize}\left(\frac{I}{255}\right)
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8201em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8201em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span></span><span style=top:-3.2523em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1389em><span class=mord>ˉ</span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.4em;vertical-align:-.95em></span><span class="mord text"><span class=mord>Normalize</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size3">(</span></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3603em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>255</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.686em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style=top:0><span class="delimsizing size3">)</span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 对 [0, 1] 范围内的张量使用的均值和标准差</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_MEAN</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_STD</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_MEAN</span><span class=p>,</span> <span class=n>std</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_STD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>I_norm</span> <span class=o>=</span> <span class=n>norm</span><span class=p>(</span><span class=n>I</span> <span class=o>/</span> <span class=mi>255</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>现在，我们将归一化后的批量图像张量输入 DINOv2，获取图像的 patch 嵌入表示（DINOv2 输出 CLS token 和 patch tokens，对于可视化，我们只关注 patch tokens）：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub><mo>=</mo><mtext>DINOv2</mtext><mo stretchy="false">(</mo><mover accent="true"><mi>I</mi><mo>ˉ</mo></mover><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>×</mo><mi>L</mi><mo>×</mo><mi>D</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{patch}} = \text{DINOv2}(\bar{I}) \in \mathbb{R}^{B \times L \times D}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0701em;vertical-align:-.25em></span><span class="mord text"><span class=mord>DINOv2</span></span><span class=mopen>(</span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8201em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span></span><span style=top:-3.2523em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1389em><span class=mord>ˉ</span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">L</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.02778em>D</span></span></span></span></span></span></span></span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span></span></span></span> 是每张图像的 patch 数量，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.02778em>D</span></span></span></span> 是嵌入维度。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dinov2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>&#39;facebookresearch/dinov2&#39;</span><span class=p>,</span> <span class=s1>&#39;dinov2_vitb14&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=n>dinov2</span><span class=o>.</span><span class=n>forward_features</span><span class=p>(</span><span class=n>I_norm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>features</span><span class=p>[</span><span class=s2>&#34;x_norm_patchtokens&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=背景阈值处理>背景阈值处理<a hidden class=anchor aria-hidden=true href=#背景阈值处理>#</a></h2><p>一旦我们获得了输入图像的 patch tokens，第一步就是计算 PCA（主成分分析）以去除背景。为什么要这么做？因为背景是随机图像集合中唯一的共同特征。</p><p>具体过程很简单：首先对图像进行 PCA，然后通过阈值化去除第一主成分。</p><p>我们首先需要在 patch 维度上展平批量数据，以便在嵌入维度上计算 PCA。将 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{patch}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> 重塑为形状 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">E</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>D</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{E} \in \mathbb{R}^{N \times D}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style=margin-right:.02778em>D</span></span></span></span></span></span></span></span></span></span></span></span>，其中 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>B</mi><mo>×</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">N = B \times L</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7667em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span></span></span></span>：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">E</mi><mo>=</mo><mtext>reshape</mtext><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathbf{E} = \text{reshape}\left(\mathbf{E}_{\text{patch}}, (N, D)\right)
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord text"><span class=mord>reshape</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=mclose>)</span><span class="mclose delimcenter" style=top:0>)</span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>E</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>E_patch</span><span class=p>,</span> <span class=s2>&#34;B L D -&gt; (B L) D&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，我们计算 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">E</mi></mrow><annotation encoding="application/x-tex">\mathbf{E}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">E</span></span></span></span> 的第一主成分，该成分主要代表背景信息：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo>=</mo><mi mathvariant="bold">E</mi><mo>×</mo><msub><mi mathvariant="bold">v</mi><mn>1</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca1}} = \mathbf{E} \times \mathbf{v}_1 \in \mathbb{R}^{N \times 1}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7694em;vertical-align:-.0833em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6891em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{v}_1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5944em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> 是第一主成分方向。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 计算 PCA</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 投影到第一主成分</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1</span> <span class=o>=</span> <span class=n>E</span> <span class=o>@</span> <span class=n>V</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>1</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来，对 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{pca1}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> 进行最小 - 最大归一化，将值映射到 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>[</span><span class=mord>0</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord>1</span><span class=mclose>]</span></span></span></span> 范围：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>=</mo><mfrac><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo>−</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo></mrow><mrow><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo><mo>−</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca1}}^{\text{norm}} = \frac{\mathbf{E}_{\text{pca1}} - \min(\mathbf{E}_{\text{pca1}})}{\max(\mathbf{E}_{\text{pca1}}) - \min(\mathbf{E}_{\text{pca1}})}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0975em;vertical-align:-.3831em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.3991em;vertical-align:-.9721em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.427em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mop>max</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mop>min</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mop>min</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.9721em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>minmax_norm</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>E_pca1_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>通过阈值 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn></mrow><annotation encoding="application/x-tex">0.5</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.5</span></span></span></span>，将前景和背景分开，创建布尔掩码：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>M</mi><mtext>fg</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>&gt;</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>M</mi><mtext>bg</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>≤</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
M_{\text{fg}} &amp;= \mathbf{E}_{\text{pca1}}^{\text{norm}} &gt; 0.5 \\
M_{\text{bg}} &amp;= \mathbf{E}_{\text{pca1}}^{\text{norm}} \leq 0.5
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.0462em;vertical-align:-1.2731em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7731em><span style=top:-3.9331em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2731em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7731em><span style=top:-3.9331em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>></span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.5</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.5</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.2731em><span></span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>M_fg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl><span class=n>M_bg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=mf>0.4</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=对前景嵌入计算三主成分-pca>对前景嵌入计算三主成分 PCA<a hidden class=anchor aria-hidden=true href=#对前景嵌入计算三主成分-pca>#</a></h2><p>使用前景掩码 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mtext>fg</mtext></msub></mrow><annotation encoding="application/x-tex">M_{\text{fg}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span>，提取前景的嵌入：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>fg</mtext></msub><mo>=</mo><mi mathvariant="bold">E</mi><mo stretchy="false">[</mo><msub><mi>M</mi><mtext>fg</mtext></msub><mo separator="true">,</mo><mo>:</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{fg}} = \mathbf{E}[M_{\text{fg}}, :]
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord mathbf">E</span><span class=mopen>[</span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mclose>]</span></span></span></span></span><p>对前景嵌入计算包含三个主成分的 PCA：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca3</mtext></msub><mo>=</mo><msub><mi mathvariant="bold">E</mi><mtext>fg</mtext></msub><mo>×</mo><msub><mi mathvariant="bold">V</mi><mn>3</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>N</mi><mtext>fg</mtext></msub><mo>×</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca3}} = \mathbf{E}_{\text{fg}} \times \mathbf{V}_3 \in \mathbb{R}^{N_{\text{fg}} \times 3}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca3</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8361em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.3488em;margin-left:-.109em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2901em><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{V}_3</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8361em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> 包含前三个主成分的方向，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mtext>fg</mtext></msub></mrow><annotation encoding="application/x-tex">N_{\text{fg}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> 是前景 patch 的数量。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 对前景嵌入计算 PCA</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V_fg</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># 投影到前三个主成分</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg</span> <span class=o>=</span> <span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>@</span> <span class=n>V_fg</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># 归一化</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca3_fg</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=绘制图像>绘制图像<a hidden class=anchor aria-hidden=true href=#绘制图像>#</a></h2><p>现在到了关键步骤。我们有一组表示背景的 patch tokens，以及一组表示前景的 patch tokens。为了绘制图像，我们需要：</p><ul><li>创建一个与原始 patch 张量形状相同、元素为零的新张量</li><li>对于每个 patch token，如果是背景，则将其值设为零（黑色）；如果是前景，则使用包含 3 个主成分（对应 3 个颜色通道）的值</li></ul><p>创建一个与原始嵌入形状匹配的零张量 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">I_{\text{draw}} \in \mathbb{R}^{N \times 3}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span>：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>=</mo><mn mathvariant="bold">0</mn><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">I_{\text{draw}} = \mathbf{0} \in \mathbb{R}^{N \times 3}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6835em;vertical-align:-.0391em></span><span class="mord mathbf">0</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>∈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span><p>将前景位置填入对应的 PCA 颜色值：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo stretchy="false">[</mo><msub><mi>M</mi><mtext>fg</mtext></msub><mo separator="true">,</mo><mo>:</mo><mo stretchy="false">]</mo><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca3</mtext><mtext>norm</mtext></msubsup></mrow><annotation encoding="application/x-tex">I_{\text{draw}}[M_{\text{fg}}, :] = \mathbf{E}_{\text{pca3}}^{\text{norm}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>[</span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mclose>]</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0975em;vertical-align:-.3831em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca3</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>N</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>=</span> <span class=n>E_pca3_fg_norm</span>
</span></span></code></pre></td></tr></table></div></div><p>将 <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub></mrow><annotation encoding="application/x-tex">I_{\text{draw}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> 重塑回图像的 patch 维度：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>=</mo><mtext>reshape</mtext><mrow><mo fence="true">(</mo><msub><mi>I</mi><mtext>draw</mtext></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>B</mi><mo separator="true">,</mo><msub><mi>H</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>p</mi></msub><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">I_{\text{draw}} = \text{reshape}\left(I_{\text{draw}}, (B, H_p, W_p, 3)\right)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord text"><span class=mord>reshape</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0>(</span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord>3</span><span class=mclose>)</span><span class="mclose delimcenter" style=top:0>)</span></span></span></span></span></span><p>其中，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>p</mi></msub><mo>=</mo><mi>H</mi><mi mathvariant="normal">/</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">H_p = H / P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=mord>/</span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>p</mi></msub><mo>=</mo><mi>W</mi><mi mathvariant="normal">/</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">W_p = W / P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=mord>/</span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span>，<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span> 是 patch 的大小。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 计算 patch 的高度和宽度</span>
</span></span><span class=line><span class=cl><span class=n>patch_size</span> <span class=o>=</span> <span class=mi>14</span>  <span class=c1># 取决于模型配置</span>
</span></span><span class=line><span class=cl><span class=n>H_p</span> <span class=o>=</span> <span class=n>H</span> <span class=o>//</span> <span class=n>patch_size</span>
</span></span><span class=line><span class=cl><span class=n>W_p</span> <span class=o>=</span> <span class=n>W</span> <span class=o>//</span> <span class=n>patch_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重塑为 (B, H_p, W_p, 3)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;(B L) C -&gt; B H_p W_p C&#34;</span><span class=p>,</span> <span class=n>B</span><span class=o>=</span><span class=n>B</span><span class=p>,</span> <span class=n>H_p</span><span class=o>=</span><span class=n>H_p</span><span class=p>,</span> <span class=n>W_p</span><span class=o>=</span><span class=n>W_p</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>将通道维度调整为第一维，并调整大小以适应原始图像尺寸：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 转换为通道优先格式</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;B H_p W_p C -&gt; B C H_p W_p&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 调整大小</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>保存生成的图像：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 保存图像</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s2>&#34;images/image_1_pca.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s2>&#34;images/image_2_pca.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=s2>&#34;images/image_3_pca.png&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=完整代码>完整代码<a hidden class=anchor aria-hidden=true href=#完整代码>#</a></h2><p>为了方便参考，以下是整合后的完整代码：</p><p><details><summary markdown=span>完整代码</summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>einops</span> <span class=kn>import</span> <span class=n>rearrange</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.io.image</span> <span class=kn>import</span> <span class=n>ImageReadMode</span><span class=p>,</span> <span class=n>read_image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms</span> <span class=kn>import</span> <span class=n>Normalize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms.functional</span> <span class=kn>import</span> <span class=n>resize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.utils</span> <span class=kn>import</span> <span class=n>save_image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置环境配置</span>
</span></span><span class=line><span class=cl><span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>set_dir</span><span class=p>(</span><span class=s2>&#34;./torch_cache&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>device</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&#34;cuda&#34;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&#34;cpu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 模型配置</span>
</span></span><span class=line><span class=cl><span class=n>MODEL_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vits14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vits14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitb14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitb14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitl14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitl14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitg14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitg14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vits14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vits14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitb14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitb14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitl14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitl14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitg14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitg14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}[</span><span class=s2>&#34;vitl14&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>MODEL_NAME</span> <span class=o>=</span> <span class=n>MODEL_CONFIG</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>PATCH_SIZE</span> <span class=o>=</span> <span class=n>MODEL_CONFIG</span><span class=p>[</span><span class=s2>&#34;patch_size&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置图像路径</span>
</span></span><span class=line><span class=cl><span class=n>image_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;images&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>output_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;output&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=n>output_folder</span><span class=p>)</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>image_paths</span> <span class=o>=</span> <span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>Path</span><span class=p>(</span><span class=n>image_folder</span><span class=p>)</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;*.jpg&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>H</span><span class=p>,</span> <span class=n>W</span> <span class=o>=</span> <span class=mi>672</span><span class=p>,</span> <span class=mi>672</span>
</span></span><span class=line><span class=cl><span class=n>images</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>image_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>images</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将图像堆叠为批量张量，形状为 (B, C, H, W)</span>
</span></span><span class=line><span class=cl><span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对图像进行归一化处理</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_MEAN</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_STD</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_MEAN</span><span class=p>,</span> <span class=n>std</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_STD</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_norm</span> <span class=o>=</span> <span class=n>norm</span><span class=p>(</span><span class=n>I</span> <span class=o>/</span> <span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载 DINOv2 模型并提取 patch 嵌入</span>
</span></span><span class=line><span class=cl><span class=n>dinov2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;facebookresearch/dinov2&#34;</span><span class=p>,</span> <span class=n>MODEL_NAME</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dinov2</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>features</span> <span class=o>=</span> <span class=n>dinov2</span><span class=o>.</span><span class=n>forward_features</span><span class=p>(</span><span class=n>I_norm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>features</span><span class=p>[</span><span class=s2>&#34;x_norm_patchtokens&#34;</span><span class=p>]</span>  <span class=c1># 形状为 (B, L, D)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>E_patch</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 展平批量和 patch 维度</span>
</span></span><span class=line><span class=cl><span class=n>B</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>D</span> <span class=o>=</span> <span class=n>E_patch</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl><span class=n>N</span> <span class=o>=</span> <span class=n>B</span> <span class=o>*</span> <span class=n>L</span>
</span></span><span class=line><span class=cl><span class=n>E</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>E_patch</span><span class=p>,</span> <span class=s2>&#34;B L D -&gt; (B L) D&#34;</span><span class=p>)</span>  <span class=c1># 形状为 (N, D)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算第一主成分（背景）</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1</span> <span class=o>=</span> <span class=n>E</span> <span class=o>@</span> <span class=n>V</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># 形状为 (N, 1)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义最小-最大归一化函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>minmax_norm</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-5</span><span class=p>)</span>  <span class=c1># 加上一个小值防止除以零</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对第一主成分进行归一化</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建前景和背景的布尔掩码</span>
</span></span><span class=line><span class=cl><span class=n>M_fg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.6</span>  <span class=c1># 前景掩码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对前景嵌入计算 PCA，并投影到前三个主成分上</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V_fg</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg</span> <span class=o>=</span> <span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>@</span> <span class=n>V_fg</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca3_fg</span><span class=p>)</span>  <span class=c1># 形状为 (N_fg, 3)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建用于绘制的零张量，并填充前景位置</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>N</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>=</span> <span class=n>E_pca3_fg_norm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算 patch 的高度和宽度</span>
</span></span><span class=line><span class=cl><span class=n>H_p</span> <span class=o>=</span> <span class=n>H</span> <span class=o>//</span> <span class=n>PATCH_SIZE</span>
</span></span><span class=line><span class=cl><span class=n>W_p</span> <span class=o>=</span> <span class=n>W</span> <span class=o>//</span> <span class=n>PATCH_SIZE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重塑为 (B, H_p, W_p, 3)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;(B H_p W_p) C -&gt; B H_p W_p C&#34;</span><span class=p>,</span> <span class=n>B</span><span class=o>=</span><span class=n>B</span><span class=p>,</span> <span class=n>H_p</span><span class=o>=</span><span class=n>H_p</span><span class=p>,</span> <span class=n>W_p</span><span class=o>=</span><span class=n>W_p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转换为通道优先格式并调整大小以匹配原始图像尺寸</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;B H_p W_p C -&gt; B C H_p W_p&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw_resized</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>B</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>I_draw_resized</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存生成的图像</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>path</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>image_paths</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>input_filename</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>    <span class=n>output_path</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Path</span><span class=p>(</span><span class=n>output_folder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>Path</span><span class=p>(</span><span class=n>input_filename</span><span class=p>)</span><span class=o>.</span><span class=n>stem</span><span class=si>}</span><span class=s2>_pca</span><span class=si>{</span><span class=n>Path</span><span class=p>(</span><span class=n>input_filename</span><span class=p>)</span><span class=o>.</span><span class=n>suffix</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>save_image</span><span class=p>(</span><span class=n>I_draw_resized</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>cpu</span><span class=p>(),</span> <span class=nb>str</span><span class=p>(</span><span class=n>output_path</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div></details></p><figure class="multi-figure align-center"><div class=multi-figure-container><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1.jpg alt="Image 1"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1_pca.jpg alt="Image 1 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2.jpg alt="Image 2"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2_pca.jpg alt="Image 2 PCA"></figure></div><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3.jpg alt="Image 3"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3_pca.jpg alt="Image 3 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4.jpg alt="Image 4"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4_pca.jpg alt="Image 4 PCA"></figure></div><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5.jpg alt="Image 5"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5_pca.jpg alt="Image 5 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6.jpg alt="Image 6"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6_pca.jpg alt="Image 6 PCA"></figure></div></div><figcaption><p>六张输入图像及其 PCA 可视化</p></figcaption></figure></div><footer class=post-footer><ul class=post-tags><li><a href=https://kenanking.github.io/tags/representation-learning/>Representation Learning</a></li><li><a href=https://kenanking.github.io/tags/visualization/>Visualization</a></li><li><a href=https://kenanking.github.io/tags/pca/>PCA</a></li><li><a href=https://kenanking.github.io/tags/dinov2/>DINOv2</a></li><li><a href=https://kenanking.github.io/tags/dinov3/>DINOv3</a></li></ul><nav class=paginav><a class=prev href=https://kenanking.github.io/posts/2025/01-flappy-bird-dqn/><span class=title>« Prev</span><br><span>强化学习玩 Flappy Bird</span>
</a><a class=next href=https://kenanking.github.io/posts/2024/01-nerf/><span class=title>Next »</span><br><span>基于 NeRF 的三维场景生成</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kenanking.github.io/>Yan Tang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){function e(){var e,t,n,s=document.getElementsByTagName("code");for(n=0;n<s.length;){if(t=s[n],t.parentNode.tagName!=="PRE"&&t.childElementCount===0&&(e=t.textContent,/^\$[^$]/.test(e)&&/[^$]\$$/.test(e)&&(e=e.replace(/^\$/,"\\(").replace(/\$$/,"\\)"),t.textContent=e),/^\\\((.|\s)+\\\)$/.test(e)||/^\\\[(.|\s)+\\\]$/.test(e)||/^\$(.|\s)+\$$/.test(e)||/^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(e))){t.outerHTML=t.innerHTML;continue}n++}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>(function(){var n=window.pageYOffset||document.documentElement.scrollTop||0,s=800,t=!1,e=null;function o(){if(t=!1,e||(e=document.getElementById("top-link")),!e)return;var o=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,i=o>n;n=o<0?0:o,o>s&&!i?(e.style.visibility="visible",e.style.opacity="1"):(e.style.visibility="hidden",e.style.opacity="0")}window.addEventListener("scroll",function(){t||(window.requestAnimationFrame(o),t=!0)},{passive:!0})})()</script><script>(function(){var t=10;function n(e){if(!e)return[0,20];var n,s,o=window.getComputedStyle(e),t=parseFloat(o.lineHeight);return(!t||isNaN(t))&&(t=20),n=e.getBoundingClientRect(),s=n.height||e.offsetHeight||0,[Math.round(s/t),t]}function e(){var e=document.querySelectorAll(".highlight");if(!e||!e.length)return;Array.prototype.forEach.call(e,function(e){if(e.classList.contains("expanded")||e.classList.contains("collapsible"))return;var s,o,a,r,c,l,i=e.querySelector("pre code");if(!i)return;if(r=i.className||"",r.indexOf("language-mermaid")>=0||e.classList.contains("mermaid"))return;if(a=n(i),c=a[0],l=a[1],c<=t)return;e.classList.add("collapsible"),e.style.setProperty("--code-line-height",l+"px"),e.id||(e.id="code-block-"+Math.random().toString(36).slice(2)),o=document.createElement("div"),o.className="code-expand-wrapper",s=document.createElement("button"),s.type="button",s.className="code-expand-link",s.textContent="Show more",s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",e.id),s.addEventListener("click",function(){var n,i,a,o=e.classList.contains("expanded"),r=getComputedStyle(e).getPropertyValue("--code-line-height"),t=parseFloat(r)*(parseFloat(getComputedStyle(e).getPropertyValue("--code-max-lines"))||10);(!isFinite(t)||t<=0)&&(t=10*20),i=e.getBoundingClientRect().height,a=o?t:e.scrollHeight,e.style.maxHeight=i+"px",e.offsetHeight,o?e.classList.remove("expanded"):e.classList.add("expanded"),e.style.maxHeight=a+"px",n=function(t){if(t.propertyName!=="max-height")return;if(e.removeEventListener("transitionend",n),e.style.maxHeight="",e.classList.contains("expanded"))s.textContent="Show less",s.setAttribute("aria-expanded","true");else{s.textContent="Show more",s.setAttribute("aria-expanded","false");try{e.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}}window.dispatchEvent(new Event("resize"))},e.addEventListener("transitionend",n)}),o.appendChild(s),e.nextSibling?e.parentNode.insertBefore(o,e.nextSibling):e.parentNode.appendChild(o)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>