<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>DINOv2 å¯è§†åŒ– ğŸ¦– | Yan Tang</title><meta name=keywords content="representation learning,visualization,PCA,DINOv2,DINOv3"><meta name=description content="ä»‹ç»å¦‚ä½•é€šè¿‡ PCA æ–¹å¼å¯è§†åŒ– DINOv2 æ¨¡å‹çš„å›¾åƒåµŒå…¥è¡¨ç¤ºã€‚"><meta name=author content="Yan Tang"><link rel=canonical href=https://ehehe.cn/posts/2025/02-dino-visualization/><link crossorigin=anonymous href=/assets/css/stylesheet.16688c28815fab2857aba83927b88054dc9027b8a2b37dd2c695d9111db01da3.css integrity="sha256-FmiMKIFfqyhXq6g5J7iAVNyQJ7iis33SxpXZER2wHaM=" rel="preload stylesheet" as=style><link rel=icon href=https://ehehe.cn/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=16x16 href=https://ehehe.cn/assets/images/favicon-16x16.ico><link rel=icon type=image/png sizes=32x32 href=https://ehehe.cn/assets/images/favicon-32x32.ico><link rel=apple-touch-icon href=https://ehehe.cn/assets/images/apple-touch-icon.png><link rel=mask-icon href=https://ehehe.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ehehe.cn/posts/2025/02-dino-visualization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css integrity=sha384-WcoG4HRXMzYzfCgiyfrySxx90XSl2rxY5mnVY5TwtWE6KLrArNKn0T/mOgNL0Mmi crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.js integrity=sha384-J+9dG2KMoiR9hqcFao0IBLwxt6zpcyN68IgwzsCSkbreXUjmNVRhPFTssqdSGjwQ crossorigin=anonymous></script><meta property="og:url" content="https://ehehe.cn/posts/2025/02-dino-visualization/"><meta property="og:site_name" content="Yan Tang"><meta property="og:title" content="DINOv2 å¯è§†åŒ– ğŸ¦–"><meta property="og:description" content="ä»‹ç»å¦‚ä½•é€šè¿‡ PCA æ–¹å¼å¯è§†åŒ– DINOv2 æ¨¡å‹çš„å›¾åƒåµŒå…¥è¡¨ç¤ºã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-09T00:00:00+00:00"><meta property="article:tag" content="Representation Learning"><meta property="article:tag" content="Visualization"><meta property="article:tag" content="PCA"><meta property="article:tag" content="DINOv2"><meta property="article:tag" content="DINOv3"><meta name=twitter:card content="summary"><meta name=twitter:title content="DINOv2 å¯è§†åŒ– ğŸ¦–"><meta name=twitter:description content="ä»‹ç»å¦‚ä½•é€šè¿‡ PCA æ–¹å¼å¯è§†åŒ– DINOv2 æ¨¡å‹çš„å›¾åƒåµŒå…¥è¡¨ç¤ºã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ehehe.cn/posts/"},{"@type":"ListItem","position":2,"name":"DINOv2 å¯è§†åŒ– ğŸ¦–","item":"https://ehehe.cn/posts/2025/02-dino-visualization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"DINOv2 å¯è§†åŒ– ğŸ¦–","name":"DINOv2 å¯è§†åŒ– ğŸ¦–","description":"ä»‹ç»å¦‚ä½•é€šè¿‡ PCA æ–¹å¼å¯è§†åŒ– DINOv2 æ¨¡å‹çš„å›¾åƒåµŒå…¥è¡¨ç¤ºã€‚","keywords":["representation learning","visualization","PCA","DINOv2","DINOv3"],"articleBody":" DINOv2 Sparse Matching\nDINOv2 æœ€ä»¤äººå°è±¡æ·±åˆ»çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å…¶èƒ½å¤ŸåŒ¹é…å›¾åƒä¹‹é—´çš„ åµŒå…¥è¡¨ç¤ºã€‚å¯¹äºæœºå™¨å­¦ä¹ æ¨¡å‹æ¥è¯´ï¼Œä¸¤ä¸ªåµŒå…¥å‘é‡å°±è¶³ä»¥æ¯”è¾ƒä¸¤å¹…å›¾åƒã€‚ä½†å¯¹æˆ‘ä»¬äººç±»è€Œè¨€ï¼Œä»…é ä¸¤ä¸ªæµ®ç‚¹æ•°æ•°ç»„è¿˜ä¸è¶³ä»¥ç›´è§‚ç†è§£ã€‚è¿™æ—¶ï¼Œå¯è§†åŒ–æŠ€æœ¯å°±æ´¾ä¸Šç”¨åœºäº†ã€‚\nä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡ çœ‹ç€ä¸Šé¢çš„å›¾åƒï¼Œæˆ‘ä¸ç¦æƒ³ï¼šè¿™æ€ä¹ˆå¯èƒ½å®ç°å‘¢ï¼Ÿå…¶å®ï¼Œè¿™ç§åŒ¹é…èƒ½åŠ›æ˜¯ç”± å¯¹æ¯”å­¦ä¹  é©±åŠ¨çš„ï¼Œå³é€šè¿‡æ¯”è¾ƒç›¸ä¼¼å’Œä¸ç›¸ä¼¼çš„ç¤ºä¾‹ï¼Œå°†å®ƒä»¬åŒ¹é…åœ¨ä¸€èµ·æˆ–åˆ†å¼€ï¼Œä»è€Œå­¦ä¹ ä¸–ç•Œã€‚\nå¯¹æ¯”å­¦ä¹ èŒƒå¼æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œä½†æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹åªæ˜¯å¦‚ä½• å¯è§†åŒ– è¿™ç§å­¦ä¹ çš„ç»“æœã€‚\nä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿå› ä¸ºåœ¨è®ºæ–‡å’Œä»–ä»¬çš„ä»£ç ä¸­å¹¶ä¸ååˆ†æ¸…æ™°ï¼ˆè¯·æŸ¥çœ‹ è¿™ä¸ª GitHub é—®é¢˜ï¼‰ã€‚æ‰€ä»¥æˆ‘æƒ³ï¼Œä¸€ä¸ªç®€çŸ­çš„æŒ‡å—å¯èƒ½ä¼šå¯¹æœªæ¥çš„ç ”ç©¶è€…ï¼ˆæˆ–è€…æœªæ¥çš„è‡ªå·±ï¼‰æœ‰æ‰€å¸®åŠ©ã€‚\nDINOv2 å¯è§†åŒ– DINOv2 PCA Components\nå¯è§†åŒ–è¿‡ç¨‹åŒ…æ‹¬å››ä¸ªé˜¶æ®µï¼š\næ”¶é›†è¾“å…¥å›¾åƒï¼šæˆ‘ä»¬æ— æ³•ä»…å¯¹å•å¼ å›¾åƒä½¿ç”¨ PCA è¿›è¡Œå¯è§†åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›åŒä¸€ç±»åˆ« / æ ‡ç­¾ / ä¸»é¢˜çš„å›¾åƒç¤ºä¾‹ï¼ˆè¯·æŸ¥çœ‹ä¸Šå›¾çš„ç¬¬ä¸€åˆ—ï¼‰ã€‚ èƒŒæ™¯é˜ˆå€¼å¤„ç†ï¼šèƒŒæ™¯æ˜¯æ‰€æœ‰å›¾åƒçš„å…±åŒç‚¹ï¼Œæ‰€ä»¥åœ¨ä¸€ç»„éšæœºå›¾åƒä¸­ï¼Œå®ƒæ˜¯ PCA çš„æœ€å¼ºåˆ†é‡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å»é™¤å®ƒã€‚ PCA è®¡ç®—ï¼šä¸€æ—¦æˆ‘ä»¬å»é™¤äº†èƒŒæ™¯ï¼Œå°±å¯ä»¥åœ¨æ²¡æœ‰èƒŒæ™¯çš„å›¾åƒä¸Šè®¡ç®— PCA åˆ†é‡ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°é¢œè‰²é€šé“ï¼Œä¾¿äºäººç±»ç†è§£ã€‚ ç»˜åˆ¶ç»“æœï¼šå°†èƒŒæ™¯ç»˜åˆ¶ä¸ºé»‘è‰²ï¼ˆé›¶å€¼ï¼‰ï¼Œå°†å‰æ™¯ä½œä¸ºå…·æœ‰ä¸‰ä¸ªé€šé“çš„åƒç´ ç»˜åˆ¶åˆ°å›¾åƒä¸­ã€‚ åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘å‡è®¾æ‚¨åœ¨å·¥ä½œç›®å½•çš„ä¸€ä¸ªåä¸º images çš„å­æ–‡ä»¶å¤¹ä¸­æœ‰å…­å¼ å›¾åƒï¼š\n1 2 3 4 5 6 7 images â”œâ”€â”€ image_1.jpg â”œâ”€â”€ image_2.jpg â”œâ”€â”€ image_3.jpg â”œâ”€â”€ image_4.jpg â”œâ”€â”€ image_5.jpg â””â”€â”€ image_6.jpg å…­å¼ è¾“å…¥å›¾åƒ\næ”¶é›†è¾“å…¥å›¾åƒ é¦–å…ˆï¼Œæˆ‘ä»¬æ”¶é›†è¾“å…¥å›¾åƒï¼Œå¹¶å°†å®ƒä»¬è¯»å–ä¸ºå…·æœ‰ç›¸åŒé«˜åº¦ HHH å’Œå®½åº¦ WWW çš„å¼ é‡ï¼š\nI1âˆˆRCÃ—HÃ—WI2âˆˆRCÃ—HÃ—W \\begin{aligned} \u0026 I_1 \\in \\mathbb{R}^{C \\times H \\times W} \\\\ \u0026 I_2 \\in \\mathbb{R}^{C \\times H \\times W} \\end{aligned} â€‹I1â€‹âˆˆRCÃ—HÃ—WI2â€‹âˆˆRCÃ—HÃ—Wâ€‹å…¶ä¸­ï¼ŒC=3C=3C=3 ä¸ºé€šé“æ•°ï¼ˆRGBï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import torch from einops import rearrange from torchvision.transforms import Normalize from torchvision.transforms.functional import resize from torchvision.utils import save_image from torchvision.io.image import read_image, ImageReadMode # è¯»å–å›¾åƒå¹¶ç¡®ä¿å®ƒä»¬å…·æœ‰ç›¸åŒçš„å½¢çŠ¶ I1 = read_image(\"images/image_1.png\", ImageReadMode.RGB) I2 = read_image(\"images/image_2.png\", ImageReadMode.RGB) H, W = 672, 672 I1 = resize(I1, (H, W)) I2 = resize(I2, (H, W)) ç„¶åï¼Œæˆ‘ä»¬å°†å®ƒä»¬æ²¿ç€æ‰¹æ¬¡ç»´åº¦å †å ï¼Œå¾—åˆ°æ‰¹é‡å›¾åƒå¼ é‡ IâˆˆRBÃ—CÃ—HÃ—WI \\in \\mathbb{R}^{B \\times C \\times H \\times W}IâˆˆRBÃ—CÃ—HÃ—Wï¼Œå…¶ä¸­ B=2B = 2B=2ï¼š\nI=stack(I1,I2)âˆˆRBÃ—CÃ—HÃ—W I = \\text{stack}(I_1, I_2) \\in \\mathbb{R}^{B \\times C \\times H \\times W} I=stack(I1â€‹,I2â€‹)âˆˆRBÃ—CÃ—HÃ—W 1 I = torch.stack([I1, I2], dim=0) æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ® DINOv2 çš„é¢„å¤„ç† å¯¹å›¾åƒè¿›è¡Œå½’ä¸€åŒ–ã€‚\nIË‰=Normalize(I255) \\bar{I} = \\text{Normalize}\\left(\\frac{I}{255}\\right) IË‰=Normalize(255Iâ€‹) 1 2 3 4 5 6 7 # å¯¹ [0, 1] èŒƒå›´å†…çš„å¼ é‡ä½¿ç”¨çš„å‡å€¼å’Œæ ‡å‡†å·® IMAGENET_DEFAULT_MEAN = (0.485, 0.456, 0.406) IMAGENET_DEFAULT_STD = (0.229, 0.224, 0.225) norm = Normalize(mean=IMAGENET_DEFAULT_MEAN, std=IMAGENET_DEFAULT_STD) I_norm = norm(I / 255) ç°åœ¨ï¼Œæˆ‘ä»¬å°†å½’ä¸€åŒ–åçš„æ‰¹é‡å›¾åƒå¼ é‡è¾“å…¥ DINOv2ï¼Œè·å–å›¾åƒçš„ patch åµŒå…¥è¡¨ç¤ºï¼ˆDINOv2 è¾“å‡º CLS token å’Œ patch tokensï¼Œå¯¹äºå¯è§†åŒ–ï¼Œæˆ‘ä»¬åªå…³æ³¨ patch tokensï¼‰ï¼š\nEpatch=DINOv2(IË‰)âˆˆRBÃ—LÃ—D\\mathbf{E}_{\\text{patch}} = \\text{DINOv2}(\\bar{I}) \\in \\mathbb{R}^{B \\times L \\times D}Epatchâ€‹=DINOv2(IË‰)âˆˆRBÃ—LÃ—Då…¶ä¸­ï¼ŒLLL æ˜¯æ¯å¼ å›¾åƒçš„ patch æ•°é‡ï¼ŒDDD æ˜¯åµŒå…¥ç»´åº¦ã€‚\n1 2 3 dinov2 = torch.hub.load('facebookresearch/dinov2', 'dinov2_vitb14') features = dinov2.forward_features(I_norm) E_patch = features[\"x_norm_patchtokens\"] èƒŒæ™¯é˜ˆå€¼å¤„ç† ä¸€æ—¦æˆ‘ä»¬è·å¾—äº†è¾“å…¥å›¾åƒçš„ patch tokensï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è®¡ç®— PCAï¼ˆä¸»æˆåˆ†åˆ†æï¼‰ä»¥å»é™¤èƒŒæ™¯ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿå› ä¸ºèƒŒæ™¯æ˜¯éšæœºå›¾åƒé›†åˆä¸­å”¯ä¸€çš„å…±åŒç‰¹å¾ã€‚\nå…·ä½“è¿‡ç¨‹å¾ˆç®€å•ï¼šé¦–å…ˆå¯¹å›¾åƒè¿›è¡Œ PCAï¼Œç„¶åé€šè¿‡é˜ˆå€¼åŒ–å»é™¤ç¬¬ä¸€ä¸»æˆåˆ†ã€‚\næˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ patch ç»´åº¦ä¸Šå±•å¹³æ‰¹é‡æ•°æ®ï¼Œä»¥ä¾¿åœ¨åµŒå…¥ç»´åº¦ä¸Šè®¡ç®— PCAã€‚å°† Epatch\\mathbf{E}_{\\text{patch}}Epatchâ€‹ é‡å¡‘ä¸ºå½¢çŠ¶ EâˆˆRNÃ—D\\mathbf{E} \\in \\mathbb{R}^{N \\times D}EâˆˆRNÃ—Dï¼Œå…¶ä¸­ N=BÃ—LN = B \\times LN=BÃ—Lï¼š\nE=reshape(Epatch,(N,D)) \\mathbf{E} = \\text{reshape}\\left(\\mathbf{E}_{\\text{patch}}, (N, D)\\right) E=reshape(Epatchâ€‹,(N,D)) 1 E = rearrange(E_patch, \"B L D -\u003e (B L) D\") ç„¶åï¼Œæˆ‘ä»¬è®¡ç®— E\\mathbf{E}E çš„ç¬¬ä¸€ä¸»æˆåˆ†ï¼Œè¯¥æˆåˆ†ä¸»è¦ä»£è¡¨èƒŒæ™¯ä¿¡æ¯ï¼š\nEpca1=EÃ—v1âˆˆRNÃ—1 \\mathbf{E}_{\\text{pca1}} = \\mathbf{E} \\times \\mathbf{v}_1 \\in \\mathbb{R}^{N \\times 1} Epca1â€‹=EÃ—v1â€‹âˆˆRNÃ—1å…¶ä¸­ï¼Œv1\\mathbf{v}_1v1â€‹ æ˜¯ç¬¬ä¸€ä¸»æˆåˆ†æ–¹å‘ã€‚\n1 2 3 4 # è®¡ç®— PCA _, _, V = torch.pca_lowrank(E) # æŠ•å½±åˆ°ç¬¬ä¸€ä¸»æˆåˆ† E_pca1 = E @ V[:, :1] æ¥ä¸‹æ¥ï¼Œå¯¹ Epca1\\mathbf{E}_{\\text{pca1}}Epca1â€‹ è¿›è¡Œæœ€å° - æœ€å¤§å½’ä¸€åŒ–ï¼Œå°†å€¼æ˜ å°„åˆ° [0,1][0, 1][0,1] èŒƒå›´ï¼š\nEpca1norm=Epca1âˆ’minâ¡(Epca1)maxâ¡(Epca1)âˆ’minâ¡(Epca1) \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} = \\frac{\\mathbf{E}_{\\text{pca1}} - \\min(\\mathbf{E}_{\\text{pca1}})}{\\max(\\mathbf{E}_{\\text{pca1}}) - \\min(\\mathbf{E}_{\\text{pca1}})} Epca1normâ€‹=max(Epca1â€‹)âˆ’min(Epca1â€‹)Epca1â€‹âˆ’min(Epca1â€‹)â€‹ 1 2 3 4 def minmax_norm(x): return (x - x.min()) / (x.max() - x.min()) E_pca1_norm = minmax_norm(E_pca1) é€šè¿‡é˜ˆå€¼ 0.50.50.5ï¼Œå°†å‰æ™¯å’ŒèƒŒæ™¯åˆ†å¼€ï¼Œåˆ›å»ºå¸ƒå°”æ©ç ï¼š\nMfg=Epca1norm\u003e0.5Mbg=Epca1normâ‰¤0.5 \\begin{aligned} M_{\\text{fg}} \u0026= \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} \u003e 0.5 \\\\ M_{\\text{bg}} \u0026= \\mathbf{E}_{\\text{pca1}}^{\\text{norm}} \\leq 0.5 \\end{aligned} Mfgâ€‹Mbgâ€‹â€‹=Epca1normâ€‹\u003e0.5=Epca1normâ€‹â‰¤0.5â€‹ 1 2 M_fg = E_pca1_norm.squeeze() \u003c 0.4 M_bg = E_pca1_norm.squeeze() \u003e= 0.4 å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ† PCA ä½¿ç”¨å‰æ™¯æ©ç  MfgM_{\\text{fg}}Mfgâ€‹ï¼Œæå–å‰æ™¯çš„åµŒå…¥ï¼š\nEfg=E[Mfg,:] \\mathbf{E}_{\\text{fg}} = \\mathbf{E}[M_{\\text{fg}}, :] Efgâ€‹=E[Mfgâ€‹,:]å¯¹å‰æ™¯åµŒå…¥è®¡ç®—åŒ…å«ä¸‰ä¸ªä¸»æˆåˆ†çš„ PCAï¼š\nEpca3=EfgÃ—V3âˆˆRNfgÃ—3 \\mathbf{E}_{\\text{pca3}} = \\mathbf{E}_{\\text{fg}} \\times \\mathbf{V}_3 \\in \\mathbb{R}^{N_{\\text{fg}} \\times 3} Epca3â€‹=Efgâ€‹Ã—V3â€‹âˆˆRNfgâ€‹Ã—3å…¶ä¸­ï¼ŒV3\\mathbf{V}_3V3â€‹ åŒ…å«å‰ä¸‰ä¸ªä¸»æˆåˆ†çš„æ–¹å‘ï¼ŒNfgN_{\\text{fg}}Nfgâ€‹ æ˜¯å‰æ™¯ patch çš„æ•°é‡ã€‚\n1 2 3 4 5 6 # å¯¹å‰æ™¯åµŒå…¥è®¡ç®— PCA _, _, V_fg = torch.pca_lowrank(E[M_fg]) # æŠ•å½±åˆ°å‰ä¸‰ä¸ªä¸»æˆåˆ† E_pca3_fg = E[M_fg] @ V_fg[:, :3] # å½’ä¸€åŒ– E_pca3_fg_norm = minmax_norm(E_pca3_fg) ç»˜åˆ¶å›¾åƒ ç°åœ¨åˆ°äº†å…³é”®æ­¥éª¤ã€‚æˆ‘ä»¬æœ‰ä¸€ç»„è¡¨ç¤ºèƒŒæ™¯çš„ patch tokensï¼Œä»¥åŠä¸€ç»„è¡¨ç¤ºå‰æ™¯çš„ patch tokensã€‚ä¸ºäº†ç»˜åˆ¶å›¾åƒï¼Œæˆ‘ä»¬éœ€è¦ï¼š\nåˆ›å»ºä¸€ä¸ªä¸åŸå§‹ patch å¼ é‡å½¢çŠ¶ç›¸åŒã€å…ƒç´ ä¸ºé›¶çš„æ–°å¼ é‡ å¯¹äºæ¯ä¸ª patch tokenï¼Œå¦‚æœæ˜¯èƒŒæ™¯ï¼Œåˆ™å°†å…¶å€¼è®¾ä¸ºé›¶ï¼ˆé»‘è‰²ï¼‰ï¼›å¦‚æœæ˜¯å‰æ™¯ï¼Œåˆ™ä½¿ç”¨åŒ…å« 3 ä¸ªä¸»æˆåˆ†ï¼ˆå¯¹åº” 3 ä¸ªé¢œè‰²é€šé“ï¼‰çš„å€¼ åˆ›å»ºä¸€ä¸ªä¸åŸå§‹åµŒå…¥å½¢çŠ¶åŒ¹é…çš„é›¶å¼ é‡ IdrawâˆˆRNÃ—3I_{\\text{draw}} \\in \\mathbb{R}^{N \\times 3}Idrawâ€‹âˆˆRNÃ—3ï¼š\nIdraw=0âˆˆRNÃ—3I_{\\text{draw}} = \\mathbf{0} \\in \\mathbb{R}^{N \\times 3}Idrawâ€‹=0âˆˆRNÃ—3å°†å‰æ™¯ä½ç½®å¡«å…¥å¯¹åº”çš„ PCA é¢œè‰²å€¼ï¼š\nIdraw[Mfg,:]=Epca3normI_{\\text{draw}}[M_{\\text{fg}}, :] = \\mathbf{E}_{\\text{pca3}}^{\\text{norm}}Idrawâ€‹[Mfgâ€‹,:]=Epca3normâ€‹ 1 2 I_draw = torch.zeros(N, 3) I_draw[M_fg] = E_pca3_fg_norm å°† IdrawI_{\\text{draw}}Idrawâ€‹ é‡å¡‘å›å›¾åƒçš„ patch ç»´åº¦ï¼š\nIdraw=reshape(Idraw,(B,Hp,Wp,3))I_{\\text{draw}} = \\text{reshape}\\left(I_{\\text{draw}}, (B, H_p, W_p, 3)\\right)Idrawâ€‹=reshape(Idrawâ€‹,(B,Hpâ€‹,Wpâ€‹,3))å…¶ä¸­ï¼ŒHp=H/PH_p = H / PHpâ€‹=H/Pï¼ŒWp=W/PW_p = W / PWpâ€‹=W/Pï¼ŒPPP æ˜¯ patch çš„å¤§å°ã€‚\n1 2 3 4 5 6 7 # è®¡ç®— patch çš„é«˜åº¦å’Œå®½åº¦ patch_size = 14 # å–å†³äºæ¨¡å‹é…ç½® H_p = H // patch_size W_p = W // patch_size # é‡å¡‘ä¸º (B, H_p, W_p, 3) I_draw = rearrange(I_draw, \"(B L) C -\u003e B H_p W_p C\", B=B, H_p=H_p, W_p=W_p) å°†é€šé“ç»´åº¦è°ƒæ•´ä¸ºç¬¬ä¸€ç»´ï¼Œå¹¶è°ƒæ•´å¤§å°ä»¥é€‚åº”åŸå§‹å›¾åƒå°ºå¯¸ï¼š\n1 2 3 4 # è½¬æ¢ä¸ºé€šé“ä¼˜å…ˆæ ¼å¼ I_draw = rearrange(I_draw, \"B H_p W_p C -\u003e B C H_p W_p\") # è°ƒæ•´å¤§å° I_draw = resize(I_draw, (H, W)) ä¿å­˜ç”Ÿæˆçš„å›¾åƒï¼š\n1 2 3 4 # ä¿å­˜å›¾åƒ save_image(I_draw[0], \"images/image_1_pca.png\") save_image(I_draw[1], \"images/image_2_pca.png\") save_image(I_draw[2], \"images/image_3_pca.png\") å®Œæ•´ä»£ç  ä¸ºäº†æ–¹ä¾¿å‚è€ƒï¼Œä»¥ä¸‹æ˜¯æ•´åˆåçš„å®Œæ•´ä»£ç ï¼š\nå®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 import os from pathlib import Path import torch from einops import rearrange from torchvision.io.image import ImageReadMode, read_image from torchvision.transforms import Normalize from torchvision.transforms.functional import resize from torchvision.utils import save_image # è®¾ç½®ç¯å¢ƒé…ç½® torch.hub.set_dir(\"./torch_cache\") device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\") # æ¨¡å‹é…ç½® MODEL_CONFIG = { \"vits14\": {\"name\": \"dinov2_vits14\", \"patch_size\": 14}, \"vitb14\": {\"name\": \"dinov2_vitb14\", \"patch_size\": 14}, \"vitl14\": {\"name\": \"dinov2_vitl14\", \"patch_size\": 14}, \"vitg14\": {\"name\": \"dinov2_vitg14\", \"patch_size\": 14}, \"vits14_reg\": {\"name\": \"dinov2_vits14_reg\", \"patch_size\": 14}, \"vitb14_reg\": {\"name\": \"dinov2_vitb14_reg\", \"patch_size\": 14}, \"vitl14_reg\": {\"name\": \"dinov2_vitl14_reg\", \"patch_size\": 14}, \"vitg14_reg\": {\"name\": \"dinov2_vitg14_reg\", \"patch_size\": 14}, }[\"vitl14\"] MODEL_NAME = MODEL_CONFIG[\"name\"] PATCH_SIZE = MODEL_CONFIG[\"patch_size\"] # è®¾ç½®å›¾åƒè·¯å¾„ image_folder = Path(\"images\") output_folder = Path(\"output\") Path(output_folder).mkdir(parents=True, exist_ok=True) image_paths = [str(p) for p in Path(image_folder).glob(\"*.jpg\")] H, W = 672, 672 images = [] for path in image_paths: img = read_image(path, ImageReadMode.RGB) img = resize(img, (H, W)) images.append(img) # å°†å›¾åƒå †å ä¸ºæ‰¹é‡å¼ é‡ï¼Œå½¢çŠ¶ä¸º (B, C, H, W) I = torch.stack(images, dim=0).to(device) # å¯¹å›¾åƒè¿›è¡Œå½’ä¸€åŒ–å¤„ç† IMAGENET_DEFAULT_MEAN = (0.485, 0.456, 0.406) IMAGENET_DEFAULT_STD = (0.229, 0.224, 0.225) norm = Normalize(mean=IMAGENET_DEFAULT_MEAN, std=IMAGENET_DEFAULT_STD) I_norm = norm(I / 255) # åŠ è½½ DINOv2 æ¨¡å‹å¹¶æå– patch åµŒå…¥ dinov2 = torch.hub.load(\"facebookresearch/dinov2\", MODEL_NAME).to(device) dinov2.eval() with torch.no_grad(): features = dinov2.forward_features(I_norm) E_patch = features[\"x_norm_patchtokens\"] # å½¢çŠ¶ä¸º (B, L, D) E_patch = E_patch.cpu() # å±•å¹³æ‰¹é‡å’Œ patch ç»´åº¦ B, L, D = E_patch.shape N = B * L E = rearrange(E_patch, \"B L D -\u003e (B L) D\") # å½¢çŠ¶ä¸º (N, D) # è®¡ç®—ç¬¬ä¸€ä¸»æˆåˆ†ï¼ˆèƒŒæ™¯ï¼‰ _, _, V = torch.pca_lowrank(E) E_pca1 = E @ V[:, :1] # å½¢çŠ¶ä¸º (N, 1) # å®šä¹‰æœ€å°-æœ€å¤§å½’ä¸€åŒ–å‡½æ•° def minmax_norm(x): return (x - x.min()) / (x.max() - x.min() + 1e-5) # åŠ ä¸Šä¸€ä¸ªå°å€¼é˜²æ­¢é™¤ä»¥é›¶ # å¯¹ç¬¬ä¸€ä¸»æˆåˆ†è¿›è¡Œå½’ä¸€åŒ– E_pca1_norm = minmax_norm(E_pca1) # åˆ›å»ºå‰æ™¯å’ŒèƒŒæ™¯çš„å¸ƒå°”æ©ç  M_fg = E_pca1_norm.squeeze() \u003c 0.6 # å‰æ™¯æ©ç  # å¯¹å‰æ™¯åµŒå…¥è®¡ç®— PCAï¼Œå¹¶æŠ•å½±åˆ°å‰ä¸‰ä¸ªä¸»æˆåˆ†ä¸Š _, _, V_fg = torch.pca_lowrank(E[M_fg]) E_pca3_fg = E[M_fg] @ V_fg[:, :3] E_pca3_fg_norm = minmax_norm(E_pca3_fg) # å½¢çŠ¶ä¸º (N_fg, 3) # åˆ›å»ºç”¨äºç»˜åˆ¶çš„é›¶å¼ é‡ï¼Œå¹¶å¡«å……å‰æ™¯ä½ç½® I_draw = torch.zeros(N, 3) I_draw[M_fg] = E_pca3_fg_norm # è®¡ç®— patch çš„é«˜åº¦å’Œå®½åº¦ H_p = H // PATCH_SIZE W_p = W // PATCH_SIZE # é‡å¡‘ä¸º (B, H_p, W_p, 3) I_draw = rearrange(I_draw, \"(B H_p W_p) C -\u003e B H_p W_p C\", B=B, H_p=H_p, W_p=W_p) # è½¬æ¢ä¸ºé€šé“ä¼˜å…ˆæ ¼å¼å¹¶è°ƒæ•´å¤§å°ä»¥åŒ¹é…åŸå§‹å›¾åƒå°ºå¯¸ I_draw = rearrange(I_draw, \"B H_p W_p C -\u003e B C H_p W_p\") I_draw_resized = torch.zeros(B, 3, H, W) for i in range(B): I_draw_resized[i] = resize(I_draw[i], (H, W)) # ä¿å­˜ç”Ÿæˆçš„å›¾åƒ for i, path in enumerate(image_paths): input_filename = Path(path).name output_path = ( Path(output_folder) / f\"{Path(input_filename).stem}_pca{Path(input_filename).suffix}\" ) save_image(I_draw_resized[i].cpu(), str(output_path)) å…­å¼ è¾“å…¥å›¾åƒåŠå…¶ PCA å¯è§†åŒ–\n","wordCount":"1101","inLanguage":"en","datePublished":"2024-11-09T00:00:00Z","dateModified":"2024-11-09T00:00:00Z","author":{"@type":"Person","name":"Yan Tang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ehehe.cn/posts/2025/02-dino-visualization/"},"publisher":{"@type":"Organization","name":"Yan Tang","logo":{"@type":"ImageObject","url":"https://ehehe.cn/assets/images/favicon-16x16.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://ehehe.cn/ accesskey=h title="Yan Tang (Alt + H)">Yan Tang</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ehehe.cn/ title=Posts><span>Posts</span></a></li><li><a href=https://ehehe.cn/about/ title=About><span>About</span></a></li><li><a href=https://ehehe.cn/publications/ title=Publications><span>Publications</span></a></li><li><a href=https://ehehe.cn/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://ehehe.cn/zotwatch/ title=ZotWatch><span>ZotWatch</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">DINOv2 å¯è§†åŒ– ğŸ¦–</h1><div class=post-meta><span title='2024-11-09 00:00:00 +0000 UTC'>November 9, 2024</span>&nbsp;Â·&nbsp;<span>6 min</span>&nbsp;Â·&nbsp;<span>Yan Tang</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%b8%80%e5%88%87%e5%a7%8b%e4%ba%8e%e4%b8%80%e5%bc%a0%e5%9b%be%e7%89%87 aria-label=ä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡>ä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡</a></li><li><a href=#dinov2-%e5%8f%af%e8%a7%86%e5%8c%96 aria-label="DINOv2 å¯è§†åŒ–">DINOv2 å¯è§†åŒ–</a></li><li><a href=#%e6%94%b6%e9%9b%86%e8%be%93%e5%85%a5%e5%9b%be%e5%83%8f aria-label=æ”¶é›†è¾“å…¥å›¾åƒ>æ”¶é›†è¾“å…¥å›¾åƒ</a></li><li><a href=#%e8%83%8c%e6%99%af%e9%98%88%e5%80%bc%e5%a4%84%e7%90%86 aria-label=èƒŒæ™¯é˜ˆå€¼å¤„ç†>èƒŒæ™¯é˜ˆå€¼å¤„ç†</a></li><li><a href=#%e5%af%b9%e5%89%8d%e6%99%af%e5%b5%8c%e5%85%a5%e8%ae%a1%e7%ae%97%e4%b8%89%e4%b8%bb%e6%88%90%e5%88%86-pca aria-label="å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ† PCA">å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ† PCA</a></li><li><a href=#%e7%bb%98%e5%88%b6%e5%9b%be%e5%83%8f aria-label=ç»˜åˆ¶å›¾åƒ>ç»˜åˆ¶å›¾åƒ</a></li><li><a href=#%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81 aria-label=å®Œæ•´ä»£ç >å®Œæ•´ä»£ç </a></li></ul></div></details></div><div class=post-content><figure><img loading=lazy src=images/dinov2_sparse_matching.jpg alt="DINOv2 Sparse Matching"><figcaption><p>DINOv2 Sparse Matching</p></figcaption></figure><p>DINOv2 æœ€ä»¤äººå°è±¡æ·±åˆ»çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å…¶èƒ½å¤ŸåŒ¹é…å›¾åƒä¹‹é—´çš„ <strong>åµŒå…¥è¡¨ç¤º</strong>ã€‚å¯¹äºæœºå™¨å­¦ä¹ æ¨¡å‹æ¥è¯´ï¼Œä¸¤ä¸ªåµŒå…¥å‘é‡å°±è¶³ä»¥æ¯”è¾ƒä¸¤å¹…å›¾åƒã€‚ä½†å¯¹æˆ‘ä»¬äººç±»è€Œè¨€ï¼Œä»…é ä¸¤ä¸ªæµ®ç‚¹æ•°æ•°ç»„è¿˜ä¸è¶³ä»¥ç›´è§‚ç†è§£ã€‚è¿™æ—¶ï¼Œå¯è§†åŒ–æŠ€æœ¯å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><h2 id=ä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡>ä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡<a hidden class=anchor aria-hidden=true href=#ä¸€åˆ‡å§‹äºä¸€å¼ å›¾ç‰‡>#</a></h2><p>çœ‹ç€ä¸Šé¢çš„å›¾åƒï¼Œæˆ‘ä¸ç¦æƒ³ï¼šè¿™æ€ä¹ˆå¯èƒ½å®ç°å‘¢ï¼Ÿå…¶å®ï¼Œè¿™ç§åŒ¹é…èƒ½åŠ›æ˜¯ç”± <strong>å¯¹æ¯”å­¦ä¹ </strong> é©±åŠ¨çš„ï¼Œå³é€šè¿‡æ¯”è¾ƒç›¸ä¼¼å’Œä¸ç›¸ä¼¼çš„ç¤ºä¾‹ï¼Œå°†å®ƒä»¬åŒ¹é…åœ¨ä¸€èµ·æˆ–åˆ†å¼€ï¼Œä»è€Œå­¦ä¹ ä¸–ç•Œã€‚</p><p>å¯¹æ¯”å­¦ä¹ èŒƒå¼æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œä½†æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹åªæ˜¯å¦‚ä½• <strong>å¯è§†åŒ–</strong> è¿™ç§å­¦ä¹ çš„ç»“æœã€‚</p><p>ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿå› ä¸ºåœ¨è®ºæ–‡å’Œä»–ä»¬çš„ä»£ç ä¸­å¹¶ä¸ååˆ†æ¸…æ™°ï¼ˆè¯·æŸ¥çœ‹ <a href=https://github.com/facebookresearch/dinov2/issues/23>è¿™ä¸ª GitHub é—®é¢˜</a>ï¼‰ã€‚æ‰€ä»¥æˆ‘æƒ³ï¼Œä¸€ä¸ªç®€çŸ­çš„æŒ‡å—å¯èƒ½ä¼šå¯¹æœªæ¥çš„ç ”ç©¶è€…ï¼ˆæˆ–è€…æœªæ¥çš„è‡ªå·±ï¼‰æœ‰æ‰€å¸®åŠ©ã€‚</p><h2 id=dinov2-å¯è§†åŒ–>DINOv2 å¯è§†åŒ–<a hidden class=anchor aria-hidden=true href=#dinov2-å¯è§†åŒ–>#</a></h2><figure><img loading=lazy src=images/dinov2_visualization_of_the_first_PCA_components.jpg alt="DINOv2 PCA Components"><figcaption><p>DINOv2 PCA Components</p></figcaption></figure><p>å¯è§†åŒ–è¿‡ç¨‹åŒ…æ‹¬å››ä¸ªé˜¶æ®µï¼š</p><ul><li><strong>æ”¶é›†è¾“å…¥å›¾åƒ</strong>ï¼šæˆ‘ä»¬æ— æ³•ä»…å¯¹å•å¼ å›¾åƒä½¿ç”¨ PCA è¿›è¡Œå¯è§†åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›åŒä¸€ç±»åˆ« / æ ‡ç­¾ / ä¸»é¢˜çš„å›¾åƒç¤ºä¾‹ï¼ˆè¯·æŸ¥çœ‹ä¸Šå›¾çš„ç¬¬ä¸€åˆ—ï¼‰ã€‚</li><li><strong>èƒŒæ™¯é˜ˆå€¼å¤„ç†</strong>ï¼šèƒŒæ™¯æ˜¯æ‰€æœ‰å›¾åƒçš„å…±åŒç‚¹ï¼Œæ‰€ä»¥åœ¨ä¸€ç»„éšæœºå›¾åƒä¸­ï¼Œå®ƒæ˜¯ PCA çš„æœ€å¼ºåˆ†é‡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å»é™¤å®ƒã€‚</li><li><strong>PCA è®¡ç®—</strong>ï¼šä¸€æ—¦æˆ‘ä»¬å»é™¤äº†èƒŒæ™¯ï¼Œå°±å¯ä»¥åœ¨æ²¡æœ‰èƒŒæ™¯çš„å›¾åƒä¸Šè®¡ç®— PCA åˆ†é‡ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°é¢œè‰²é€šé“ï¼Œä¾¿äºäººç±»ç†è§£ã€‚</li><li><strong>ç»˜åˆ¶ç»“æœ</strong>ï¼šå°†èƒŒæ™¯ç»˜åˆ¶ä¸ºé»‘è‰²ï¼ˆé›¶å€¼ï¼‰ï¼Œå°†å‰æ™¯ä½œä¸ºå…·æœ‰ä¸‰ä¸ªé€šé“çš„åƒç´ ç»˜åˆ¶åˆ°å›¾åƒä¸­ã€‚</li></ul><p>åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘å‡è®¾æ‚¨åœ¨å·¥ä½œç›®å½•çš„ä¸€ä¸ªåä¸º <code>images</code> çš„å­æ–‡ä»¶å¤¹ä¸­æœ‰å…­å¼ å›¾åƒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>images 
</span></span><span class=line><span class=cl>â”œâ”€â”€ image_1.jpg
</span></span><span class=line><span class=cl>â”œâ”€â”€ image_2.jpg
</span></span><span class=line><span class=cl>â”œâ”€â”€ image_3.jpg
</span></span><span class=line><span class=cl>â”œâ”€â”€ image_4.jpg
</span></span><span class=line><span class=cl>â”œâ”€â”€ image_5.jpg
</span></span><span class=line><span class=cl>â””â”€â”€ image_6.jpg
</span></span></code></pre></td></tr></table></div></div><figure class="multi-figure align-center"><div class=multi-figure-container><div class=multi-figure-row data-images=3><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1.jpg alt="Image 1"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2.jpg alt="Image 2"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3.jpg alt="Image 3"></figure></div><div class=multi-figure-row data-images=3><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4.jpg alt="Image 4"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5.jpg alt="Image 5"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6.jpg alt="Image 6"></figure></div></div><figcaption><p>å…­å¼ è¾“å…¥å›¾åƒ</p></figcaption></figure><h2 id=æ”¶é›†è¾“å…¥å›¾åƒ>æ”¶é›†è¾“å…¥å›¾åƒ<a hidden class=anchor aria-hidden=true href=#æ”¶é›†è¾“å…¥å›¾åƒ>#</a></h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ”¶é›†è¾“å…¥å›¾åƒï¼Œå¹¶å°†å®ƒä»¬è¯»å–ä¸ºå…·æœ‰ç›¸åŒé«˜åº¦ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.08125em>H</span></span></span></span> å’Œå®½åº¦ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>W</span></span></span></span> çš„å¼ é‡ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>I</mi><mn>1</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>C</mi><mo>Ã—</mo><mi>H</mi><mo>Ã—</mo><mi>W</mi></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>I</mi><mn>2</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>C</mi><mo>Ã—</mo><mi>H</mi><mo>Ã—</mo><mi>W</mi></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp; I_1 \in \mathbb{R}^{C \times H \times W} \\
&amp; I_2 \in \mathbb{R}^{C \times H \times W}
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.1027em;vertical-align:-1.3013em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8013em><span style=top:-3.8013em><span class=pstrut style=height:2.8913em></span><span class=mord></span></span><span style=top:-2.25em><span class=pstrut style=height:2.8913em></span><span class=mord></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:1.3013em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.8013em><span style=top:-3.91em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span><span style=top:-2.3587em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:1.3013em><span></span></span></span></span></span></span></span></span></span></span></span><p>å…¶ä¸­ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">C=3</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07153em>C</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>3</span></span></span></span> ä¸ºé€šé“æ•°ï¼ˆRGBï¼‰ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>einops</span> <span class=kn>import</span> <span class=n>rearrange</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms</span> <span class=kn>import</span> <span class=n>Normalize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms.functional</span> <span class=kn>import</span> <span class=n>resize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.utils</span> <span class=kn>import</span> <span class=n>save_image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.io.image</span> <span class=kn>import</span> <span class=n>read_image</span><span class=p>,</span> <span class=n>ImageReadMode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¯»å–å›¾åƒå¹¶ç¡®ä¿å®ƒä»¬å…·æœ‰ç›¸åŒçš„å½¢çŠ¶</span>
</span></span><span class=line><span class=cl><span class=n>I1</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=s2>&#34;images/image_1.png&#34;</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I2</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=s2>&#34;images/image_2.png&#34;</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>H</span><span class=p>,</span> <span class=n>W</span> <span class=o>=</span> <span class=mi>672</span><span class=p>,</span> <span class=mi>672</span>
</span></span><span class=line><span class=cl><span class=n>I1</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I1</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>I2</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I2</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åï¼Œæˆ‘ä»¬å°†å®ƒä»¬æ²¿ç€æ‰¹æ¬¡ç»´åº¦å †å ï¼Œå¾—åˆ°æ‰¹é‡å›¾åƒå¼ é‡ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>Ã—</mo><mi>C</mi><mo>Ã—</mo><mi>H</mi><mo>Ã—</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">I \in \mathbb{R}^{B \times C \times H \times W}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7224em;vertical-align:-.0391em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span>ï¼Œå…¶ä¸­ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">B = 2</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6444em></span><span class=mord>2</span></span></span></span>ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mo>=</mo><mtext>stack</mtext><mo stretchy="false">(</mo><msub><mi>I</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>I</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>Ã—</mo><mi>C</mi><mo>Ã—</mo><mi>H</mi><mo>Ã—</mo><mi>W</mi></mrow></msup></mrow><annotation encoding="application/x-tex">
I = \text{stack}(I_1, I_2) \in \mathbb{R}^{B \times C \times H \times W}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord text"><span class=mord>stack</span></span><span class=mopen>(</span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.07153em>C</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.08125em>H</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.13889em>W</span></span></span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>I1</span><span class=p>,</span> <span class=n>I2</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ® <a href=https://github.com/facebookresearch/dinov2/blob/main/dinov2/data/transforms.py#L42-L50>DINOv2 çš„é¢„å¤„ç†</a> å¯¹å›¾åƒè¿›è¡Œå½’ä¸€åŒ–ã€‚</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>I</mi><mo>Ë‰</mo></mover><mo>=</mo><mtext>Normalize</mtext><mrow><mo fence="true">(</mo><mfrac><mi>I</mi><mn>255</mn></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\bar{I} = \text{Normalize}\left(\frac{I}{255}\right)
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8201em></span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8201em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span></span><span style=top:-3.2523em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1389em><span class=mord>Ë‰</span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.4em;vertical-align:-.95em></span><span class="mord text"><span class=mord>Normalize</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0><span class="delimsizing size3">(</span></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.3603em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mord>255</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.686em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style=top:0><span class="delimsizing size3">)</span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># å¯¹ [0, 1] èŒƒå›´å†…çš„å¼ é‡ä½¿ç”¨çš„å‡å€¼å’Œæ ‡å‡†å·®</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_MEAN</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_STD</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_MEAN</span><span class=p>,</span> <span class=n>std</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_STD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>I_norm</span> <span class=o>=</span> <span class=n>norm</span><span class=p>(</span><span class=n>I</span> <span class=o>/</span> <span class=mi>255</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†å½’ä¸€åŒ–åçš„æ‰¹é‡å›¾åƒå¼ é‡è¾“å…¥ DINOv2ï¼Œè·å–å›¾åƒçš„ patch åµŒå…¥è¡¨ç¤ºï¼ˆDINOv2 è¾“å‡º CLS token å’Œ patch tokensï¼Œå¯¹äºå¯è§†åŒ–ï¼Œæˆ‘ä»¬åªå…³æ³¨ patch tokensï¼‰ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub><mo>=</mo><mtext>DINOv2</mtext><mo stretchy="false">(</mo><mover accent="true"><mi>I</mi><mo>Ë‰</mo></mover><mo stretchy="false">)</mo><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>Ã—</mo><mi>L</mi><mo>Ã—</mo><mi>D</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{patch}} = \text{DINOv2}(\bar{I}) \in \mathbb{R}^{B \times L \times D}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0701em;vertical-align:-.25em></span><span class="mord text"><span class=mord>DINOv2</span></span><span class=mopen>(</span><span class="mord accent"><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8201em><span style=top:-3em><span class=pstrut style=height:3em></span><span class="mord mathnormal" style=margin-right:.07847em>I</span></span><span style=top:-3.2523em><span class=pstrut style=height:3em></span><span class=accent-body style=left:-.1389em><span class=mord>Ë‰</span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.05017em>B</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">L</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.02778em>D</span></span></span></span></span></span></span></span></span></span></span></span></span><p>å…¶ä¸­ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span></span></span></span> æ˜¯æ¯å¼ å›¾åƒçš„ patch æ•°é‡ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.02778em>D</span></span></span></span> æ˜¯åµŒå…¥ç»´åº¦ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dinov2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>&#39;facebookresearch/dinov2&#39;</span><span class=p>,</span> <span class=s1>&#39;dinov2_vitb14&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>features</span> <span class=o>=</span> <span class=n>dinov2</span><span class=o>.</span><span class=n>forward_features</span><span class=p>(</span><span class=n>I_norm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>features</span><span class=p>[</span><span class=s2>&#34;x_norm_patchtokens&#34;</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=èƒŒæ™¯é˜ˆå€¼å¤„ç†>èƒŒæ™¯é˜ˆå€¼å¤„ç†<a hidden class=anchor aria-hidden=true href=#èƒŒæ™¯é˜ˆå€¼å¤„ç†>#</a></h2><p>ä¸€æ—¦æˆ‘ä»¬è·å¾—äº†è¾“å…¥å›¾åƒçš„ patch tokensï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è®¡ç®— PCAï¼ˆä¸»æˆåˆ†åˆ†æï¼‰ä»¥å»é™¤èƒŒæ™¯ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿå› ä¸ºèƒŒæ™¯æ˜¯éšæœºå›¾åƒé›†åˆä¸­å”¯ä¸€çš„å…±åŒç‰¹å¾ã€‚</p><p>å…·ä½“è¿‡ç¨‹å¾ˆç®€å•ï¼šé¦–å…ˆå¯¹å›¾åƒè¿›è¡Œ PCAï¼Œç„¶åé€šè¿‡é˜ˆå€¼åŒ–å»é™¤ç¬¬ä¸€ä¸»æˆåˆ†ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ patch ç»´åº¦ä¸Šå±•å¹³æ‰¹é‡æ•°æ®ï¼Œä»¥ä¾¿åœ¨åµŒå…¥ç»´åº¦ä¸Šè®¡ç®— PCAã€‚å°† <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{patch}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> é‡å¡‘ä¸ºå½¢çŠ¶ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">E</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>Ã—</mo><mi>D</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{E} \in \mathbb{R}^{N \times D}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.7252em;vertical-align:-.0391em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style=margin-right:.02778em>D</span></span></span></span></span></span></span></span></span></span></span></span>ï¼Œå…¶ä¸­ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>B</mi><mo>Ã—</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">N = B \times L</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7667em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>Ã—</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal">L</span></span></span></span>ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">E</mi><mo>=</mo><mtext>reshape</mtext><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">E</mi><mtext>patch</mtext></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\mathbf{E} = \text{reshape}\left(\mathbf{E}_{\text{patch}}, (N, D)\right)
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord text"><span class=mord>reshape</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">patch</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class="mord mathnormal" style=margin-right:.02778em>D</span><span class=mclose>)</span><span class="mclose delimcenter" style=top:0>)</span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>E</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>E_patch</span><span class=p>,</span> <span class=s2>&#34;B L D -&gt; (B L) D&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ç„¶åï¼Œæˆ‘ä»¬è®¡ç®— <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">E</mi></mrow><annotation encoding="application/x-tex">\mathbf{E}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6861em></span><span class="mord mathbf">E</span></span></span></span> çš„ç¬¬ä¸€ä¸»æˆåˆ†ï¼Œè¯¥æˆåˆ†ä¸»è¦ä»£è¡¨èƒŒæ™¯ä¿¡æ¯ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo>=</mo><mi mathvariant="bold">E</mi><mo>Ã—</mo><msub><mi mathvariant="bold">v</mi><mn>1</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>Ã—</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca1}} = \mathbf{E} \times \mathbf{v}_1 \in \mathbb{R}^{N \times 1}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7694em;vertical-align:-.0833em></span><span class="mord mathbf">E</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>Ã—</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6891em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span><p>å…¶ä¸­ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{v}_1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.5944em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> æ˜¯ç¬¬ä¸€ä¸»æˆåˆ†æ–¹å‘ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è®¡ç®— PCA</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># æŠ•å½±åˆ°ç¬¬ä¸€ä¸»æˆåˆ†</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1</span> <span class=o>=</span> <span class=n>E</span> <span class=o>@</span> <span class=n>V</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>1</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥ï¼Œå¯¹ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub></mrow><annotation encoding="application/x-tex">\mathbf{E}_{\text{pca1}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> è¿›è¡Œæœ€å° - æœ€å¤§å½’ä¸€åŒ–ï¼Œå°†å€¼æ˜ å°„åˆ° <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>[</span><span class=mord>0</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord>1</span><span class=mclose>]</span></span></span></span> èŒƒå›´ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>=</mo><mfrac><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo>âˆ’</mo><mi>min</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo></mrow><mrow><mi>max</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo><mo>âˆ’</mo><mi>min</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">E</mi><mtext>pca1</mtext></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca1}}^{\text{norm}} = \frac{\mathbf{E}_{\text{pca1}} - \min(\mathbf{E}_{\text{pca1}})}{\max(\mathbf{E}_{\text{pca1}}) - \min(\mathbf{E}_{\text{pca1}})}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0975em;vertical-align:-.3831em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:2.3991em;vertical-align:-.9721em></span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.427em><span style=top:-2.314em><span class=pstrut style=height:3em></span><span class=mord><span class=mop>max</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>âˆ’</span><span class=mspace style=margin-right:.2222em></span><span class=mop>min</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span><span style=top:-3.23em><span class=pstrut style=height:3em></span><span class=frac-line style=border-bottom-width:.04em></span></span><span style=top:-3.677em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>âˆ’</span><span class=mspace style=margin-right:.2222em></span><span class=mop>min</span><span class=mopen>(</span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mclose>)</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.9721em><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>minmax_norm</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>E_pca1_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>é€šè¿‡é˜ˆå€¼ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.5</mn></mrow><annotation encoding="application/x-tex">0.5</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6444em></span><span class=mord>0.5</span></span></span></span>ï¼Œå°†å‰æ™¯å’ŒèƒŒæ™¯åˆ†å¼€ï¼Œåˆ›å»ºå¸ƒå°”æ©ç ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>M</mi><mtext>fg</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>&gt;</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>M</mi><mtext>bg</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca1</mtext><mtext>norm</mtext></msubsup><mo>â‰¤</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
M_{\text{fg}} &amp;= \mathbf{E}_{\text{pca1}}^{\text{norm}} &gt; 0.5 \\
M_{\text{bg}} &amp;= \mathbf{E}_{\text{pca1}}^{\text{norm}} \leq 0.5
\end{aligned}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:3.0462em;vertical-align:-1.2731em></span><span class=mord><span class=mtable><span class=col-align-r><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7731em><span style=top:-3.9331em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:1.2731em><span></span></span></span></span></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:1.7731em><span style=top:-3.9331em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>></span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.5</span></span></span><span style=top:-2.41em><span class=pstrut style=height:3em></span><span class=mord><span class=mord></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca1</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>â‰¤</span><span class=mspace style=margin-right:.2778em></span><span class=mord>0.5</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:1.2731em><span></span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>M_fg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl><span class=n>M_bg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=mf>0.4</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ†-pca>å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ† PCA<a hidden class=anchor aria-hidden=true href=#å¯¹å‰æ™¯åµŒå…¥è®¡ç®—ä¸‰ä¸»æˆåˆ†-pca>#</a></h2><p>ä½¿ç”¨å‰æ™¯æ©ç  <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mtext>fg</mtext></msub></mrow><annotation encoding="application/x-tex">M_{\text{fg}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span>ï¼Œæå–å‰æ™¯çš„åµŒå…¥ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>fg</mtext></msub><mo>=</mo><mi mathvariant="bold">E</mi><mo stretchy="false">[</mo><msub><mi>M</mi><mtext>fg</mtext></msub><mo separator="true">,</mo><mo>:</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{fg}} = \mathbf{E}[M_{\text{fg}}, :]
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord mathbf">E</span><span class=mopen>[</span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mclose>]</span></span></span></span></span><p>å¯¹å‰æ™¯åµŒå…¥è®¡ç®—åŒ…å«ä¸‰ä¸ªä¸»æˆåˆ†çš„ PCAï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">E</mi><mtext>pca3</mtext></msub><mo>=</mo><msub><mi mathvariant="bold">E</mi><mtext>fg</mtext></msub><mo>Ã—</mo><msub><mi mathvariant="bold">V</mi><mn>3</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>N</mi><mtext>fg</mtext></msub><mo>Ã—</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">
\mathbf{E}_{\text{pca3}} = \mathbf{E}_{\text{fg}} \times \mathbf{V}_3 \in \mathbb{R}^{N_{\text{fg}} \times 3}
</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca3</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.9722em;vertical-align:-.2861em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222em></span><span class=mbin>Ã—</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8361em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3448em><span style=top:-2.3488em;margin-left:-.109em;margin-right:.0714em><span class=pstrut style=height:2.5em></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2901em><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span><p>å…¶ä¸­ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{V}_3</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8361em;vertical-align:-.15em></span><span class=mord><span class="mord mathbf" style=margin-right:.01597em>V</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3011em><span style=top:-2.55em;margin-left:-.016em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> åŒ…å«å‰ä¸‰ä¸ªä¸»æˆåˆ†çš„æ–¹å‘ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mtext>fg</mtext></msub></mrow><annotation encoding="application/x-tex">N_{\text{fg}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>N</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span></span></span></span> æ˜¯å‰æ™¯ patch çš„æ•°é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># å¯¹å‰æ™¯åµŒå…¥è®¡ç®— PCA</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V_fg</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># æŠ•å½±åˆ°å‰ä¸‰ä¸ªä¸»æˆåˆ†</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg</span> <span class=o>=</span> <span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>@</span> <span class=n>V_fg</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># å½’ä¸€åŒ–</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca3_fg</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=ç»˜åˆ¶å›¾åƒ>ç»˜åˆ¶å›¾åƒ<a hidden class=anchor aria-hidden=true href=#ç»˜åˆ¶å›¾åƒ>#</a></h2><p>ç°åœ¨åˆ°äº†å…³é”®æ­¥éª¤ã€‚æˆ‘ä»¬æœ‰ä¸€ç»„è¡¨ç¤ºèƒŒæ™¯çš„ patch tokensï¼Œä»¥åŠä¸€ç»„è¡¨ç¤ºå‰æ™¯çš„ patch tokensã€‚ä¸ºäº†ç»˜åˆ¶å›¾åƒï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªä¸åŸå§‹ patch å¼ é‡å½¢çŠ¶ç›¸åŒã€å…ƒç´ ä¸ºé›¶çš„æ–°å¼ é‡</li><li>å¯¹äºæ¯ä¸ª patch tokenï¼Œå¦‚æœæ˜¯èƒŒæ™¯ï¼Œåˆ™å°†å…¶å€¼è®¾ä¸ºé›¶ï¼ˆé»‘è‰²ï¼‰ï¼›å¦‚æœæ˜¯å‰æ™¯ï¼Œåˆ™ä½¿ç”¨åŒ…å« 3 ä¸ªä¸»æˆåˆ†ï¼ˆå¯¹åº” 3 ä¸ªé¢œè‰²é€šé“ï¼‰çš„å€¼</li></ul><p>åˆ›å»ºä¸€ä¸ªä¸åŸå§‹åµŒå…¥å½¢çŠ¶åŒ¹é…çš„é›¶å¼ é‡ <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>Ã—</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">I_{\text{draw}} \in \mathbb{R}^{N \times 3}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8413em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8413em><span style=top:-3.063em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">Ã—</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span>ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>=</mo><mn mathvariant="bold">0</mn><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>Ã—</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">I_{\text{draw}} = \mathbf{0} \in \mathbb{R}^{N \times 3}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6835em;vertical-align:-.0391em></span><span class="mord mathbf">0</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>âˆˆ</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8913em></span><span class=mord><span class="mord mathbb">R</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8913em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style=margin-right:.10903em>N</span><span class="mbin mtight">Ã—</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span><p>å°†å‰æ™¯ä½ç½®å¡«å…¥å¯¹åº”çš„ PCA é¢œè‰²å€¼ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo stretchy="false">[</mo><msub><mi>M</mi><mtext>fg</mtext></msub><mo separator="true">,</mo><mo>:</mo><mo stretchy="false">]</mo><mo>=</mo><msubsup><mi mathvariant="bold">E</mi><mtext>pca3</mtext><mtext>norm</mtext></msubsup></mrow><annotation encoding="application/x-tex">I_{\text{draw}}[M_{\text{fg}}, :] = \mathbf{E}_{\text{pca3}}^{\text{norm}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mopen>[</span><span class=mord><span class="mord mathnormal" style=margin-right:.10903em>M</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.109em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">fg</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>:</span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mclose>]</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0975em;vertical-align:-.3831em></span><span class=mord><span class="mord mathbf">E</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.7144em><span style=top:-2.453em;margin-left:0;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">pca3</span></span></span></span></span><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">norm</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.3831em><span></span></span></span></span></span></span></span></span></span></span><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>N</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>=</span> <span class=n>E_pca3_fg_norm</span>
</span></span></code></pre></td></tr></table></div></div><p>å°† <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub></mrow><annotation encoding="application/x-tex">I_{\text{draw}}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span></span></span></span> é‡å¡‘å›å›¾åƒçš„ patch ç»´åº¦ï¼š</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mtext>draw</mtext></msub><mo>=</mo><mtext>reshape</mtext><mrow><mo fence="true">(</mo><msub><mi>I</mi><mtext>draw</mtext></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mi>B</mi><mo separator="true">,</mo><msub><mi>H</mi><mi>p</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>p</mi></msub><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">I_{\text{draw}} = \text{reshape}\left(I_{\text{draw}}, (B, H_p, W_p, 3)\right)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1.0361em;vertical-align:-.2861em></span><span class="mord text"><span class=mord>reshape</span></span><span class=mspace style=margin-right:.1667em></span><span class=minner><span class="mopen delimcenter" style=top:0>(</span><span class=mord><span class="mord mathnormal" style=margin-right:.07847em>I</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.0785em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">draw</span></span></span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.05017em>B</span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mpunct>,</span><span class=mspace style=margin-right:.1667em></span><span class=mord>3</span><span class=mclose>)</span><span class="mclose delimcenter" style=top:0>)</span></span></span></span></span></span><p>å…¶ä¸­ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>p</mi></msub><mo>=</mo><mi>H</mi><mi mathvariant="normal">/</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">H_p = H / P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0813em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.08125em>H</span><span class=mord>/</span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span>ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>p</mi></msub><mo>=</mo><mi>W</mi><mi mathvariant="normal">/</mi><mi>P</mi></mrow><annotation encoding="application/x-tex">W_p = W / P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class=vlist-s>â€‹</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal" style=margin-right:.13889em>W</span><span class=mord>/</span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span>ï¼Œ<span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.6833em></span><span class="mord mathnormal" style=margin-right:.13889em>P</span></span></span></span> æ˜¯ patch çš„å¤§å°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è®¡ç®— patch çš„é«˜åº¦å’Œå®½åº¦</span>
</span></span><span class=line><span class=cl><span class=n>patch_size</span> <span class=o>=</span> <span class=mi>14</span>  <span class=c1># å–å†³äºæ¨¡å‹é…ç½®</span>
</span></span><span class=line><span class=cl><span class=n>H_p</span> <span class=o>=</span> <span class=n>H</span> <span class=o>//</span> <span class=n>patch_size</span>
</span></span><span class=line><span class=cl><span class=n>W_p</span> <span class=o>=</span> <span class=n>W</span> <span class=o>//</span> <span class=n>patch_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é‡å¡‘ä¸º (B, H_p, W_p, 3)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;(B L) C -&gt; B H_p W_p C&#34;</span><span class=p>,</span> <span class=n>B</span><span class=o>=</span><span class=n>B</span><span class=p>,</span> <span class=n>H_p</span><span class=o>=</span><span class=n>H_p</span><span class=p>,</span> <span class=n>W_p</span><span class=o>=</span><span class=n>W_p</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>å°†é€šé“ç»´åº¦è°ƒæ•´ä¸ºç¬¬ä¸€ç»´ï¼Œå¹¶è°ƒæ•´å¤§å°ä»¥é€‚åº”åŸå§‹å›¾åƒå°ºå¯¸ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è½¬æ¢ä¸ºé€šé“ä¼˜å…ˆæ ¼å¼</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;B H_p W_p C -&gt; B C H_p W_p&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è°ƒæ•´å¤§å°</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¿å­˜ç”Ÿæˆçš„å›¾åƒï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ä¿å­˜å›¾åƒ</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s2>&#34;images/image_1_pca.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=s2>&#34;images/image_2_pca.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>save_image</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=s2>&#34;images/image_3_pca.png&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=å®Œæ•´ä»£ç >å®Œæ•´ä»£ç <a hidden class=anchor aria-hidden=true href=#å®Œæ•´ä»£ç >#</a></h2><p>ä¸ºäº†æ–¹ä¾¿å‚è€ƒï¼Œä»¥ä¸‹æ˜¯æ•´åˆåçš„å®Œæ•´ä»£ç ï¼š</p><p><details><summary markdown=span>å®Œæ•´ä»£ç </summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>einops</span> <span class=kn>import</span> <span class=n>rearrange</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.io.image</span> <span class=kn>import</span> <span class=n>ImageReadMode</span><span class=p>,</span> <span class=n>read_image</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms</span> <span class=kn>import</span> <span class=n>Normalize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.transforms.functional</span> <span class=kn>import</span> <span class=n>resize</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.utils</span> <span class=kn>import</span> <span class=n>save_image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®ç¯å¢ƒé…ç½®</span>
</span></span><span class=line><span class=cl><span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>set_dir</span><span class=p>(</span><span class=s2>&#34;./torch_cache&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>device</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&#34;cuda&#34;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s2>&#34;cpu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨¡å‹é…ç½®</span>
</span></span><span class=line><span class=cl><span class=n>MODEL_CONFIG</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vits14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vits14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitb14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitb14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitl14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitl14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitg14&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitg14&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vits14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vits14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitb14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitb14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitl14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitl14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;vitg14_reg&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;dinov2_vitg14_reg&#34;</span><span class=p>,</span> <span class=s2>&#34;patch_size&#34;</span><span class=p>:</span> <span class=mi>14</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}[</span><span class=s2>&#34;vitl14&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>MODEL_NAME</span> <span class=o>=</span> <span class=n>MODEL_CONFIG</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>PATCH_SIZE</span> <span class=o>=</span> <span class=n>MODEL_CONFIG</span><span class=p>[</span><span class=s2>&#34;patch_size&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®å›¾åƒè·¯å¾„</span>
</span></span><span class=line><span class=cl><span class=n>image_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;images&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>output_folder</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&#34;output&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Path</span><span class=p>(</span><span class=n>output_folder</span><span class=p>)</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>image_paths</span> <span class=o>=</span> <span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>Path</span><span class=p>(</span><span class=n>image_folder</span><span class=p>)</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;*.jpg&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>H</span><span class=p>,</span> <span class=n>W</span> <span class=o>=</span> <span class=mi>672</span><span class=p>,</span> <span class=mi>672</span>
</span></span><span class=line><span class=cl><span class=n>images</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>image_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>read_image</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>ImageReadMode</span><span class=o>.</span><span class=n>RGB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>img</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>images</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>img</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°†å›¾åƒå †å ä¸ºæ‰¹é‡å¼ é‡ï¼Œå½¢çŠ¶ä¸º (B, C, H, W)</span>
</span></span><span class=line><span class=cl><span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯¹å›¾åƒè¿›è¡Œå½’ä¸€åŒ–å¤„ç†</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_MEAN</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>IMAGENET_DEFAULT_STD</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_MEAN</span><span class=p>,</span> <span class=n>std</span><span class=o>=</span><span class=n>IMAGENET_DEFAULT_STD</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_norm</span> <span class=o>=</span> <span class=n>norm</span><span class=p>(</span><span class=n>I</span> <span class=o>/</span> <span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åŠ è½½ DINOv2 æ¨¡å‹å¹¶æå– patch åµŒå…¥</span>
</span></span><span class=line><span class=cl><span class=n>dinov2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>hub</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;facebookresearch/dinov2&#34;</span><span class=p>,</span> <span class=n>MODEL_NAME</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dinov2</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>features</span> <span class=o>=</span> <span class=n>dinov2</span><span class=o>.</span><span class=n>forward_features</span><span class=p>(</span><span class=n>I_norm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>features</span><span class=p>[</span><span class=s2>&#34;x_norm_patchtokens&#34;</span><span class=p>]</span>  <span class=c1># å½¢çŠ¶ä¸º (B, L, D)</span>
</span></span><span class=line><span class=cl><span class=n>E_patch</span> <span class=o>=</span> <span class=n>E_patch</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å±•å¹³æ‰¹é‡å’Œ patch ç»´åº¦</span>
</span></span><span class=line><span class=cl><span class=n>B</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>D</span> <span class=o>=</span> <span class=n>E_patch</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl><span class=n>N</span> <span class=o>=</span> <span class=n>B</span> <span class=o>*</span> <span class=n>L</span>
</span></span><span class=line><span class=cl><span class=n>E</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>E_patch</span><span class=p>,</span> <span class=s2>&#34;B L D -&gt; (B L) D&#34;</span><span class=p>)</span>  <span class=c1># å½¢çŠ¶ä¸º (N, D)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¡ç®—ç¬¬ä¸€ä¸»æˆåˆ†ï¼ˆèƒŒæ™¯ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1</span> <span class=o>=</span> <span class=n>E</span> <span class=o>@</span> <span class=n>V</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># å½¢çŠ¶ä¸º (N, 1)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®šä¹‰æœ€å°-æœ€å¤§å½’ä¸€åŒ–å‡½æ•°</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>minmax_norm</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>min</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1e-5</span><span class=p>)</span>  <span class=c1># åŠ ä¸Šä¸€ä¸ªå°å€¼é˜²æ­¢é™¤ä»¥é›¶</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯¹ç¬¬ä¸€ä¸»æˆåˆ†è¿›è¡Œå½’ä¸€åŒ–</span>
</span></span><span class=line><span class=cl><span class=n>E_pca1_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºå‰æ™¯å’ŒèƒŒæ™¯çš„å¸ƒå°”æ©ç </span>
</span></span><span class=line><span class=cl><span class=n>M_fg</span> <span class=o>=</span> <span class=n>E_pca1_norm</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mf>0.6</span>  <span class=c1># å‰æ™¯æ©ç </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯¹å‰æ™¯åµŒå…¥è®¡ç®— PCAï¼Œå¹¶æŠ•å½±åˆ°å‰ä¸‰ä¸ªä¸»æˆåˆ†ä¸Š</span>
</span></span><span class=line><span class=cl><span class=n>_</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>V_fg</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>pca_lowrank</span><span class=p>(</span><span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg</span> <span class=o>=</span> <span class=n>E</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>@</span> <span class=n>V_fg</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>E_pca3_fg_norm</span> <span class=o>=</span> <span class=n>minmax_norm</span><span class=p>(</span><span class=n>E_pca3_fg</span><span class=p>)</span>  <span class=c1># å½¢çŠ¶ä¸º (N_fg, 3)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºç”¨äºç»˜åˆ¶çš„é›¶å¼ é‡ï¼Œå¹¶å¡«å……å‰æ™¯ä½ç½®</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>N</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span><span class=p>[</span><span class=n>M_fg</span><span class=p>]</span> <span class=o>=</span> <span class=n>E_pca3_fg_norm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¡ç®— patch çš„é«˜åº¦å’Œå®½åº¦</span>
</span></span><span class=line><span class=cl><span class=n>H_p</span> <span class=o>=</span> <span class=n>H</span> <span class=o>//</span> <span class=n>PATCH_SIZE</span>
</span></span><span class=line><span class=cl><span class=n>W_p</span> <span class=o>=</span> <span class=n>W</span> <span class=o>//</span> <span class=n>PATCH_SIZE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é‡å¡‘ä¸º (B, H_p, W_p, 3)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;(B H_p W_p) C -&gt; B H_p W_p C&#34;</span><span class=p>,</span> <span class=n>B</span><span class=o>=</span><span class=n>B</span><span class=p>,</span> <span class=n>H_p</span><span class=o>=</span><span class=n>H_p</span><span class=p>,</span> <span class=n>W_p</span><span class=o>=</span><span class=n>W_p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è½¬æ¢ä¸ºé€šé“ä¼˜å…ˆæ ¼å¼å¹¶è°ƒæ•´å¤§å°ä»¥åŒ¹é…åŸå§‹å›¾åƒå°ºå¯¸</span>
</span></span><span class=line><span class=cl><span class=n>I_draw</span> <span class=o>=</span> <span class=n>rearrange</span><span class=p>(</span><span class=n>I_draw</span><span class=p>,</span> <span class=s2>&#34;B H_p W_p C -&gt; B C H_p W_p&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>I_draw_resized</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>B</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>I_draw_resized</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>resize</span><span class=p>(</span><span class=n>I_draw</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=p>(</span><span class=n>H</span><span class=p>,</span> <span class=n>W</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¿å­˜ç”Ÿæˆçš„å›¾åƒ</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>path</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>image_paths</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>input_filename</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>    <span class=n>output_path</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Path</span><span class=p>(</span><span class=n>output_folder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>Path</span><span class=p>(</span><span class=n>input_filename</span><span class=p>)</span><span class=o>.</span><span class=n>stem</span><span class=si>}</span><span class=s2>_pca</span><span class=si>{</span><span class=n>Path</span><span class=p>(</span><span class=n>input_filename</span><span class=p>)</span><span class=o>.</span><span class=n>suffix</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>save_image</span><span class=p>(</span><span class=n>I_draw_resized</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>cpu</span><span class=p>(),</span> <span class=nb>str</span><span class=p>(</span><span class=n>output_path</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div></details></p><figure class="multi-figure align-center"><div class=multi-figure-container><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1.jpg alt="Image 1"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_1_pca.jpg alt="Image 1 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2.jpg alt="Image 2"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_2_pca.jpg alt="Image 2 PCA"></figure></div><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3.jpg alt="Image 3"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_3_pca.jpg alt="Image 3 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4.jpg alt="Image 4"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_4_pca.jpg alt="Image 4 PCA"></figure></div><div class=multi-figure-row data-images=4><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5.jpg alt="Image 5"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_5_pca.jpg alt="Image 5 PCA"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6.jpg alt="Image 6"></figure><figure class=multi-figure-item><img loading=lazy decoding=async src=images/image_6_pca.jpg alt="Image 6 PCA"></figure></div></div><figcaption><p>å…­å¼ è¾“å…¥å›¾åƒåŠå…¶ PCA å¯è§†åŒ–</p></figcaption></figure></div><footer class=post-footer><ul class=post-tags><li><a href=https://ehehe.cn/tags/representation-learning/>Representation Learning</a></li><li><a href=https://ehehe.cn/tags/visualization/>Visualization</a></li><li><a href=https://ehehe.cn/tags/pca/>PCA</a></li><li><a href=https://ehehe.cn/tags/dinov2/>DINOv2</a></li><li><a href=https://ehehe.cn/tags/dinov3/>DINOv3</a></li></ul><nav class=paginav><a class=prev href=https://ehehe.cn/posts/2025/01-flappy-bird-dqn/><span class=title>Â« Prev</span><br><span>å¼ºåŒ–å­¦ä¹ ç© Flappy Bird</span>
</a><a class=next href=https://ehehe.cn/posts/2024/01-nerf/><span class=title>Next Â»</span><br><span>åŸºäº NeRF çš„ä¸‰ç»´åœºæ™¯ç”Ÿæˆ</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ehehe.cn/>Yan Tang</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){function e(){var e,t,n,s=document.getElementsByTagName("code");for(n=0;n<s.length;){if(t=s[n],t.parentNode.tagName!=="PRE"&&t.childElementCount===0&&(e=t.textContent,/^\$[^$]/.test(e)&&/[^$]\$$/.test(e)&&(e=e.replace(/^\$/,"\\(").replace(/\$$/,"\\)"),t.textContent=e),/^\\\((.|\s)+\\\)$/.test(e)||/^\\\[(.|\s)+\\\]$/.test(e)||/^\$(.|\s)+\$$/.test(e)||/^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(e))){t.outerHTML=t.innerHTML;continue}n++}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>(function(){var n=window.pageYOffset||document.documentElement.scrollTop||0,s=800,t=!1,e=null;function o(){if(t=!1,e||(e=document.getElementById("top-link")),!e)return;var o=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,i=o>n;n=o<0?0:o,o>s&&!i?(e.style.visibility="visible",e.style.opacity="1"):(e.style.visibility="hidden",e.style.opacity="0")}window.addEventListener("scroll",function(){t||(window.requestAnimationFrame(o),t=!0)},{passive:!0})})()</script><script>(function(){var t=10;function n(e){if(!e)return[0,20];var n,s,o=window.getComputedStyle(e),t=parseFloat(o.lineHeight);return(!t||isNaN(t))&&(t=20),n=e.getBoundingClientRect(),s=n.height||e.offsetHeight||0,[Math.round(s/t),t]}function e(){var e=document.querySelectorAll(".highlight");if(!e||!e.length)return;Array.prototype.forEach.call(e,function(e){if(e.classList.contains("expanded")||e.classList.contains("collapsible"))return;var s,o,a,r,c,l,i=e.querySelector("pre code");if(!i)return;if(r=i.className||"",r.indexOf("language-mermaid")>=0||e.classList.contains("mermaid"))return;if(a=n(i),c=a[0],l=a[1],c<=t)return;e.classList.add("collapsible"),e.style.setProperty("--code-line-height",l+"px"),e.id||(e.id="code-block-"+Math.random().toString(36).slice(2)),o=document.createElement("div"),o.className="code-expand-wrapper",s=document.createElement("button"),s.type="button",s.className="code-expand-link",s.textContent="Show more",s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",e.id),s.addEventListener("click",function(){var n,i,a,o=e.classList.contains("expanded"),r=getComputedStyle(e).getPropertyValue("--code-line-height"),t=parseFloat(r)*(parseFloat(getComputedStyle(e).getPropertyValue("--code-max-lines"))||10);(!isFinite(t)||t<=0)&&(t=10*20),i=e.getBoundingClientRect().height,a=o?t:e.scrollHeight,e.style.maxHeight=i+"px",e.offsetHeight,o?e.classList.remove("expanded"):e.classList.add("expanded"),e.style.maxHeight=a+"px",n=function(t){if(t.propertyName!=="max-height")return;if(e.removeEventListener("transitionend",n),e.style.maxHeight="",e.classList.contains("expanded"))s.textContent="Show less",s.setAttribute("aria-expanded","true");else{s.textContent="Show more",s.setAttribute("aria-expanded","false");try{e.scrollIntoView({behavior:"smooth",block:"nearest"})}catch{}}window.dispatchEvent(new Event("resize"))},e.addEventListener("transitionend",n)}),o.appendChild(s),e.nextSibling?e.parentNode.insertBefore(o,e.nextSibling):e.parentNode.appendChild(o)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()})()</script><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>